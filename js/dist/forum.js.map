{"version":3,"file":"forum.js","mappings":"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","sources":["webpack://@syntaxoutlaw/flarum-ext-threadify/webpack/bootstrap","webpack://@syntaxoutlaw/flarum-ext-threadify/webpack/runtime/compat get default export","webpack://@syntaxoutlaw/flarum-ext-threadify/webpack/runtime/define property getters","webpack://@syntaxoutlaw/flarum-ext-threadify/webpack/runtime/hasOwnProperty shorthand","webpack://@syntaxoutlaw/flarum-ext-threadify/external root \"flarum.core.compat['forum/app']\"","webpack://@syntaxoutlaw/flarum-ext-threadify/external root \"flarum.core.compat['common/extend']\"","webpack://@syntaxoutlaw/flarum-ext-threadify/external root \"flarum.core.compat['forum/components/DiscussionPage']\"","webpack://@syntaxoutlaw/flarum-ext-threadify/external root \"flarum.core.compat['forum/components/DiscussionListItem']\"","webpack://@syntaxoutlaw/flarum-ext-threadify/external root \"flarum.core.compat['forum/components/Post']\"","webpack://@syntaxoutlaw/flarum-ext-threadify/./src/forum/utils/ThreadsApi.js","webpack://@syntaxoutlaw/flarum-ext-threadify/external root \"flarum.core.compat['forum/components/ReplyComposer']\"","webpack://@syntaxoutlaw/flarum-ext-threadify/external root \"flarum.core.compat['forum/states/PostStreamState']\"","webpack://@syntaxoutlaw/flarum-ext-threadify/external root \"flarum.core.compat['forum/components/PostStream']\"","webpack://@syntaxoutlaw/flarum-ext-threadify/./src/forum/utils/ThreadOrderPrefetch.js","webpack://@syntaxoutlaw/flarum-ext-threadify/./src/forum/components/ThreadedPostStream.js","webpack://@syntaxoutlaw/flarum-ext-threadify/./src/forum/index.js","webpack://@syntaxoutlaw/flarum-ext-threadify/./src/forum/components/ThreadedPost.js","webpack://@syntaxoutlaw/flarum-ext-threadify/./src/forum/utils/SimplifiedThreadDepth.js","webpack://@syntaxoutlaw/flarum-ext-threadify/./src/forum/components/ThreadedReplyComposer.js"],"sourcesContent":["// The require scope\nvar __webpack_require__ = {};\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/app'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/extend'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/DiscussionPage'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/DiscussionListItem'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/Post'];","/**\n * Threads API Utilities\n * \n * Simple API interface for loading threaded post data from the new\n * threadify_threads table. This replaces the complex dynamic threading\n * logic with efficient pre-computed thread structures.\n * \n * @author Threadify Extension\n */\n\n/**\n * Load all threads for a discussion\n * \n * Makes a single API call to get complete thread structure with all\n * posts in proper threaded order. No complex post loading or tree\n * building needed on the frontend.\n * \n * @param {number} discussionId - The discussion ID to load threads for\n * @returns {Promise<Object[]>} - Promise resolving to array of thread objects\n */\nexport function loadDiscussionThreads(discussionId) {\n  console.log(`[Threadify] Loading threads for discussion ${discussionId}`);\n  \n  // Use Flarum's request method to call our custom API endpoint\n  return app.request({\n    method: 'GET',\n    url: app.forum.attribute('apiUrl') + '/discussions/' + discussionId + '/threads'\n  }).then(response => {\n    console.log(`[Threadify] Loaded ${response.data.length} thread entries`);\n    \n    // Process included data first to populate the store\n    if (response.included) {\n      console.log(`[Threadify] Processing ${response.included.length} included items`);\n      response.included.forEach(item => {\n        console.log(`[Threadify] Including ${item.type}:${item.id}`);\n        app.store.pushObject(item);\n      });\n    }\n    \n    // Convert thread data to posts with threading metadata\n    const threadedPosts = response.data.map(threadData => {\n      // Find the post in Flarum's store\n      const postId = threadData.attributes.postId;\n      let post = app.store.getById('posts', postId);\n      \n      if (post) {\n        // Debug: Check if post has user relationship\n        console.log(`[Threadify] Post ${postId} found, user:`, post.user ? post.user() : 'NO USER');\n        \n        // Add threading metadata to the post\n        post._threadDepth = threadData.attributes.depth;\n        post._threadPath = threadData.attributes.threadPath;\n        post._isRoot = threadData.attributes.isRoot;\n        post._childCount = threadData.attributes.childCount;\n        post._descendantCount = threadData.attributes.descendantCount;\n        post._rootPostId = threadData.attributes.rootPostId;\n        post._parentPostId = threadData.attributes.parentPostId;\n        \n        console.log(`[Threadify] Post ${postId} depth: ${post._threadDepth}, path: ${post._threadPath}`);\n      } else {\n        console.warn(`[Threadify] Post ${postId} not found in store`);\n      }\n      \n      return post;\n    }).filter(post => post !== null); // Filter out any null posts\n    \n    console.log(`[Threadify] Processed ${threadedPosts.length} threaded posts`);\n    \n    return threadedPosts;\n  }).catch(error => {\n    console.error('[Threadify] Failed to load discussion threads:', error);\n    \n    // Fallback: return empty array - existing PostStream will handle this gracefully\n    return [];\n  });\n}\n\n/**\n * Check if threads API is available for a discussion\n * \n * @param {Discussion} discussion - The discussion to check\n * @returns {boolean} - True if threads API should be used\n */\nexport function shouldUseThreadsApi(discussion) {\n  // For now, always try to use the threads API\n  // In the future, this could be configurable or based on discussion settings\n  return true;\n}\n\n/**\n * Get thread metadata for a post\n * \n * Extracts threading information that was added by loadDiscussionThreads\n * \n * @param {Post} post - The post to get metadata for\n * @returns {Object|null} - Thread metadata or null if not available\n */\nexport function getPostThreadMetadata(post) {\n  if (!post || typeof post._threadDepth === 'undefined') {\n    return null;\n  }\n  \n  return {\n    depth: post._threadDepth,\n    threadPath: post._threadPath,\n    isRoot: post._isRoot,\n    childCount: post._childCount,\n    descendantCount: post._descendantCount,\n    rootPostId: post._rootPostId\n  };\n}\n\n/**\n * Check if a post has threading metadata\n * \n * @param {Post} post - The post to check\n * @returns {boolean} - True if post has threading metadata\n */\nexport function hasThreadMetadata(post) {\n  return post && typeof post._threadDepth !== 'undefined';\n} ","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/ReplyComposer'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/states/PostStreamState'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/PostStream'];","// js/src/forum/utils/ThreadOrderPrefetch.js\n/**\n * 轻量顺序预取：/discussions/:id/threads-order\n * 提供：\n *  - prefetchThreadOrder(did) -> Promise<void>\n *  - getOrderIndex(did, postId) -> number|undefined\n *  - getDepthPrefetched(did, postId) / getParentPrefetched(did, postId)\n *  - isPrefetched(did) -> boolean\n *\n * 行为：\n *  - 预取成功后：window.dispatchEvent(new CustomEvent('threadify:orderReady', { detail:Number(did) }))\n *  - 失败也标记 ready，避免重复打接口（此时排序自然回退到本地线程顺序）\n */\n\nimport app from 'flarum/forum/app';\n\nconst _cache = new Map(); // did -> { map: Map<postId, {order, depth, parentId}>, ready: Promise }\n\nexport function prefetchThreadOrder(discussionId) {\n  const did = String(discussionId);\n  if (_cache.has(did) && _cache.get(did).ready) return _cache.get(did).ready;\n\n  const entry = { map: new Map(), ready: null };\n  _cache.set(did, entry);\n\n  entry.ready = app.request({\n    method: 'GET',\n    url: `${app.forum.attribute('apiUrl')}/discussions/${did}/threads-order`,\n  }).then((res) => {\n    const map = new Map();\n    (res.order || []).forEach(({ postId, order, depth, parentPostId }) => {\n      map.set(Number(postId), { order: Number(order), depth: Number(depth), parentId: parentPostId ? Number(parentPostId) : null });\n    });\n    entry.map = map;\n    m.redraw(); // 预取完成后让可见列表按顺序重绘（通常很快）\n  }).catch((e) => {\n    console.warn('[Threadify] order prefetch failed', e);\n  });\n\n  return entry.ready;\n}\n\nexport function getOrderIndex(discussionId, postId) {\n  const entry = _cache.get(String(discussionId));\n  if (!entry || !entry.map) return undefined;\n  const rec = entry.map.get(Number(postId));\n  return rec ? rec.order : undefined;\n}\n\nexport function getDepthPrefetched(discussionId, postId) {\n  const entry = _cache.get(String(discussionId));\n  if (!entry || !entry.map) return undefined;\n  const rec = entry.map.get(Number(postId));\n  return rec ? rec.depth : undefined;\n}\n\nexport function getParentPrefetched(discussionId, postId) {\n  const entry = _cache.get(String(discussionId));\n  if (!entry || !entry.map) return undefined;\n  const rec = entry.map.get(Number(postId));\n  return rec ? rec.parentId : undefined;\n}\n","// js/src/forum/components/ThreadedPostStream.js\nimport app from 'flarum/forum/app';\nimport { extend, override } from 'flarum/common/extend';\nimport PostStreamState from 'flarum/forum/states/PostStreamState';\nimport PostStream from 'flarum/forum/components/PostStream';\n\nimport { prefetchThreadOrder, getOrderIndex } from '../utils/ThreadOrderPrefetch';\n\n/**\n * 仅做“可见列表”层面的稳定排序：\n * - 不覆盖 this.stream.posts（保留楼层号/分页锚点的不变量）\n * - 不在分页进行中排序，避免 anchorScroll 取不到锚点\n * - 返回新数组，不原地 sort\n */\n\nlet pagingDepth = 0; // >0 表示正在分页装载（上一页/下一页）\n\nexport function initThreadedPostStream() {\n  // 讨论切换时，尝试预取顺序（极轻量）\n  extend(PostStream.prototype, 'oninit', function () {\n    const did = this.stream && this.stream.discussion && this.stream.discussion.id();\n    if (did) prefetchThreadOrder(did);\n  });\n\n  // 包一层：分页开始/结束时标记状态\n  override(PostStreamState.prototype, '_loadPrevious', function (original, ...args) {\n    pagingDepth++;\n    const p = original(...args);\n    return Promise.resolve(p).finally(() => {\n      pagingDepth = Math.max(0, pagingDepth - 1);\n    });\n  });\n\n  override(PostStreamState.prototype, '_loadNext', function (original, ...args) {\n    pagingDepth++;\n    const p = original(...args);\n    return Promise.resolve(p).finally(() => {\n      pagingDepth = Math.max(0, pagingDepth - 1);\n    });\n  });\n\n  // 只对“可见列表”排序；分页时直接返回原结果\n  extend(PostStreamState.prototype, 'visiblePosts', function (result) {\n    if (!Array.isArray(result) || result.length <= 1) return result;\n    if (pagingDepth > 0) return result; // 正在分页，避免打断锚点\n\n    const did = this.discussion && this.discussion.id && this.discussion.id();\n\n    // 复制一份，保持纯函数\n    const out = result.slice();\n\n    // 使用预取顺序排序；没有顺序信息时保持原相对顺序\n    out.sort((a, b) => {\n      const aid = a && a.id ? a.id() : null;\n      const bid = b && b.id ? b.id() : null;\n      if (!aid || !bid) return 0;\n\n      const ao = getOrderIndex(did, aid);\n      const bo = getOrderIndex(did, bid);\n\n      if (ao == null && bo == null) return 0; // 两个都没有记录：不动\n      if (ao == null) return 1;               // 有记录的优先\n      if (bo == null) return -1;\n\n      // 都有记录：按 threads-order 升序\n      return ao - bo;\n    });\n\n    return out;\n  });\n}\n","import app from 'flarum/forum/app';\nimport { extend } from 'flarum/common/extend';\n\nimport DiscussionPage from 'flarum/forum/components/DiscussionPage';\nimport DiscussionListItem from 'flarum/forum/components/DiscussionListItem';\n\nimport { initThreadedPost } from './components/ThreadedPost';\nimport { initThreadedReplyComposer } from './components/ThreadedReplyComposer';\nimport { initThreadedPostStream } from './components/ThreadedPostStream';\nimport { prefetchThreadOrder } from './utils/ThreadOrderPrefetch';\n\napp.initializers.add('syntaxoutlaw-threadify', () => {\n  initThreadedPost();\n  initThreadedReplyComposer();\n  initThreadedPostStream();\n\n  // 进入讨论页即预取\n  extend(DiscussionPage.prototype, 'oninit', function () {\n    const did = this.discussion && this.discussion.id && this.discussion.id();\n    if (did) prefetchThreadOrder(did);\n  });\n\n  // 讨论列表项：首次鼠标悬停 / 触摸即预取，提升命中率\n  extend(DiscussionListItem.prototype, 'oncreate', function () {\n    const discussion = this.attrs.discussion;\n    if (!discussion) return;\n    const did = discussion.id();\n    const handler = () => prefetchThreadOrder(did);\n    // 只触发一次即可\n    this.element && this.element.addEventListener('mouseenter', handler, { once: true });\n    this.element && this.element.addEventListener('touchstart', handler, { once: true, passive: true });\n  });\n});\n","/**\n * Threaded Post Component Extensions\n * \n * Handles Post component extensions for threading functionality.\n * This module is responsible for:\n * - Adding threading CSS classes to posts based on their depth\n * - Managing post-specific threading visual elements\n * - Integrating with the ThreadDepth utility for depth calculations\n * \n * @author Threadify Extension\n */\n\nimport { extend } from 'flarum/common/extend';\nimport Post from 'flarum/forum/components/Post';\nimport { getThreadCssClasses } from '../utils/SimplifiedThreadDepth';\n\n/**\n * Initialize Post component extensions for threading\n * \n * Sets up all the necessary hooks and extensions for the Post component\n * to display threading information properly.\n */\nexport function initThreadedPost() {\n  // Hook into Post component to add threading CSS classes\n  extend(Post.prototype, 'classes', function(classes) {\n    const post = this.attrs.post;\n    \n    // Skip processing if we don't have a valid post\n    if (!post) {\n      console.warn('[Threadify] No post in ThreadedPost.classes');\n      return classes;\n    }\n    \n    // Get threading CSS classes from simplified utility\n    const threadClasses = getThreadCssClasses(post);\n    console.log(`[Threadify] Adding classes to post ${post.id()}: ${threadClasses.join(', ')}`);\n    \n    threadClasses.forEach(className => {\n      classes.push(className);\n    });\n    \n    return classes;\n  });\n}\n\n/**\n * Get thread metadata for a post\n * \n * Extracts useful threading metadata from a post that can be used\n * by other components or for debugging purposes.\n * \n * @param {Post} post - The post to extract metadata from\n * @param {Post[]} allPosts - All posts in the discussion\n * @returns {Object} - Thread metadata object\n */\nexport function getPostThreadMetadata(post, allPosts) {\n  if (!post) return null;\n  \n  const parentId = post.attribute('parent_id');\n  const parentPost = parentId ? allPosts.find(p => p && p.id() == parentId) : null;\n  \n  // Find direct children of this post\n  const children = allPosts.filter(p => \n    p && p.attribute('parent_id') == post.id()\n  );\n  \n  // Calculate some thread statistics\n  const descendants = getDescendantCount(post, allPosts);\n  \n  return {\n    postId: post.id(),\n    parentId: parentId,\n    hasParent: !!parentPost,\n    parentPost: parentPost,\n    directChildren: children,\n    childrenCount: children.length,\n    descendantCount: descendants,\n    isRootPost: !parentId,\n    threadClasses: getThreadCssClasses(post, allPosts)\n  };\n}\n\n/**\n * Count all descendants (children, grandchildren, etc.) of a post\n * \n * @param {Post} post - The post to count descendants for\n * @param {Post[]} allPosts - All posts in the discussion\n * @returns {number} - Total number of descendants\n */\nfunction getDescendantCount(post, allPosts) {\n  const directChildren = allPosts.filter(p => \n    p && p.attribute('parent_id') == post.id()\n  );\n  \n  let count = directChildren.length;\n  \n  // Recursively count descendants of each child\n  directChildren.forEach(child => {\n    count += getDescendantCount(child, allPosts);\n  });\n  \n  return count;\n}\n\n/**\n * Check if a post is part of a specific thread branch\n * \n * Determines if a post is either a descendant or ancestor of another post.\n * Useful for highlighting related posts or collapsing thread branches.\n * \n * @param {Post} post1 - First post\n * @param {Post} post2 - Second post  \n * @param {Post[]} allPosts - All posts in the discussion\n * @returns {boolean} - True if posts are in the same thread branch\n */\nexport function arePostsInSameBranch(post1, post2, allPosts) {\n  if (!post1 || !post2 || post1.id() === post2.id()) {\n    return false;\n  }\n  \n  // Check if post1 is an ancestor of post2\n  let currentPost = post2;\n  while (currentPost) {\n    const parentId = currentPost.attribute('parent_id');\n    if (!parentId) break;\n    \n    if (parentId == post1.id()) {\n      return true; // post1 is an ancestor of post2\n    }\n    \n    currentPost = allPosts.find(p => p && p.id() == parentId);\n  }\n  \n  // Check if post2 is an ancestor of post1\n  currentPost = post1;\n  while (currentPost) {\n    const parentId = currentPost.attribute('parent_id');\n    if (!parentId) break;\n    \n    if (parentId == post2.id()) {\n      return true; // post2 is an ancestor of post1\n    }\n    \n    currentPost = allPosts.find(p => p && p.id() == parentId);\n  }\n  \n  return false;\n}\n\n/**\n * Get the root post of a thread branch\n * \n * Traces back through parent relationships to find the root post\n * of the thread branch that contains the given post.\n * \n * @param {Post} post - The post to find the root for\n * @param {Post[]} allPosts - All posts in the discussion\n * @returns {Post|null} - The root post of the thread branch\n */\nexport function getThreadRoot(post, allPosts) {\n  if (!post) return null;\n  \n  let currentPost = post;\n  let rootPost = post;\n  \n  // Trace back through parents until we find a post with no parent\n  while (currentPost) {\n    const parentId = currentPost.attribute('parent_id');\n    if (!parentId) {\n      rootPost = currentPost;\n      break;\n    }\n    \n    const parentPost = allPosts.find(p => p && p.id() == parentId);\n    if (!parentPost) {\n      // Parent not found, current post becomes the effective root\n      rootPost = currentPost;\n      break;\n    }\n    \n    rootPost = parentPost;\n    currentPost = parentPost;\n  }\n  \n  return rootPost;\n} \n","/**\n * Simplified Thread Depth Utilities\n * \n * This replaces the complex ThreadDepth calculation logic with simple\n * utilities that use pre-computed thread depths from the threads API.\n * \n * Benefits:\n * - No expensive depth calculations on frontend\n * - No caching needed - depth is already computed\n * - More reliable since depth is calculated once on backend\n * - Simpler code with fewer edge cases\n * \n * @author Threadify Extension\n */\n\nimport { getPostThreadMetadata } from './ThreadsApi';\n\n// Maximum allowed thread depth for UI display\nconst MAX_DISPLAY_DEPTH = 10;\n\n/**\n * Get thread depth for a post\n * \n * Uses pre-computed depth from threads API metadata instead of calculating.\n * \n * @param {Post} post - The post to get depth for\n * @returns {number} - The thread depth (0 = root, 1 = reply, etc.)\n */\nexport function getThreadDepth(post) {\n  if (!post) {\n    return 0;\n  }\n  \n  // Check if post has threading metadata from threads API\n  const metadata = getPostThreadMetadata(post);\n  if (metadata) {\n    return Math.min(metadata.depth, MAX_DISPLAY_DEPTH);\n  }\n  \n  // Fallback: use old parent_id attribute if available\n  const parentId = post.attribute('parent_id');\n  if (parentId) {\n    // Simple fallback - assume depth 1 for any post with parent\n    // This is not as accurate but prevents complete failure\n    return 1;\n  }\n  \n  // No threading information available, treat as root\n  return 0;\n}\n\n/**\n * Get CSS classes for a post based on its thread depth\n * \n * @param {Post} post - The post to get CSS classes for\n * @returns {string[]} - Array of CSS class names\n */\nexport function getThreadCssClasses(post) {\n  const depth = getThreadDepth(post);\n  const classes = [];\n  \n  if (depth > 0) {\n    classes.push('threaded-post');\n    classes.push(`thread-depth-${depth}`);\n    \n    // Add general depth classes for easier styling\n    if (depth >= 3) {\n      classes.push('thread-deep');\n    }\n    if (depth >= 5) {\n      classes.push('thread-very-deep');\n    }\n  } else {\n    classes.push('thread-root');\n  }\n  \n  // Add metadata-based classes if available\n  const metadata = getPostThreadMetadata(post);\n  if (metadata) {\n    if (metadata.isRoot) {\n      classes.push('thread-root-confirmed');\n    }\n    if (metadata.childCount > 0) {\n      classes.push('has-children');\n      classes.push(`child-count-${Math.min(metadata.childCount, 10)}`);\n    }\n    if (metadata.descendantCount > 0) {\n      classes.push('has-descendants');\n    }\n  }\n  \n  return classes;\n}\n\n/**\n * Check if a post is a root post (no parent)\n * \n * @param {Post} post - The post to check\n * @returns {boolean} - True if post is a root post\n */\nexport function isRootPost(post) {\n  const metadata = getPostThreadMetadata(post);\n  if (metadata) {\n    return metadata.isRoot;\n  }\n  \n  // Fallback: check if post has no parent_id\n  return !post.attribute('parent_id');\n}\n\n/**\n * Get thread root ID for a post\n * \n * @param {Post} post - The post to get root for\n * @returns {string|null} - Root post ID or null if not available\n */\nexport function getThreadRootId(post) {\n  const metadata = getPostThreadMetadata(post);\n  if (metadata) {\n    return metadata.rootPostId;\n  }\n  \n  // Fallback: if no metadata, assume the post itself is root if no parent\n  if (!post.attribute('parent_id')) {\n    return post.id();\n  }\n  \n  return null;\n}\n\n/**\n * Get child count for a post\n * \n * @param {Post} post - The post to get child count for\n * @returns {number} - Number of direct children\n */\nexport function getChildCount(post) {\n  const metadata = getPostThreadMetadata(post);\n  return metadata ? metadata.childCount : 0;\n}\n\n/**\n * Get descendant count for a post\n * \n * @param {Post} post - The post to get descendant count for\n * @returns {number} - Total number of descendants (children + grandchildren + ...)\n */\nexport function getDescendantCount(post) {\n  const metadata = getPostThreadMetadata(post);\n  return metadata ? metadata.descendantCount : 0;\n}\n\n/**\n * Get thread path for a post\n * \n * @param {Post} post - The post to get thread path for\n * @returns {string|null} - Thread path (e.g., \"1/5/12\") or null if not available\n */\nexport function getThreadPath(post) {\n  const metadata = getPostThreadMetadata(post);\n  return metadata ? metadata.threadPath : null;\n} ","/**\n * Threaded Reply Composer Extensions\n * \n * Handles ReplyComposer component extensions for threading functionality.\n * This module is responsible for:\n * - Extracting parent_id from post mentions in reply content\n * - Adding parent_id to the reply data before submission\n * - Integrating with Flarum's mentions extension for seamless threading\n * \n * The threading system works by detecting post mentions in the format:\n * @\"Display Name\"#p123 where 123 is the post ID that becomes the parent_id\n * \n * @author Threadify Extension\n */\n\nimport { extend } from 'flarum/common/extend';\nimport ReplyComposer from 'flarum/forum/components/ReplyComposer';\n\n/**\n * Initialize ReplyComposer component extensions for threading\n * \n * Sets up hooks to automatically detect and add parent_id relationships\n * when users reply to specific posts using the mentions system.\n */\nexport function initThreadedReplyComposer() {\n  // Hook into reply submission to add parent_id\n  extend(ReplyComposer.prototype, 'data', function(data) {\n    const parentId = extractParentIdFromContent(data.content);\n    \n    if (parentId) {\n      // Add parent_id directly to the data object\n      data.parent_id = parentId;\n      console.log('[Threadify] Reply threading to post', parentId);\n    }\n    \n    return data;\n  });\n}\n\n/**\n * Extract parent post ID from reply content\n * \n * Parses the reply content for post mentions from the mentions extension\n * and extracts the post ID to use as parent_id for threading.\n * \n * Supported mention formats:\n * - @\"Display Name\"#p123 (standard post mention)\n * - Multiple mentions (uses the first one found)\n * \n * @param {string} content - The reply content to parse\n * @returns {number|null} - The parent post ID or null if none found\n */\nexport function extractParentIdFromContent(content) {\n  if (!content || typeof content !== 'string') {\n    return null;\n  }\n  \n  // Parse the content for post mentions from the mentions extension\n  // Format: @\"Display Name\"#p123 where 123 is the post ID\n  const postMentionMatch = content.match(/@\"[^\"]*\"#p(\\d+)/);\n  \n  if (postMentionMatch && postMentionMatch[1]) {\n    const parentId = parseInt(postMentionMatch[1], 10);\n    \n    // Validate that it's a valid number\n    if (!isNaN(parentId) && parentId > 0) {\n      return parentId;\n    }\n  }\n  \n  return null;\n}\n\n/**\n * Extract all mentioned post IDs from content\n * \n * Gets all post mentions from the content, not just the first one.\n * Useful for analytics or advanced threading features.\n * \n * @param {string} content - The reply content to parse\n * @returns {number[]} - Array of mentioned post IDs\n */\nexport function extractAllMentionedPostIds(content) {\n  if (!content || typeof content !== 'string') {\n    return [];\n  }\n  \n  const postMentionRegex = /@\"[^\"]*\"#p(\\d+)/g;\n  const matches = [];\n  let match;\n  \n  while ((match = postMentionRegex.exec(content)) !== null) {\n    const postId = parseInt(match[1], 10);\n    if (!isNaN(postId) && postId > 0) {\n      matches.push(postId);\n    }\n  }\n  \n  return matches;\n}\n\n/**\n * Check if content contains post mentions\n * \n * @param {string} content - The content to check\n * @returns {boolean} - True if content contains post mentions\n */\nexport function hasPostMentions(content) {\n  return extractParentIdFromContent(content) !== null;\n}\n\n/**\n * Get threading context from reply content\n * \n * Extracts comprehensive threading information from reply content,\n * including the primary parent and any additional mentioned posts.\n * \n * @param {string} content - The reply content to analyze\n * @returns {Object} - Threading context object\n */\nexport function getThreadingContext(content) {\n  const primaryParentId = extractParentIdFromContent(content);\n  const allMentionedIds = extractAllMentionedPostIds(content);\n  \n  return {\n    primaryParentId: primaryParentId,\n    allMentionedPostIds: allMentionedIds,\n    hasMentions: allMentionedIds.length > 0,\n    mentionCount: allMentionedIds.length,\n    isThreadedReply: primaryParentId !== null\n  };\n}\n\n/**\n * Validate threading data before submission\n * \n * Performs validation on the threading data to ensure it's valid\n * before the reply is submitted to the server.\n * \n * @param {Object} data - The reply data object\n * @returns {Object} - Validation result with isValid boolean and any error messages\n */\nexport function validateThreadingData(data) {\n  const result = {\n    isValid: true,\n    errors: [],\n    warnings: []\n  };\n  \n  // Check if parent_id is present and valid\n  if (data.parent_id !== undefined) {\n    if (typeof data.parent_id !== 'number' || data.parent_id <= 0) {\n      result.isValid = false;\n      result.errors.push('Invalid parent_id: must be a positive number');\n    }\n  }\n  \n  // Check for potential threading issues\n  if (data.content && hasPostMentions(data.content)) {\n    const context = getThreadingContext(data.content);\n    \n    if (!data.parent_id && context.isThreadedReply) {\n      result.warnings.push('Content contains post mentions but no parent_id was set');\n    }\n    \n    if (context.mentionCount > 1) {\n      result.warnings.push(`Multiple post mentions found (${context.mentionCount}), only first will be used for threading`);\n    }\n  }\n  \n  return result;\n}\n\n/**\n * Clean threading data for submission\n * \n * Ensures threading data is properly formatted and cleaned before\n * being sent to the server.\n * \n * @param {Object} data - The reply data object\n * @returns {Object} - Cleaned data object\n */\nexport function cleanThreadingData(data) {\n  const cleanedData = { ...data };\n  \n  // Ensure parent_id is a proper integer or remove it\n  if (cleanedData.parent_id !== undefined) {\n    const parentId = parseInt(cleanedData.parent_id, 10);\n    if (!isNaN(parentId) && parentId > 0) {\n      cleanedData.parent_id = parentId;\n    } else {\n      delete cleanedData.parent_id;\n    }\n  }\n  \n  return cleanedData;\n} "],"names":["__webpack_require__","module","getter","__esModule","d","a","exports","definition","key","o","Object","defineProperty","enumerable","get","obj","prop","prototype","hasOwnProperty","call","flarum","core","compat","getPostThreadMetadata","post","_threadDepth","depth","threadPath","_threadPath","isRoot","_isRoot","childCount","_childCount","descendantCount","_descendantCount","rootPostId","_rootPostId","_cache","Map","prefetchThreadOrder","discussionId","did","String","has","ready","entry","map","set","app","method","url","attribute","then","res","order","forEach","_ref","postId","parentPostId","Number","parentId","m","redraw","e","console","warn","getOrderIndex","rec","undefined","pagingDepth","add","extend","Post","classes","this","attrs","threadClasses","metadata","Math","min","getThreadDepth","push","getThreadCssClasses","log","id","join","className","ReplyComposer","data","content","postMentionMatch","match","parseInt","isNaN","extractParentIdFromContent","parent_id","PostStream","stream","discussion","override","PostStreamState","original","_len","arguments","length","args","Array","_key","p","apply","Promise","resolve","max","_len2","_key2","result","isArray","out","slice","sort","b","aid","bid","ao","bo","DiscussionPage","DiscussionListItem","handler","element","addEventListener","once","passive"],"sourceRoot":""}