{"version":3,"file":"forum.js","mappings":"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","sources":["webpack://@syntaxoutlaw/flarum-ext-threadify/webpack/bootstrap","webpack://@syntaxoutlaw/flarum-ext-threadify/webpack/runtime/compat get default export","webpack://@syntaxoutlaw/flarum-ext-threadify/webpack/runtime/define property getters","webpack://@syntaxoutlaw/flarum-ext-threadify/webpack/runtime/hasOwnProperty shorthand","webpack://@syntaxoutlaw/flarum-ext-threadify/external root \"flarum.core.compat['forum/app']\"","webpack://@syntaxoutlaw/flarum-ext-threadify/external root \"flarum.core.compat['common/extend']\"","webpack://@syntaxoutlaw/flarum-ext-threadify/external root \"flarum.core.compat['forum/components/DiscussionPage']\"","webpack://@syntaxoutlaw/flarum-ext-threadify/external root \"flarum.core.compat['forum/components/DiscussionListItem']\"","webpack://@syntaxoutlaw/flarum-ext-threadify/external root \"flarum.core.compat['forum/components/Post']\"","webpack://@syntaxoutlaw/flarum-ext-threadify/./src/forum/utils/ThreadsApi.js","webpack://@syntaxoutlaw/flarum-ext-threadify/./src/forum/utils/ThreadOrderPrefetch.js","webpack://@syntaxoutlaw/flarum-ext-threadify/./src/forum/utils/SimplifiedThreadDepth.js","webpack://@syntaxoutlaw/flarum-ext-threadify/external root \"flarum.core.compat['forum/components/ReplyComposer']\"","webpack://@syntaxoutlaw/flarum-ext-threadify/external root \"flarum.core.compat['forum/components/PostStream']\"","webpack://@syntaxoutlaw/flarum-ext-threadify/external root \"flarum.core.compat['forum/states/PostStreamState']\"","webpack://@syntaxoutlaw/flarum-ext-threadify/./src/forum/utils/FlexOrderMode.js","webpack://@syntaxoutlaw/flarum-ext-threadify/./src/forum/index.js","webpack://@syntaxoutlaw/flarum-ext-threadify/./src/forum/components/ThreadedPost.js","webpack://@syntaxoutlaw/flarum-ext-threadify/./src/forum/components/ThreadedReplyComposer.js"],"sourcesContent":["// The require scope\nvar __webpack_require__ = {};\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/app'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/extend'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/DiscussionPage'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/DiscussionListItem'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/Post'];","/**\n * Threads API Utilities\n * \n * Simple API interface for loading threaded post data from the new\n * threadify_threads table. This replaces the complex dynamic threading\n * logic with efficient pre-computed thread structures.\n * \n * @author Threadify Extension\n */\n\n/**\n * Load all threads for a discussion\n * \n * Makes a single API call to get complete thread structure with all\n * posts in proper threaded order. No complex post loading or tree\n * building needed on the frontend.\n * \n * @param {number} discussionId - The discussion ID to load threads for\n * @returns {Promise<Object[]>} - Promise resolving to array of thread objects\n */\nexport function loadDiscussionThreads(discussionId) {\n  console.log(`[Threadify] Loading threads for discussion ${discussionId}`);\n  \n  // Use Flarum's request method to call our custom API endpoint\n  return app.request({\n    method: 'GET',\n    url: app.forum.attribute('apiUrl') + '/discussions/' + discussionId + '/threads'\n  }).then(response => {\n    console.log(`[Threadify] Loaded ${response.data.length} thread entries`);\n    \n    // Process included data first to populate the store\n    if (response.included) {\n      console.log(`[Threadify] Processing ${response.included.length} included items`);\n      response.included.forEach(item => {\n        console.log(`[Threadify] Including ${item.type}:${item.id}`);\n        app.store.pushObject(item);\n      });\n    }\n    \n    // Convert thread data to posts with threading metadata\n    const threadedPosts = response.data.map(threadData => {\n      // Find the post in Flarum's store\n      const postId = threadData.attributes.postId;\n      let post = app.store.getById('posts', postId);\n      \n      if (post) {\n        // Debug: Check if post has user relationship\n        console.log(`[Threadify] Post ${postId} found, user:`, post.user ? post.user() : 'NO USER');\n        \n        // Add threading metadata to the post\n        post._threadDepth = threadData.attributes.depth;\n        post._threadPath = threadData.attributes.threadPath;\n        post._isRoot = threadData.attributes.isRoot;\n        post._childCount = threadData.attributes.childCount;\n        post._descendantCount = threadData.attributes.descendantCount;\n        post._rootPostId = threadData.attributes.rootPostId;\n        post._parentPostId = threadData.attributes.parentPostId;\n        \n        console.log(`[Threadify] Post ${postId} depth: ${post._threadDepth}, path: ${post._threadPath}`);\n      } else {\n        console.warn(`[Threadify] Post ${postId} not found in store`);\n      }\n      \n      return post;\n    }).filter(post => post !== null); // Filter out any null posts\n    \n    console.log(`[Threadify] Processed ${threadedPosts.length} threaded posts`);\n    \n    return threadedPosts;\n  }).catch(error => {\n    console.error('[Threadify] Failed to load discussion threads:', error);\n    \n    // Fallback: return empty array - existing PostStream will handle this gracefully\n    return [];\n  });\n}\n\n/**\n * Check if threads API is available for a discussion\n * \n * @param {Discussion} discussion - The discussion to check\n * @returns {boolean} - True if threads API should be used\n */\nexport function shouldUseThreadsApi(discussion) {\n  // For now, always try to use the threads API\n  // In the future, this could be configurable or based on discussion settings\n  return true;\n}\n\n/**\n * Get thread metadata for a post\n * \n * Extracts threading information that was added by loadDiscussionThreads\n * \n * @param {Post} post - The post to get metadata for\n * @returns {Object|null} - Thread metadata or null if not available\n */\nexport function getPostThreadMetadata(post) {\n  if (!post || typeof post._threadDepth === 'undefined') {\n    return null;\n  }\n  \n  return {\n    depth: post._threadDepth,\n    threadPath: post._threadPath,\n    isRoot: post._isRoot,\n    childCount: post._childCount,\n    descendantCount: post._descendantCount,\n    rootPostId: post._rootPostId\n  };\n}\n\n/**\n * Check if a post has threading metadata\n * \n * @param {Post} post - The post to check\n * @returns {boolean} - True if post has threading metadata\n */\nexport function hasThreadMetadata(post) {\n  return post && typeof post._threadDepth !== 'undefined';\n} ","// js/src/forum/utils/ThreadOrderPrefetch.js\n\n/**\n * 轻量顺序预取：/discussions/:id/threads-order\n * 提供：\n *  - prefetchThreadOrder(did) -> Promise<void>\n *  - getOrderIndex(did, postId) -> number|undefined\n *  - getDepthPrefetched(did, postId) -> number|undefined\n *  - getParentPrefetched(did, postId) -> number|undefined\n * 并在预取完成后派发 window 事件：'threadify:order-ready'（detail: { discussionId }）\n */\n\nconst _cache = new Map(); // did -> { map: Map<postId, {order, depth, parentId}>, ready: Promise }\n\nexport function prefetchThreadOrder(discussionId) {\n  const did = String(discussionId);\n  if (_cache.has(did) && _cache.get(did).ready) return _cache.get(did).ready;\n\n  const entry = { map: new Map(), ready: null };\n  _cache.set(did, entry);\n\n  entry.ready = app.request({\n    method: 'GET',\n    url: `${app.forum.attribute('apiUrl')}/discussions/${did}/threads-order`,\n  }).then((res) => {\n    const map = new Map();\n    (res.order || []).forEach(({ postId, order, depth, parentPostId }) => {\n      map.set(Number(postId), {\n        order: Number(order),\n        depth: Number.isFinite(depth) ? Number(depth) : 0,\n        parentId: parentPostId ? Number(parentPostId) : null,\n      });\n    });\n    entry.map = map;\n\n    // 通知各处“顺序可用”\n    try {\n      window.dispatchEvent(new CustomEvent('threadify:order-ready', { detail: { discussionId: Number(did) } }));\n    } catch (e) { /* older browsers */ }\n\n  }).catch((e) => {\n    console.warn('[Threadify] order prefetch failed', e);\n  });\n\n  return entry.ready;\n}\n\nexport function getOrderIndex(discussionId, postId) {\n  const entry = _cache.get(String(discussionId));\n  if (!entry || !entry.map) return undefined;\n  const rec = entry.map.get(Number(postId));\n  return rec ? rec.order : undefined;\n}\n\nexport function getDepthPrefetched(discussionId, postId) {\n  const entry = _cache.get(String(discussionId));\n  if (!entry || !entry.map) return undefined;\n  const rec = entry.map.get(Number(postId));\n  return rec ? rec.depth : undefined;\n}\n\nexport function getParentPrefetched(discussionId, postId) {\n  const entry = _cache.get(String(discussionId));\n  if (!entry || !entry.map) return undefined;\n  const rec = entry.map.get(Number(postId));\n  return rec ? rec.parentId : undefined;\n}\n\n","/**\n * Simplified Thread Depth Utilities (fixed)\n *\n * 优先级：\n *  1) /threads-order 预取的 depth\n *  2) /threads 元数据里的 _threadDepth\n *  3) 本地沿 parent_id 向上爬链计算\n *\n * 始终返回 0..MAX_DISPLAY_DEPTH，且不会抛错。\n */\n\nimport { getPostThreadMetadata } from './ThreadsApi';\nimport { getDepthPrefetched, getParentPrefetched } from './ThreadOrderPrefetch';\n\nconst MAX_DISPLAY_DEPTH = 10;\n\n/** ---- helpers ---- */\nfunction clampDepth(n) {\n  const x = Number(n);\n  return Number.isFinite(x) ? Math.max(0, Math.min(MAX_DISPLAY_DEPTH, x)) : 0;\n}\n\nfunction walkDepthByParentChain(post) {\n  // 沿 parent_id 向上爬；即便父帖未加载也能给出“已知最大深度”\n  let depth = 0;\n  let guard = 0;\n  const seen = new Set();\n\n  let current = post;\n  while (current && guard < 100) {\n    const pid = current.attribute ? current.attribute('parent_id') : null;\n    if (!pid) break;\n\n    // 循环保护\n    if (seen.has(pid)) {\n      console.warn('[Threadify] cycle detected while walking parents of', post && post.id && post.id());\n      depth = 0;\n      break;\n    }\n    seen.add(pid);\n\n    depth += 1;\n    // 试着从 store 取父贴，取不到就以当前深度作准（父贴可能尚未加载）\n    const parent = app.store.getById('posts', String(pid));\n    if (!parent) break;\n\n    current = parent;\n    guard++;\n    if (depth >= MAX_DISPLAY_DEPTH) break;\n  }\n  return clampDepth(depth);\n}\n\n/** ---- public API ---- */\n\n/**\n * Get thread depth for a post (0=root)\n */\nexport function getThreadDepth(post) {\n  if (!post || typeof post.id !== 'function') return 0;\n\n  // 1) 预取顺序里的 depth（最快、最稳定）\n  try {\n    const did =\n      (post.discussion && typeof post.discussion === 'function' && post.discussion() && post.discussion().id && post.discussion().id()) ||\n      null;\n    if (did != null) {\n      const d = getDepthPrefetched(did, post.id());\n      if (Number.isInteger(d)) return clampDepth(d);\n    }\n  } catch (_) {\n    // ignore\n  }\n\n  // 2) /threads 元数据（若前端曾调用过 loadDiscussionThreads）\n  try {\n    const md = getPostThreadMetadata(post);\n    if (md && Number.isInteger(md.depth)) return clampDepth(md.depth);\n  } catch (_) {\n    // ignore\n  }\n\n  // 3) 本地按 parent_id 向上爬链\n  return walkDepthByParentChain(post);\n}\n\n/**\n * CSS classes for a post based on its thread depth.\n * 统一使用：threaded-post / thread-root / thread-depth-N / thread-deep / thread-very-deep\n */\nexport function getThreadCssClasses(post) {\n  const depth = getThreadDepth(post);\n  const classes = [];\n\n  if (depth > 0) {\n    classes.push('threaded-post');\n    classes.push(`thread-depth-${depth}`);\n    if (depth >= 3) classes.push('thread-deep');\n    if (depth >= 5) classes.push('thread-very-deep');\n  } else {\n    classes.push('thread-root');\n  }\n\n  // 尽量从预取或元数据补充“根/父”信息（可选）\n  try {\n    const did =\n      (post.discussion && typeof post.discussion === 'function' && post.discussion() && post.discussion().id && post.discussion().id()) ||\n      null;\n    const prefParent = did != null ? getParentPrefetched(did, post.id()) : undefined;\n    const md = getPostThreadMetadata(post);\n\n    const isRoot =\n      (prefParent === null || prefParent === undefined) ?\n        (!post.attribute || !post.attribute('parent_id')) :\n        (prefParent == null);\n\n    if (isRoot) classes.push('thread-root-confirmed');\n\n    // 可根据 md.childCount / md.descendantCount 再加细化类名（没有就跳过）\n    if (md && Number.isInteger(md.childCount) && md.childCount > 0) {\n      classes.push('has-children', `child-count-${Math.min(md.childCount, 10)}`);\n    }\n    if (md && Number.isInteger(md.descendantCount) && md.descendantCount > 0) {\n      classes.push('has-descendants');\n    }\n  } catch (_) {\n    // 忽略补充信息失败\n  }\n\n  return classes;\n}\n\n/** convenience helpers */\nexport function isRootPost(post) {\n  return getThreadDepth(post) === 0;\n}\n\nexport function getThreadRootId(/* post */) {\n  // 若后续需要，可接入预取 map 里的 rootId；当前仅用于样式则不强制实现\n  return null;\n}\n\nexport function getChildCount(post) {\n  const md = getPostThreadMetadata(post);\n  return md && Number.isInteger(md.childCount) ? md.childCount : 0;\n}\n\nexport function getDescendantCount(post) {\n  const md = getPostThreadMetadata(post);\n  return md && Number.isInteger(md.descendantCount) ? md.descendantCount : 0;\n}\n\nexport function getThreadPath(post) {\n  const md = getPostThreadMetadata(post);\n  return md ? md.threadPath || null : null;\n}\n","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/ReplyComposer'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/PostStream'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/states/PostStreamState'];","// js/src/forum/utils/FlexOrderMode.js\n//\n// “Flex 排序模式”：不改 PostStream 的 posts() 顺序；\n// 仅在 DOM 层对每个 article.Post[data-id] 设置 CSS order，\n// 并据预取的深度为其打上 thread-depth-* 类名。\n// 分页（_loadPrevious/_loadNext）时自动暂停应用，结束后再批量应用。\n// 新回复出现时自动刷新预取并重排。\n// 附带“轻门帘”：预取未就绪时把 Post 容器临时设为透明，避免短暂未排序闪动。\n// -----------------------------------------------------------------------------\n\nimport { extend, override } from 'flarum/common/extend';\nimport PostStream from 'flarum/forum/components/PostStream';\nimport PostStreamState from 'flarum/forum/states/PostStreamState';\nimport { prefetchThreadOrder, getOrderIndex, getDepthPrefetched } from './ThreadOrderPrefetch';\n\nlet suspendApply = false;       // 分页期间暂停应用\nlet pendingApply = false;       // 分页结束后补一次\nlet currentDiscussionId = null; // 追踪当前讨论\nlet scheduled = null;           // RAF 调度句柄\nlet seenIds = new Set();        // 已见帖子 ID（用来侦测“新回复”）\n\n// 轻门帘延时（毫秒）：预取若很快完成，则始终无闪动；超过这个时间也会自动显示\nconst VEIL_MAX_WAIT = 180;\n\nexport function installFlexOrderMode() {\n  // 分页前后切换“暂停标志”\n  override(PostStreamState.prototype, '_loadPrevious', function (original, ...args) {\n    suspendApply = true;\n    const p = original(...args);\n    return Promise.resolve(p).finally(() => {\n      suspendApply = false;\n      if (pendingApply) { pendingApply = false; applySoonFromState(this); }\n    });\n  });\n\n  override(PostStreamState.prototype, '_loadNext', function (original, ...args) {\n    suspendApply = true;\n    const p = original(...args);\n    return Promise.resolve(p).finally(() => {\n      suspendApply = false;\n      if (pendingApply) { pendingApply = false; applySoonFromState(this); }\n    });\n  });\n\n  // PostStream 生命周期：首次创建与后续更新都尝试应用\n  extend(PostStream.prototype, 'oncreate', function () {\n    const did = this.stream && this.stream.discussion && this.stream.discussion.id();\n    if (currentDiscussionId !== did) {\n      currentDiscussionId = did;\n      seenIds.clear();\n    }\n    // 轻门帘：预取很快则看不到；慢了最多 VEIL_MAX_WAIT ms\n    tryVeilUntilOrderReady(this, did);\n    scheduleApply(this);\n  });\n\n  extend(PostStream.prototype, 'onupdate', function () {\n    // 发现“新帖子” → 触发一次预取刷新后再应用\n    const did = this.stream && this.stream.discussion && this.stream.discussion.id();\n    const idsNow = collectIds(this.element);\n    let hasNew = false;\n    idsNow.forEach((id) => {\n      if (!seenIds.has(id)) { hasNew = true; seenIds.add(id); }\n    });\n    if (hasNew && did) {\n      prefetchThreadOrder(did).finally(() => scheduleApply(this));\n    } else {\n      scheduleApply(this);\n    }\n  });\n\n  // 当预取完成时（任意来源触发），如果正处在相同讨论页，则立即应用\n  window.addEventListener('threadify:order-ready', (ev) => {\n    const didReady = ev && ev.detail && ev.detail.discussionId;\n    if (!didReady) return;\n    // 找到页面上第一个 PostStream 容器，尝试应用\n    const ps = findActivePostStream();\n    if (!ps) return;\n    const did = ps.stream && ps.stream.discussion && ps.stream.discussion.id();\n    if (Number(did) === Number(didReady)) scheduleApply(ps);\n  });\n}\n\n// ============ 内部：应用顺序与深度类名（DOM 层） ============\n\nfunction scheduleApply(postStream) {\n  if (suspendApply) { pendingApply = true; return; }\n  if (scheduled) cancelAnimationFrame(scheduled);\n  scheduled = requestAnimationFrame(() => {\n    try {\n      applyFlexOrder(postStream);\n    } catch (e) {\n      console.warn('[Threadify] flex apply failed:', e);\n    }\n  });\n}\n\nfunction applySoonFromState(state) {\n  // state 是 PostStreamState；拿到对应的 PostStream 实例\n  const ps = state.discussion && state.discussion.postStream ? state.discussion.postStream : null;\n  if (ps) scheduleApply(ps);\n}\n\nfunction applyFlexOrder(postStream) {\n  const root = postStream && postStream.element;\n  if (!root) return;\n\n  // 找到 Post 容器和帖子节点\n  const container = queryPostContainer(root);\n  if (!container) return;\n\n  // 将容器变成 flex 列，且不破坏主题布局（只在我们这层加内联样式）\n  ensureFlexContainer(container);\n\n  const did = postStream.stream && postStream.stream.discussion && postStream.stream.discussion.id();\n\n  // 只处理真正的帖子节点（必须有 data-id）\n  const posts = Array.from(container.querySelectorAll('article.Post[data-id]'));\n\n  // 更新 seenIds\n  posts.forEach((n) => { const id = Number(n.dataset.id); if (Number.isFinite(id)) seenIds.add(id); });\n\n  // 批量写入 CSS order 与 thread-depth-* 类\n  posts.forEach((node) => {\n    const id = Number(node.dataset.id);\n    if (!Number.isFinite(id)) return;\n\n    const order = getOrderIndex(did, id);\n    // 未命中顺序就给一个很靠后的 fallback（仍然稳定）\n    const ord = Number.isInteger(order) ? order : 10_000_000 + id;\n    node.style.order = String(ord);\n\n    // 深度类：先清除旧的 thread-depth-*，再按预取写入\n    cleanupDepthClasses(node);\n    const depth = getDepthPrefetched(did, id);\n    if (Number.isFinite(depth) && depth > 0) {\n      node.classList.add('threaded-post', `thread-depth-${Math.min(depth, 10)}`);\n      if (depth >= 3) node.classList.add('thread-deep');\n      if (depth >= 5) node.classList.add('thread-very-deep');\n    } else {\n      node.classList.add('thread-root');\n    }\n  });\n}\n\n// ============ 工具函数 ============\n\nfunction queryPostContainer(rootEl) {\n  // 常见结构下，PostStream 的根就是帖子容器；同时兜底几个常用类名\n  if (!rootEl) return null;\n  if (rootEl.classList && (rootEl.classList.contains('PostStream') || rootEl.matches('.PostStream'))) return rootEl;\n\n  const byClass =\n    rootEl.querySelector('.PostStream') ||\n    rootEl.querySelector('.DiscussionPage-list') ||\n    rootEl.querySelector('.PostStream-items') ||\n    rootEl;\n\n  return byClass;\n}\n\nfunction ensureFlexContainer(container) {\n  const cs = container.style;\n  if (cs.display !== 'flex') {\n    cs.display = 'flex';\n    cs.flexDirection = 'column';\n  }\n  // 允许换行的绝对/固定元素（如锚点）仍然能正确占位\n}\n\nfunction cleanupDepthClasses(node) {\n  // 移除所有 thread-depth-* 与我们加的标记类，避免累积\n  const toRemove = [];\n  node.classList.forEach((c) => {\n    if (c.indexOf('thread-depth-') === 0 || c === 'threaded-post' || c === 'thread-deep' || c === 'thread-very-deep' || c === 'thread-root') {\n      toRemove.push(c);\n    }\n  });\n  toRemove.forEach((c) => node.classList.remove(c));\n}\n\nfunction collectIds(root) {\n  const out = new Set();\n  if (!root) return out;\n  root.querySelectorAll('article.Post[data-id]').forEach((n) => {\n    const id = Number(n.dataset.id);\n    if (Number.isFinite(id)) out.add(id);\n  });\n  return out;\n}\n\nfunction findActivePostStream() {\n  // 简单拿第一个 PostStream 组件对应的根 DOM\n  const el = document.querySelector('.PostStream') || document.querySelector('article.Post')?.closest('*');\n  if (!el) return null;\n\n  // 从 DOM 回溯 mithril 组件实例较复杂；这里用保守方式：遍历 mounted 组件中最可能的那个\n  // 在 Flarum 环境下，PostStream 实例通常可从当前页面组件树取到：\n  const page = app.current && app.current.get && app.current.get('route') === 'discussion'\n    ? app.current.get('component')\n    : null;\n\n  // 最稳妥：通过 DiscussionPage 拿到 postStream\n  const disc = app.current && app.current.get && app.current.get('discussion');\n  if (disc && disc.postStream) return disc.postStream;\n\n  return null;\n}\n\n// ============ 轻门帘：避免预取未就绪的短闪动 ============\n\nfunction tryVeilUntilOrderReady(postStream, did) {\n  if (!did) return;\n\n  const root = postStream && postStream.element;\n  const container = queryPostContainer(root);\n  if (!container) return;\n\n  let unveiled = false;\n\n  const unveil = () => {\n    if (unveiled) return;\n    unveiled = true;\n    container.style.transition = 'opacity 90ms ease';\n    container.style.opacity = '1';\n  };\n\n  // 先拉低透明度，预取很快的话，看不到闪动；否则最多 VEIL_MAX_WAIT ms\n  container.style.opacity = '0';\n  const fallback = setTimeout(unveil, VEIL_MAX_WAIT);\n\n  prefetchThreadOrder(did).finally(() => {\n    clearTimeout(fallback);\n    unveil();\n  });\n}\n","// js/src/forum/index.js\nimport app from 'flarum/forum/app';\nimport { extend } from 'flarum/common/extend';\n\nimport DiscussionPage from 'flarum/forum/components/DiscussionPage';\nimport DiscussionListItem from 'flarum/forum/components/DiscussionListItem';\n\nimport { initThreadedPost } from './components/ThreadedPost';\nimport { initThreadedReplyComposer } from './components/ThreadedReplyComposer';\n// 注：不再覆盖 PostStream.posts；Flex 排序模式走 DOM 层，不改数组顺序\nimport { installFlexOrderMode } from './utils/FlexOrderMode';\nimport { prefetchThreadOrder } from './utils/ThreadOrderPrefetch';\n\n/**\n * 日志控制（默认屏蔽，可在控制台开启）\n * 仅影响以 \"[Threadify]\" 开头的日志；其余 console 输出不受影响。\n */\n(function setupThreadifyLoggingToggle() {\n  const NS = '[Threadify]';\n  const KEY = 'threadify:logs';\n  const methods = ['log', 'info', 'warn', 'debug', 'error'];\n\n  if (!window.__threadifyConsoleOriginal) {\n    window.__threadifyConsoleOriginal = {};\n    methods.forEach((name) => {\n      window.__threadifyConsoleOriginal[name] =\n        console[name] ? console[name].bind(console) : () => {};\n    });\n  }\n\n  const persisted =\n    typeof localStorage !== 'undefined' ? localStorage.getItem(KEY) : null;\n  let enabled = persisted === '1';\n\n  function applyWrap() {\n    methods.forEach((name) => {\n      const original = window.__threadifyConsoleOriginal[name];\n      console[name] = (...args) => {\n        const first = args && args[0];\n        const isThreadifyMsg = typeof first === 'string' && first.indexOf(NS) === 0;\n        if (isThreadifyMsg && !enabled) return;\n        return original(...args);\n      };\n    });\n  }\n\n  function setEnabled(v) {\n    enabled = !!v;\n    if (typeof localStorage !== 'undefined') {\n      localStorage.setItem(KEY, enabled ? '1' : '0');\n    }\n  }\n\n  window.threadifyLogs = {\n    enable() { setEnabled(true); return 'Threadify logs: ON'; },\n    disable() { setEnabled(false); return 'Threadify logs: OFF'; },\n    toggle() { setEnabled(!enabled); return `Threadify logs: ${enabled ? 'ON' : 'OFF'}`; },\n    status() { return enabled; },\n  };\n\n  applyWrap();\n})();\n\napp.initializers.add('syntaxoutlaw-threadify', () => {\n  // 仍然保留：给帖子元素补充深度类名等（不与 Flex 排序冲突）\n  initThreadedPost();\n\n  // 仍然保留：在提交数据时自动填写 parent_id\n  initThreadedReplyComposer();\n\n  // 启用“Flex 可视化排序模式”：不改 posts()，只操作 DOM 的 order 与类名\n  installFlexOrderMode();\n\n  // 进入讨论页即预取顺序（payload 极小）\n  extend(DiscussionPage.prototype, 'oninit', function () {\n    const did =\n      (this.discussion && typeof this.discussion.id === 'function' && this.discussion.id()) ||\n      (this.discussion && this.discussion.id) ||\n      null;\n    if (did) prefetchThreadOrder(did);\n  });\n\n  // 讨论列表：首个悬停/触摸即预取，提高命中率\n  extend(DiscussionListItem.prototype, 'oncreate', function () {\n    const discussion = this.attrs.discussion;\n    if (!discussion) return;\n    const did = discussion.id();\n    const handler = () => prefetchThreadOrder(did);\n\n    if (this.element) {\n      this.element.addEventListener('mouseenter', handler, { once: true });\n      this.element.addEventListener('touchstart', handler, { once: true, passive: true });\n    }\n  });\n});\n","/**\n * Threaded Post Component Extensions\n * \n * Handles Post component extensions for threading functionality.\n * This module is responsible for:\n * - Adding threading CSS classes to posts based on their depth\n * - Managing post-specific threading visual elements\n * - Integrating with the ThreadDepth utility for depth calculations\n * \n * @author Threadify Extension\n */\n\nimport { extend } from 'flarum/common/extend';\nimport Post from 'flarum/forum/components/Post';\nimport { getThreadCssClasses } from '../utils/SimplifiedThreadDepth';\n\n/**\n * Initialize Post component extensions for threading\n * \n * Sets up all the necessary hooks and extensions for the Post component\n * to display threading information properly.\n */\nexport function initThreadedPost() {\n  // Hook into Post component to add threading CSS classes\n  extend(Post.prototype, 'classes', function(classes) {\n    const post = this.attrs.post;\n    \n    // Skip processing if we don't have a valid post\n    if (!post) {\n      console.warn('[Threadify] No post in ThreadedPost.classes');\n      return classes;\n    }\n    \n    // Get threading CSS classes from simplified utility\n    const threadClasses = getThreadCssClasses(post);\n    console.log(`[Threadify] Adding classes to post ${post.id()}: ${threadClasses.join(', ')}`);\n    \n    threadClasses.forEach(className => {\n      classes.push(className);\n    });\n    \n    return classes;\n  });\n}\n\n/**\n * Get thread metadata for a post\n * \n * Extracts useful threading metadata from a post that can be used\n * by other components or for debugging purposes.\n * \n * @param {Post} post - The post to extract metadata from\n * @param {Post[]} allPosts - All posts in the discussion\n * @returns {Object} - Thread metadata object\n */\nexport function getPostThreadMetadata(post, allPosts) {\n  if (!post) return null;\n  \n  const parentId = post.attribute('parent_id');\n  const parentPost = parentId ? allPosts.find(p => p && p.id() == parentId) : null;\n  \n  // Find direct children of this post\n  const children = allPosts.filter(p => \n    p && p.attribute('parent_id') == post.id()\n  );\n  \n  // Calculate some thread statistics\n  const descendants = getDescendantCount(post, allPosts);\n  \n  return {\n    postId: post.id(),\n    parentId: parentId,\n    hasParent: !!parentPost,\n    parentPost: parentPost,\n    directChildren: children,\n    childrenCount: children.length,\n    descendantCount: descendants,\n    isRootPost: !parentId,\n    threadClasses: getThreadCssClasses(post, allPosts)\n  };\n}\n\n/**\n * Count all descendants (children, grandchildren, etc.) of a post\n * \n * @param {Post} post - The post to count descendants for\n * @param {Post[]} allPosts - All posts in the discussion\n * @returns {number} - Total number of descendants\n */\nfunction getDescendantCount(post, allPosts) {\n  const directChildren = allPosts.filter(p => \n    p && p.attribute('parent_id') == post.id()\n  );\n  \n  let count = directChildren.length;\n  \n  // Recursively count descendants of each child\n  directChildren.forEach(child => {\n    count += getDescendantCount(child, allPosts);\n  });\n  \n  return count;\n}\n\n/**\n * Check if a post is part of a specific thread branch\n * \n * Determines if a post is either a descendant or ancestor of another post.\n * Useful for highlighting related posts or collapsing thread branches.\n * \n * @param {Post} post1 - First post\n * @param {Post} post2 - Second post  \n * @param {Post[]} allPosts - All posts in the discussion\n * @returns {boolean} - True if posts are in the same thread branch\n */\nexport function arePostsInSameBranch(post1, post2, allPosts) {\n  if (!post1 || !post2 || post1.id() === post2.id()) {\n    return false;\n  }\n  \n  // Check if post1 is an ancestor of post2\n  let currentPost = post2;\n  while (currentPost) {\n    const parentId = currentPost.attribute('parent_id');\n    if (!parentId) break;\n    \n    if (parentId == post1.id()) {\n      return true; // post1 is an ancestor of post2\n    }\n    \n    currentPost = allPosts.find(p => p && p.id() == parentId);\n  }\n  \n  // Check if post2 is an ancestor of post1\n  currentPost = post1;\n  while (currentPost) {\n    const parentId = currentPost.attribute('parent_id');\n    if (!parentId) break;\n    \n    if (parentId == post2.id()) {\n      return true; // post2 is an ancestor of post1\n    }\n    \n    currentPost = allPosts.find(p => p && p.id() == parentId);\n  }\n  \n  return false;\n}\n\n/**\n * Get the root post of a thread branch\n * \n * Traces back through parent relationships to find the root post\n * of the thread branch that contains the given post.\n * \n * @param {Post} post - The post to find the root for\n * @param {Post[]} allPosts - All posts in the discussion\n * @returns {Post|null} - The root post of the thread branch\n */\nexport function getThreadRoot(post, allPosts) {\n  if (!post) return null;\n  \n  let currentPost = post;\n  let rootPost = post;\n  \n  // Trace back through parents until we find a post with no parent\n  while (currentPost) {\n    const parentId = currentPost.attribute('parent_id');\n    if (!parentId) {\n      rootPost = currentPost;\n      break;\n    }\n    \n    const parentPost = allPosts.find(p => p && p.id() == parentId);\n    if (!parentPost) {\n      // Parent not found, current post becomes the effective root\n      rootPost = currentPost;\n      break;\n    }\n    \n    rootPost = parentPost;\n    currentPost = parentPost;\n  }\n  \n  return rootPost;\n} \n","/**\n * Threaded Reply Composer Extensions\n * \n * Handles ReplyComposer component extensions for threading functionality.\n * This module is responsible for:\n * - Extracting parent_id from post mentions in reply content\n * - Adding parent_id to the reply data before submission\n * - Integrating with Flarum's mentions extension for seamless threading\n * \n * The threading system works by detecting post mentions in the format:\n * @\"Display Name\"#p123 where 123 is the post ID that becomes the parent_id\n * \n * @author Threadify Extension\n */\n\nimport { extend } from 'flarum/common/extend';\nimport ReplyComposer from 'flarum/forum/components/ReplyComposer';\n\n/**\n * Initialize ReplyComposer component extensions for threading\n * \n * Sets up hooks to automatically detect and add parent_id relationships\n * when users reply to specific posts using the mentions system.\n */\nexport function initThreadedReplyComposer() {\n  // Hook into reply submission to add parent_id\n  extend(ReplyComposer.prototype, 'data', function(data) {\n    const parentId = extractParentIdFromContent(data.content);\n    \n    if (parentId) {\n      // Add parent_id directly to the data object\n      data.parent_id = parentId;\n      console.log('[Threadify] Reply threading to post', parentId);\n    }\n    \n    return data;\n  });\n}\n\n/**\n * Extract parent post ID from reply content\n * \n * Parses the reply content for post mentions from the mentions extension\n * and extracts the post ID to use as parent_id for threading.\n * \n * Supported mention formats:\n * - @\"Display Name\"#p123 (standard post mention)\n * - Multiple mentions (uses the first one found)\n * \n * @param {string} content - The reply content to parse\n * @returns {number|null} - The parent post ID or null if none found\n */\nexport function extractParentIdFromContent(content) {\n  if (!content || typeof content !== 'string') {\n    return null;\n  }\n  \n  // Parse the content for post mentions from the mentions extension\n  // Format: @\"Display Name\"#p123 where 123 is the post ID\n  const postMentionMatch = content.match(/@\"[^\"]*\"#p(\\d+)/);\n  \n  if (postMentionMatch && postMentionMatch[1]) {\n    const parentId = parseInt(postMentionMatch[1], 10);\n    \n    // Validate that it's a valid number\n    if (!isNaN(parentId) && parentId > 0) {\n      return parentId;\n    }\n  }\n  \n  return null;\n}\n\n/**\n * Extract all mentioned post IDs from content\n * \n * Gets all post mentions from the content, not just the first one.\n * Useful for analytics or advanced threading features.\n * \n * @param {string} content - The reply content to parse\n * @returns {number[]} - Array of mentioned post IDs\n */\nexport function extractAllMentionedPostIds(content) {\n  if (!content || typeof content !== 'string') {\n    return [];\n  }\n  \n  const postMentionRegex = /@\"[^\"]*\"#p(\\d+)/g;\n  const matches = [];\n  let match;\n  \n  while ((match = postMentionRegex.exec(content)) !== null) {\n    const postId = parseInt(match[1], 10);\n    if (!isNaN(postId) && postId > 0) {\n      matches.push(postId);\n    }\n  }\n  \n  return matches;\n}\n\n/**\n * Check if content contains post mentions\n * \n * @param {string} content - The content to check\n * @returns {boolean} - True if content contains post mentions\n */\nexport function hasPostMentions(content) {\n  return extractParentIdFromContent(content) !== null;\n}\n\n/**\n * Get threading context from reply content\n * \n * Extracts comprehensive threading information from reply content,\n * including the primary parent and any additional mentioned posts.\n * \n * @param {string} content - The reply content to analyze\n * @returns {Object} - Threading context object\n */\nexport function getThreadingContext(content) {\n  const primaryParentId = extractParentIdFromContent(content);\n  const allMentionedIds = extractAllMentionedPostIds(content);\n  \n  return {\n    primaryParentId: primaryParentId,\n    allMentionedPostIds: allMentionedIds,\n    hasMentions: allMentionedIds.length > 0,\n    mentionCount: allMentionedIds.length,\n    isThreadedReply: primaryParentId !== null\n  };\n}\n\n/**\n * Validate threading data before submission\n * \n * Performs validation on the threading data to ensure it's valid\n * before the reply is submitted to the server.\n * \n * @param {Object} data - The reply data object\n * @returns {Object} - Validation result with isValid boolean and any error messages\n */\nexport function validateThreadingData(data) {\n  const result = {\n    isValid: true,\n    errors: [],\n    warnings: []\n  };\n  \n  // Check if parent_id is present and valid\n  if (data.parent_id !== undefined) {\n    if (typeof data.parent_id !== 'number' || data.parent_id <= 0) {\n      result.isValid = false;\n      result.errors.push('Invalid parent_id: must be a positive number');\n    }\n  }\n  \n  // Check for potential threading issues\n  if (data.content && hasPostMentions(data.content)) {\n    const context = getThreadingContext(data.content);\n    \n    if (!data.parent_id && context.isThreadedReply) {\n      result.warnings.push('Content contains post mentions but no parent_id was set');\n    }\n    \n    if (context.mentionCount > 1) {\n      result.warnings.push(`Multiple post mentions found (${context.mentionCount}), only first will be used for threading`);\n    }\n  }\n  \n  return result;\n}\n\n/**\n * Clean threading data for submission\n * \n * Ensures threading data is properly formatted and cleaned before\n * being sent to the server.\n * \n * @param {Object} data - The reply data object\n * @returns {Object} - Cleaned data object\n */\nexport function cleanThreadingData(data) {\n  const cleanedData = { ...data };\n  \n  // Ensure parent_id is a proper integer or remove it\n  if (cleanedData.parent_id !== undefined) {\n    const parentId = parseInt(cleanedData.parent_id, 10);\n    if (!isNaN(parentId) && parentId > 0) {\n      cleanedData.parent_id = parentId;\n    } else {\n      delete cleanedData.parent_id;\n    }\n  }\n  \n  return cleanedData;\n} "],"names":["__webpack_require__","module","getter","__esModule","d","a","exports","definition","key","o","Object","defineProperty","enumerable","get","obj","prop","prototype","hasOwnProperty","call","flarum","core","compat","getPostThreadMetadata","post","_threadDepth","depth","threadPath","_threadPath","isRoot","_isRoot","childCount","_childCount","descendantCount","_descendantCount","rootPostId","_rootPostId","_cache","Map","prefetchThreadOrder","discussionId","did","String","has","ready","entry","map","set","app","request","method","url","forum","attribute","then","res","order","forEach","_ref","postId","parentPostId","Number","isFinite","parentId","window","dispatchEvent","CustomEvent","detail","e","console","warn","getDepthPrefetched","rec","undefined","clampDepth","n","x","Math","max","min","getThreadCssClasses","id","discussion","isInteger","_","md","guard","seen","Set","current","pid","add","parent","store","getById","walkDepthByParentChain","getThreadDepth","classes","push","prefParent","getParentPrefetched","suspendApply","pendingApply","currentDiscussionId","scheduled","seenIds","scheduleApply","postStream","cancelAnimationFrame","requestAnimationFrame","root","element","container","queryPostContainer","cs","style","display","flexDirection","ensureFlexContainer","stream","posts","Array","from","querySelectorAll","dataset","node","getOrderIndex","ord","toRemove","classList","c","indexOf","remove","cleanupDepthClasses","applyFlexOrder","applySoonFromState","state","ps","rootEl","contains","matches","querySelector","KEY","methods","__threadifyConsoleOriginal","name","bind","enabled","localStorage","getItem","setEnabled","v","setItem","threadifyLogs","enable","disable","toggle","status","original","_len","arguments","length","args","_key","first","apply","extend","Post","this","attrs","threadClasses","log","join","className","ReplyComposer","data","content","postMentionMatch","match","parseInt","isNaN","extractParentIdFromContent","parent_id","override","PostStreamState","_this","p","Promise","resolve","_this2","_len2","_key2","PostStream","clear","unveiled","unveil","transition","opacity","fallback","setTimeout","clearTimeout","tryVeilUntilOrderReady","out","_this3","idsNow","hasNew","addEventListener","ev","didReady","_document$querySelect","document","closest","disc","findActivePostStream","DiscussionPage","DiscussionListItem","handler","once","passive"],"sourceRoot":""}