{"version":3,"file":"forum.js","mappings":"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","sources":["webpack://@syntaxoutlaw/flarum-ext-threadify/webpack/bootstrap","webpack://@syntaxoutlaw/flarum-ext-threadify/webpack/runtime/compat get default export","webpack://@syntaxoutlaw/flarum-ext-threadify/webpack/runtime/define property getters","webpack://@syntaxoutlaw/flarum-ext-threadify/webpack/runtime/hasOwnProperty shorthand","webpack://@syntaxoutlaw/flarum-ext-threadify/external root \"flarum.core.compat['forum/app']\"","webpack://@syntaxoutlaw/flarum-ext-threadify/external root \"flarum.core.compat['common/extend']\"","webpack://@syntaxoutlaw/flarum-ext-threadify/external root \"flarum.core.compat['forum/components/DiscussionPage']\"","webpack://@syntaxoutlaw/flarum-ext-threadify/external root \"flarum.core.compat['forum/components/DiscussionListItem']\"","webpack://@syntaxoutlaw/flarum-ext-threadify/external root \"flarum.core.compat['forum/components/Post']\"","webpack://@syntaxoutlaw/flarum-ext-threadify/./src/forum/utils/ThreadsApi.js","webpack://@syntaxoutlaw/flarum-ext-threadify/./src/forum/utils/ThreadOrderPrefetch.js","webpack://@syntaxoutlaw/flarum-ext-threadify/./src/forum/utils/SimplifiedThreadDepth.js","webpack://@syntaxoutlaw/flarum-ext-threadify/external root \"flarum.core.compat['forum/components/ReplyComposer']\"","webpack://@syntaxoutlaw/flarum-ext-threadify/external root \"flarum.core.compat['forum/components/PostStream']\"","webpack://@syntaxoutlaw/flarum-ext-threadify/./src/forum/utils/DomReorderMode.js","webpack://@syntaxoutlaw/flarum-ext-threadify/./src/forum/index.js","webpack://@syntaxoutlaw/flarum-ext-threadify/./src/forum/components/ThreadedReplyComposer.js","webpack://@syntaxoutlaw/flarum-ext-threadify/./src/forum/components/ThreadedPost.js"],"sourcesContent":["// The require scope\nvar __webpack_require__ = {};\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/app'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/extend'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/DiscussionPage'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/DiscussionListItem'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/Post'];","/**\n * threads-order API 轻量层\n * - 负责预取并缓存：Map<postId, { order, depth, parentId }>\n * - 暴露读取与监听工具\n */\n\nconst _cache = new Map(); // did -> { ready: Promise<void>, map: Map<number,{order,depth,parentId}> }\n\nexport function prefetchThreadsOrder(discussionId) {\n  const did = Number(discussionId);\n  if (!did) return Promise.resolve();\n\n  const hit = _cache.get(did);\n  if (hit && hit.ready) return hit.ready;\n\n  const entry = { ready: null, map: new Map() };\n  _cache.set(did, entry);\n\n  entry.ready = app.request({\n    method: 'GET',\n    url: `${app.forum.attribute('apiUrl')}/discussions/${did}/threads-order`,\n  }).then((res) => {\n    const map = new Map();\n    (res.order || []).forEach(({ postId, order, depth, parentPostId }) => {\n      map.set(Number(postId), {\n        order: Number(order),\n        depth: Number.isFinite(depth) ? Number(depth) : 0,\n        parentId: parentPostId ? Number(parentPostId) : null,\n      });\n    });\n    entry.map = map;\n\n    // 通知前端其它模块（可选）\n    try {\n      window.dispatchEvent(new CustomEvent('threadify:order-ready', { detail: { discussionId: did } }));\n    } catch (e) {}\n  }).catch((e) => {\n    console.warn('[Threadify] threads-order prefetch failed', e);\n  });\n\n  return entry.ready;\n}\n\nexport function getOrderRecord(discussionId, postId) {\n  const entry = _cache.get(Number(discussionId));\n  if (!entry) return undefined;\n  return entry.map.get(Number(postId));\n}\n\nexport function getPrefetchedDepth(discussionId, postId) {\n  const rec = getOrderRecord(discussionId, postId);\n  return rec ? rec.depth : undefined;\n}\n\nexport function hasOrderFor(discussionId) {\n  const entry = _cache.get(Number(discussionId));\n  return !!(entry && entry.map && entry.map.size);\n}\n\n// 供 SimplifiedThreadDepth 使用：把预取到的元数据回传给“加类名”逻辑\nexport function getPostThreadMetadata(post) {\n  if (!post) return null;\n  const discussion = post.discussion && post.discussion();\n  const did = discussion && discussion.id && discussion.id();\n  if (!did) return null;\n\n  const rec = getOrderRecord(did, post.id());\n  if (!rec) return null;\n\n  // 注意：rootPostId/descendantCount 这类聚合值由服务端负责；此处仅返回前端需要的 depth/parent\n  return {\n    depth: rec.depth,\n    threadPath: null,\n    isRoot: !rec.parentId,\n    childCount: 0,\n    descendantCount: 0,\n    rootPostId: null,\n  };\n}\n","/**\n * 轻量顺序预取：/discussions/:id/threads-order\n *\n * 暴露：\n *  - prefetchThreadOrder(did, { force?: boolean }) -> Promise<void>\n *  - getOrderIndex(did, postId) -> number|undefined\n *  - getDepthPrefetched(did, postId) -> number|undefined\n *  - getParentPrefetched(did, postId) -> number|undefined\n *  - getCachedOrderMap(did) -> Map|undefined  （新增：同步读缓存给其它模块复用）\n *  - waitOrderMap(did) -> Promise<Map>        （新增：等待就绪并拿 Map）\n *  - hasFreshOrder(did) -> boolean            （新增：是否在 TTL 内）\n *  - invalidateThreadOrder(did)               （新增：使某讨论缓存失效）\n *  - clearAllThreadOrderCache()               （新增：清空所有缓存）\n *\n * 事件：\n *  - window.dispatchEvent(new CustomEvent('threadify:order-ready', { detail: { discussionId } }))\n */\n\nconst _cache = new Map(); // did -> { map: Map<postId,Rec>, inflight: Promise<void>|null, ts: number }\nconst TTL_MS = 10_000;\nconst EVT_READY = 'threadify:order-ready';\n\n/**\n * @param {number|string} discussionId\n * @param {{force?: boolean}} opts\n */\nexport function prefetchThreadOrder(discussionId, opts = {}) {\n  const did = _coerceDid(discussionId);\n  if (!did) return Promise.resolve();\n\n  const now = Date.now();\n  const entry = _cache.get(did) || { map: new Map(), inflight: null, ts: 0 };\n  _cache.set(did, entry);\n\n  // 命中新鲜缓存：直接复用最后一次 inflight（若有），否则返回已完成的 resolved\n  if (!opts.force && (now - entry.ts) < TTL_MS) {\n    return entry.inflight || Promise.resolve();\n  }\n\n  // 已有请求在路上，且不强制：直接复用\n  if (entry.inflight && !opts.force) return entry.inflight;\n\n  // 发起新请求\n  const bust = now; // 避免中间层缓存\n  entry.inflight = app.request({\n    method: 'GET',\n    url: `${app.forum.attribute('apiUrl')}/discussions/${did}/threads-order?bust=${bust}`,\n  }).then((res) => {\n    const map = new Map();\n    (res && res.order ? res.order : []).forEach(({ postId, order, depth, parentPostId }) => {\n      postId = Number(postId);\n      map.set(postId, {\n        order: Number(order),\n        depth: Number.isFinite(depth) ? Number(depth) : 0,\n        parentId: parentPostId ? Number(parentPostId) : null,\n      });\n    });\n\n    entry.map = map;\n    entry.ts = Date.now();\n\n    // 广播就绪\n    try {\n      window.dispatchEvent(new CustomEvent(EVT_READY, { detail: { discussionId: Number(did) } }));\n    } catch {}\n  }).catch((e) => {\n    console.warn('[Threadify] order prefetch failed', e);\n  }).finally(() => {\n    // 标记无在途请求\n    // 注意：保留 entry.map 与 entry.ts\n    entry.inflight = null;\n  });\n\n  return entry.inflight;\n}\n\n/**\n * @param {number|string} discussionId\n * @param {number|string} postId\n * @returns {number|undefined}\n */\nexport function getOrderIndex(discussionId, postId) {\n  const map = getCachedOrderMap(discussionId);\n  const rec = map && map.get(Number(postId));\n  return rec ? rec.order : undefined;\n}\n\n/**\n * @param {number|string} discussionId\n * @param {number|string} postId\n * @returns {number|undefined}\n */\nexport function getDepthPrefetched(discussionId, postId) {\n  const map = getCachedOrderMap(discussionId);\n  const rec = map && map.get(Number(postId));\n  return rec ? rec.depth : undefined;\n}\n\n/**\n * @param {number|string} discussionId\n * @param {number|string} postId\n * @returns {number|undefined}\n */\nexport function getParentPrefetched(discussionId, postId) {\n  const map = getCachedOrderMap(discussionId);\n  const rec = map && map.get(Number(postId));\n  return rec ? rec.parentId : undefined;\n}\n\n/**\n * 同步读取缓存 Map（若不存在返回 undefined）\n * @param {number|string} discussionId\n * @returns {Map<number,{order:number,depth:number,parentId:number|null}>|undefined}\n */\nexport function getCachedOrderMap(discussionId) {\n  const did = _coerceDid(discussionId);\n  if (!did) return undefined;\n  const entry = _cache.get(did);\n  return entry ? entry.map : undefined;\n}\n\n/**\n * 等待 Map 可用并返回\n * 若缓存新鲜则立即 resolve；否则等待在途请求或触发一次预取\n * @param {number|string} discussionId\n * @returns {Promise<Map<number,{order:number,depth:number,parentId:number|null}>>}\n */\nexport function waitOrderMap(discussionId) {\n  const did = _coerceDid(discussionId);\n  if (!did) return Promise.resolve(new Map());\n\n  const now = Date.now();\n  const entry = _cache.get(did) || { map: new Map(), inflight: null, ts: 0 };\n  _cache.set(did, entry);\n\n  if ((now - entry.ts) < TTL_MS && entry.map && entry.map.size >= 0) {\n    return Promise.resolve(entry.map);\n  }\n\n  const p = entry.inflight || prefetchThreadOrder(did);\n  return p.then(() => getCachedOrderMap(did) || new Map());\n}\n\n/**\n * 缓存是否在 TTL 内新鲜\n * @param {number|string} discussionId\n */\nexport function hasFreshOrder(discussionId) {\n  const did = _coerceDid(discussionId);\n  if (!did) return false;\n  const entry = _cache.get(did);\n  if (!entry) return false;\n  return (Date.now() - (entry.ts || 0)) < TTL_MS;\n}\n\n/**\n * 使单个讨论的缓存失效（下一次 wait/prefetch 会重新拉取）\n * @param {number|string} discussionId\n */\nexport function invalidateThreadOrder(discussionId) {\n  const did = _coerceDid(discussionId);\n  if (!did) return;\n  const entry = _cache.get(did);\n  if (entry) entry.ts = 0;\n}\n\n/** 清空所有讨论的线程顺序缓存 */\nexport function clearAllThreadOrderCache() {\n  _cache.clear();\n}\n\n/* ---------------- 内部工具 ---------------- */\n\nfunction _coerceDid(discussionId) {\n  if (discussionId == null) return null;\n  const n = Number(discussionId);\n  return Number.isFinite(n) && n > 0 ? String(n) : null;\n}\n","/**\n * Simplified Thread Depth Utilities (fixed)\n *\n * 优先级：\n *  1) /threads-order 预取的 depth\n *  2) /threads 元数据里的 _threadDepth\n *  3) 本地沿 parent_id 向上爬链计算\n *\n * 始终返回 0..MAX_DISPLAY_DEPTH，且不会抛错。\n */\n\nimport { getPostThreadMetadata } from './ThreadsApi';\nimport { getDepthPrefetched, getParentPrefetched } from './ThreadOrderPrefetch';\n\nconst MAX_DISPLAY_DEPTH = 10;\n\n/** ---- helpers ---- */\nfunction clampDepth(n) {\n  const x = Number(n);\n  return Number.isFinite(x) ? Math.max(0, Math.min(MAX_DISPLAY_DEPTH, x)) : 0;\n}\n\nfunction walkDepthByParentChain(post) {\n  // 沿 parent_id 向上爬；即便父帖未加载也能给出“已知最大深度”\n  let depth = 0;\n  let guard = 0;\n  const seen = new Set();\n\n  let current = post;\n  while (current && guard < 100) {\n    const pid = current.attribute ? current.attribute('parent_id') : null;\n    if (!pid) break;\n\n    // 循环保护\n    if (seen.has(pid)) {\n      console.warn('[Threadify] cycle detected while walking parents of', post && post.id && post.id());\n      depth = 0;\n      break;\n    }\n    seen.add(pid);\n\n    depth += 1;\n    // 试着从 store 取父贴，取不到就以当前深度作准（父贴可能尚未加载）\n    const parent = app.store.getById('posts', String(pid));\n    if (!parent) break;\n\n    current = parent;\n    guard++;\n    if (depth >= MAX_DISPLAY_DEPTH) break;\n  }\n  return clampDepth(depth);\n}\n\n/** ---- public API ---- */\n\n/**\n * Get thread depth for a post (0=root)\n */\nexport function getThreadDepth(post) {\n  if (!post || typeof post.id !== 'function') return 0;\n\n  // 1) 预取顺序里的 depth（最快、最稳定）\n  try {\n    const did =\n      (post.discussion && typeof post.discussion === 'function' && post.discussion() && post.discussion().id && post.discussion().id()) ||\n      null;\n    if (did != null) {\n      const d = getDepthPrefetched(did, post.id());\n      if (Number.isInteger(d)) return clampDepth(d);\n    }\n  } catch (_) {\n    // ignore\n  }\n\n  // 2) /threads 元数据（若前端曾调用过 loadDiscussionThreads）\n  try {\n    const md = getPostThreadMetadata(post);\n    if (md && Number.isInteger(md.depth)) return clampDepth(md.depth);\n  } catch (_) {\n    // ignore\n  }\n\n  // 3) 本地按 parent_id 向上爬链\n  return walkDepthByParentChain(post);\n}\n\n/**\n * CSS classes for a post based on its thread depth.\n * 统一使用：threaded-post / thread-root / thread-depth-N / thread-deep / thread-very-deep\n */\nexport function getThreadCssClasses(post) {\n  const depth = getThreadDepth(post);\n  const classes = [];\n\n  if (depth > 0) {\n    classes.push('threaded-post');\n    classes.push(`thread-depth-${depth}`);\n    if (depth >= 3) classes.push('thread-deep');\n    if (depth >= 5) classes.push('thread-very-deep');\n  } else {\n    classes.push('thread-root');\n  }\n\n  // 尽量从预取或元数据补充“根/父”信息（可选）\n  try {\n    const did =\n      (post.discussion && typeof post.discussion === 'function' && post.discussion() && post.discussion().id && post.discussion().id()) ||\n      null;\n    const prefParent = did != null ? getParentPrefetched(did, post.id()) : undefined;\n    const md = getPostThreadMetadata(post);\n\n    const isRoot =\n      (prefParent === null || prefParent === undefined) ?\n        (!post.attribute || !post.attribute('parent_id')) :\n        (prefParent == null);\n\n    if (isRoot) classes.push('thread-root-confirmed');\n\n    // 可根据 md.childCount / md.descendantCount 再加细化类名（没有就跳过）\n    if (md && Number.isInteger(md.childCount) && md.childCount > 0) {\n      classes.push('has-children', `child-count-${Math.min(md.childCount, 10)}`);\n    }\n    if (md && Number.isInteger(md.descendantCount) && md.descendantCount > 0) {\n      classes.push('has-descendants');\n    }\n  } catch (_) {\n    // 忽略补充信息失败\n  }\n\n  return classes;\n}\n\n/** convenience helpers */\nexport function isRootPost(post) {\n  return getThreadDepth(post) === 0;\n}\n\nexport function getThreadRootId(/* post */) {\n  // 若后续需要，可接入预取 map 里的 rootId；当前仅用于样式则不强制实现\n  return null;\n}\n\nexport function getChildCount(post) {\n  const md = getPostThreadMetadata(post);\n  return md && Number.isInteger(md.childCount) ? md.childCount : 0;\n}\n\nexport function getDescendantCount(post) {\n  const md = getPostThreadMetadata(post);\n  return md && Number.isInteger(md.descendantCount) ? md.descendantCount : 0;\n}\n\nexport function getThreadPath(post) {\n  const md = getPostThreadMetadata(post);\n  return md ? md.threadPath || null : null;\n}\n","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/ReplyComposer'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/PostStream'];","// js/src/forum/utils/DomReorderMode.js\n// Threadify DOM Reorder — “锚定编织（anchored weave）”\n// 只在当前窗口(.PostStream-item[data-id])内工作，不修改 PostStreamState/窗口大小。\n// 规则：\n// - “可移动评论”：根帖或“父子同窗”的 comment（在 orderMap 里且父在窗或无父）。\n// - “固定节点”：事件帖（不在 orderMap）以及“父不在窗的子帖”（在 orderMap 但父不在窗）。\n// - 目标序列 = 以 /threads-order 的 order 为骨架；\n//   固定节点根据“邻近已知顺序”的插值得到 baseOrder，仅用于让可移动评论跨越它们；\n// - 只移动“可移动评论”，固定节点不搬家；自右向左按目标序列插入，避免竞态。\n// - 首次加载若 URL 带 near/#p，则在首轮重排后轻微回中该楼。\n\nimport { extend } from 'flarum/common/extend';\nimport PostStream from 'flarum/forum/components/PostStream';\nimport { waitOrderMap } from '../utils/ThreadOrderPrefetch';\n\nconst BIG = 1e9;\n\n/* ---------------- 工具 ---------------- */\n\nfunction getDidFromComponent(ps) {\n  try {\n    return ps?.stream?.discussion?.id?.() ?? null;\n  } catch {\n    return null;\n  }\n}\n\nfunction getContainer(ps) {\n  if (ps?.element?.classList?.contains('PostStream')) return ps.element;\n  const found = ps?.element?.querySelector?.('.PostStream');\n  return found || document.querySelector('.PostStream') || null;\n}\n\nfunction isPostItem(el) {\n  return el && el.nodeType === 1 && el.matches('.PostStream-item[data-id]');\n}\n\nfunction collectChildren(container) {\n  return Array.from(container?.children || []);\n}\n\nfunction findPostsRange(container) {\n  const kids = collectChildren(container);\n  if (!kids.length) return { posts: [], left: -1, right: -1, anchor: null };\n\n  let L = kids.findIndex(isPostItem);\n  if (L < 0) return { posts: [], left: -1, right: -1, anchor: kids[0] || null };\n\n  let R = kids.length - 1 - [...kids].reverse().findIndex(isPostItem);\n  if (R < L) R = L;\n\n  const posts = kids.slice(L, R + 1).filter(isPostItem);\n  const anchor = kids[R + 1] || null; // 段后第一个兄弟\n  return { posts, left: L, right: R, anchor };\n}\n\nfunction getNearIdFromURL() {\n  try {\n    const usp = new URLSearchParams(location.search);\n    const near = usp.get('near');\n    if (near && /^\\d+$/.test(near)) return Number(near);\n\n    const m = (location.hash || '').match(/#p(\\d+)/);\n    if (m) return Number(m[1]);\n  } catch {}\n  return null;\n}\n\nfunction recenterIfNeeded(container, targetId, onceFlagObj) {\n  if (!targetId || onceFlagObj.done) return;\n  const el = container?.querySelector?.(`.PostStream-item[data-id=\"${targetId}\"]`);\n  if (!el) return;\n  try {\n    el.scrollIntoView({ block: 'center', inline: 'nearest' });\n    onceFlagObj.done = true;\n  } catch {}\n}\n\n/* ---------------- 核心：计算目标序列 ---------------- */\n\n/**\n * 生成“节点元数据”数组：\n * - id: number\n * - el: Element\n * - rec: orderMap 记录（可能不存在）\n * - movable: 是否可移动（根或父子同窗）\n * - baseOrder: 数轴上的排序键（先留空，稍后补）\n */\nfunction buildNodes(container, posts, orderMap) {\n  const presentIds = new Set(posts.map((el) => Number(el.dataset.id)));\n  const nodes = posts.map((el) => {\n    const id = Number(el.dataset.id);\n    const rec = orderMap.get(id); // {order, depth, parentId} | undefined\n\n    let movable = false;\n    if (rec) {\n      if (rec.parentId == null) movable = true; // 根帖\n      else if (presentIds.has(rec.parentId)) movable = true; // 父子同窗\n      else movable = false; // 父不在窗 -> 暂不移动\n    } else {\n      movable = false; // 事件帖/其它：不在 orderMap\n    }\n\n    return {\n      id,\n      el,\n      rec: rec || null,\n      movable,\n      baseOrder: rec ? Number(rec.order) : NaN, // 先放 known 值；其余稍后插值\n    };\n  });\n\n  // 为 baseOrder 为空(NaN)的节点做“邻近插值”：\n  // 思路：向左/右寻找最近的已知 baseOrder，取中点；仅用于让可移动评论跨越它们。\n  // 两趟扫描：记录每个位置左/右最近的已知值。\n  const n = nodes.length;\n  const leftKnown = new Array(n).fill(null);\n  const rightKnown = new Array(n).fill(null);\n\n  let last = null;\n  for (let i = 0; i < n; i++) {\n    if (Number.isFinite(nodes[i].baseOrder)) last = nodes[i].baseOrder;\n    leftKnown[i] = last;\n  }\n  last = null;\n  for (let i = n - 1; i >= 0; i--) {\n    if (Number.isFinite(nodes[i].baseOrder)) last = nodes[i].baseOrder;\n    rightKnown[i] = last;\n  }\n\n  for (let i = 0; i < n; i++) {\n    if (!Number.isFinite(nodes[i].baseOrder)) {\n      const L = leftKnown[i];\n      const R = rightKnown[i];\n      if (Number.isFinite(L) && Number.isFinite(R)) nodes[i].baseOrder = (L + R) / 2;\n      else if (Number.isFinite(L)) nodes[i].baseOrder = L + 0.5;\n      else if (Number.isFinite(R)) nodes[i].baseOrder = R - 0.5;\n      else nodes[i].baseOrder = BIG + i; // 极端兜底：没有任何已知点\n    }\n  }\n\n  // 细微去重：若 baseOrder 完全相同，按 id 提供一个极小偏移，保证稳定比较\n  // 同时确保数值安全（不影响整体相对大小）\n  const seen = new Map();\n  for (const node of nodes) {\n    const k = node.baseOrder;\n    const count = seen.get(k) || 0;\n    if (count) node.baseOrder = k + count * 1e-6;\n    seen.set(k, count + 1);\n  }\n\n  return nodes;\n}\n\n/**\n * 计算目标序列（按 baseOrder 升序、再按 id 升序）\n * 返回一个“节点元数据”数组，包含所有帖子（可移动+固定）。\n */\nfunction computeTarget(nodes) {\n  return nodes\n    .slice()\n    .sort((a, b) => {\n      if (a.baseOrder !== b.baseOrder) return a.baseOrder - b.baseOrder;\n      return a.id - b.id;\n    });\n}\n\n/* ---------------- 应用到 DOM（只搬可移动） ---------------- */\n\n/**\n * 自右向左，将每个“可移动评论”插到它“下一个目标兄弟”之前。\n * 好处：右侧的参照节点已在最终位置，insertBefore 总是有效；固定节点保持原位。\n */\nfunction applyOrder(container, targetNodes) {\n  for (let i = targetNodes.length - 1; i >= 0; i--) {\n    const cur = targetNodes[i];\n    if (!cur.movable) continue; // 固定节点不搬家\n\n    const nextEl = i + 1 < targetNodes.length ? targetNodes[i + 1].el : null;\n\n    // 参照节点必须仍在同一 container，缺失则 append。\n    const ref =\n      nextEl && nextEl.parentNode === container ? nextEl : null;\n\n    // 当前节点必须也在 container 内\n    if (!cur.el || cur.el.parentNode !== container) continue;\n\n    try {\n      container.insertBefore(cur.el, ref);\n    } catch (e) {\n      // 极端竞态：下一轮再排\n      // eslint-disable-next-line no-console\n      console.warn('[Threadify] insertBefore failed; will retry', e);\n    }\n  }\n}\n\n/* ---------------- 一次重排流程 ---------------- */\n\nfunction reorderOnce(container, did, centerFlagObj) {\n  return waitOrderMap(did)\n    .then((map) => {\n      const { posts } = findPostsRange(container);\n      if (!posts.length) return;\n\n      const nodes = buildNodes(container, posts, map || new Map());\n      const target = computeTarget(nodes);\n\n      applyOrder(container, target);\n\n      // 首轮 near/#p 回中（只做一次）\n      recenterIfNeeded(container, getNearIdFromURL(), centerFlagObj);\n    })\n    .catch((e) => {\n      // eslint-disable-next-line no-console\n      console.warn('[Threadify] order map unavailable', e);\n    });\n}\n\n/* ---------------- 生命周期挂钩 ---------------- */\n\nexport function installDomReorderMode() {\n  extend(PostStream.prototype, 'oncreate', function () {\n    const did = getDidFromComponent(this);\n    const container = getContainer(this);\n    if (!did || !container) return;\n\n    // 首次：拉取并重排；near/#p 在首轮后回中一次\n    this.__threadifyNearCentered = { done: false };\n    reorderOnce(container, did, this.__threadifyNearCentered);\n\n    // 监听 Realtime/分页的子节点变化，下一帧执行一次重排\n    let scheduled = false;\n    const observer = new MutationObserver((muts) => {\n      if (!muts.some((m) => m.type === 'childList')) return;\n      if (scheduled) return;\n      scheduled = true;\n      requestAnimationFrame(() => {\n        scheduled = false;\n        reorderOnce(container, did, this.__threadifyNearCentered);\n      });\n    });\n\n    observer.observe(container, { childList: true });\n    this.__threadifyDomObserver = observer;\n  });\n\n  extend(PostStream.prototype, 'onupdate', function () {\n    const did = getDidFromComponent(this);\n    const container = getContainer(this);\n    if (!did || !container) return;\n    reorderOnce(container, did, this.__threadifyNearCentered || { done: true });\n  });\n\n  extend(PostStream.prototype, 'onremove', function () {\n    if (this.__threadifyDomObserver) {\n      try {\n        this.__threadifyDomObserver.disconnect();\n      } catch {}\n      this.__threadifyDomObserver = null;\n    }\n  });\n}\n","import app from 'flarum/forum/app'; \nimport { extend } from 'flarum/common/extend';\n\nimport DiscussionPage from 'flarum/forum/components/DiscussionPage';\nimport DiscussionListItem from 'flarum/forum/components/DiscussionListItem';\n\nimport { initThreadedPost } from './components/ThreadedPost';\nimport { initThreadedReplyComposer } from './components/ThreadedReplyComposer';\n\nimport { installDomReorderMode } from './utils/DomReorderMode';\nimport { prefetchThreadOrder } from './utils/ThreadOrderPrefetch'; // 你已有的轻量预取，可继续用来提升首屏命中\n\n// 可选：控制 Threadify 日志的开/关（保持你之前的实现）\n(function setupThreadifyLoggingToggle() {\n  const NS = '[Threadify]';\n  const KEY = 'threadify:logs';\n  const methods = ['log', 'info', 'warn', 'debug', 'error'];\n\n  if (!window.__threadifyConsoleOriginal) {\n    window.__threadifyConsoleOriginal = {};\n    methods.forEach((name) => {\n      window.__threadifyConsoleOriginal[name] =\n        console[name] ? console[name].bind(console) : () => {};\n    });\n  }\n\n  const persisted = typeof localStorage !== 'undefined' ? localStorage.getItem(KEY) : null;\n  let enabled = persisted === '1';\n\n  function applyWrap() {\n    methods.forEach((name) => {\n      const original = window.__threadifyConsoleOriginal[name];\n      console[name] = (...args) => {\n        const first = args && args[0];\n        const isThreadifyMsg = typeof first === 'string' && first.indexOf(NS) === 0;\n        if (isThreadifyMsg && !enabled) return;\n        return original(...args);\n      };\n    });\n  }\n\n  function setEnabled(v) {\n    enabled = !!v;\n    if (typeof localStorage !== 'undefined') {\n      localStorage.setItem(KEY, enabled ? '1' : '0');\n    }\n  }\n\n  window.threadifyLogs = {\n    enable() { setEnabled(true); return 'Threadify logs: ON'; },\n    disable() { setEnabled(false); return 'Threadify logs: OFF'; },\n    toggle() { setEnabled(!enabled); return `Threadify logs: ${enabled ? 'ON' : 'OFF'}`; },\n    status() { return enabled; },\n  };\n\n  applyWrap();\n})();\n\napp.initializers.add('syntaxoutlaw-threadify', () => {\n  // 1) 提交时自动带上 parent_id（你的已有逻辑）\n  initThreadedReplyComposer();\n\n  // 2) 给帖子组件加深度类（可留可去；不会影响 Scrubber）\n  initThreadedPost();\n\n  // 3) 安装“DOM 物理重排 + 观察器”模式（核心）\n  installDomReorderMode();\n\n  // 4) 提前预取顺序（优化首屏命中）\n  extend(DiscussionPage.prototype, 'oninit', function () {\n    const did =\n      (this.discussion && typeof this.discussion.id === 'function' && this.discussion.id()) ||\n      (this.discussion && this.discussion.id) ||\n      null;\n    if (did) prefetchThreadOrder(did);\n  });\n\n  // 5) 在讨论列表悬停/触摸即预取\n  extend(DiscussionListItem.prototype, 'oncreate', function () {\n    const discussion = this.attrs.discussion;\n    if (!discussion) return;\n    const did = discussion.id();\n    const handler = () => prefetchThreadOrder(did);\n    if (this.element) {\n      this.element.addEventListener('mouseenter', handler, { once: true });\n      this.element.addEventListener('touchstart', handler, { once: true, passive: true });\n    }\n  });\n});\n","/**\n * Threaded Reply Composer Extensions\n * \n * Handles ReplyComposer component extensions for threading functionality.\n * This module is responsible for:\n * - Extracting parent_id from post mentions in reply content\n * - Adding parent_id to the reply data before submission\n * - Integrating with Flarum's mentions extension for seamless threading\n * \n * The threading system works by detecting post mentions in the format:\n * @\"Display Name\"#p123 where 123 is the post ID that becomes the parent_id\n * \n * @author Threadify Extension\n */\n\nimport { extend } from 'flarum/common/extend';\nimport ReplyComposer from 'flarum/forum/components/ReplyComposer';\n\n/**\n * Initialize ReplyComposer component extensions for threading\n * \n * Sets up hooks to automatically detect and add parent_id relationships\n * when users reply to specific posts using the mentions system.\n */\nexport function initThreadedReplyComposer() {\n  // Hook into reply submission to add parent_id\n  extend(ReplyComposer.prototype, 'data', function(data) {\n    const parentId = extractParentIdFromContent(data.content);\n    \n    if (parentId) {\n      // Add parent_id directly to the data object\n      data.parent_id = parentId;\n      console.log('[Threadify] Reply threading to post', parentId);\n    }\n    \n    return data;\n  });\n}\n\n/**\n * Extract parent post ID from reply content\n * \n * Parses the reply content for post mentions from the mentions extension\n * and extracts the post ID to use as parent_id for threading.\n * \n * Supported mention formats:\n * - @\"Display Name\"#p123 (standard post mention)\n * - Multiple mentions (uses the first one found)\n * \n * @param {string} content - The reply content to parse\n * @returns {number|null} - The parent post ID or null if none found\n */\nexport function extractParentIdFromContent(content) {\n  if (!content || typeof content !== 'string') {\n    return null;\n  }\n  \n  // Parse the content for post mentions from the mentions extension\n  // Format: @\"Display Name\"#p123 where 123 is the post ID\n  const postMentionMatch = content.match(/@\"[^\"]*\"#p(\\d+)/);\n  \n  if (postMentionMatch && postMentionMatch[1]) {\n    const parentId = parseInt(postMentionMatch[1], 10);\n    \n    // Validate that it's a valid number\n    if (!isNaN(parentId) && parentId > 0) {\n      return parentId;\n    }\n  }\n  \n  return null;\n}\n\n/**\n * Extract all mentioned post IDs from content\n * \n * Gets all post mentions from the content, not just the first one.\n * Useful for analytics or advanced threading features.\n * \n * @param {string} content - The reply content to parse\n * @returns {number[]} - Array of mentioned post IDs\n */\nexport function extractAllMentionedPostIds(content) {\n  if (!content || typeof content !== 'string') {\n    return [];\n  }\n  \n  const postMentionRegex = /@\"[^\"]*\"#p(\\d+)/g;\n  const matches = [];\n  let match;\n  \n  while ((match = postMentionRegex.exec(content)) !== null) {\n    const postId = parseInt(match[1], 10);\n    if (!isNaN(postId) && postId > 0) {\n      matches.push(postId);\n    }\n  }\n  \n  return matches;\n}\n\n/**\n * Check if content contains post mentions\n * \n * @param {string} content - The content to check\n * @returns {boolean} - True if content contains post mentions\n */\nexport function hasPostMentions(content) {\n  return extractParentIdFromContent(content) !== null;\n}\n\n/**\n * Get threading context from reply content\n * \n * Extracts comprehensive threading information from reply content,\n * including the primary parent and any additional mentioned posts.\n * \n * @param {string} content - The reply content to analyze\n * @returns {Object} - Threading context object\n */\nexport function getThreadingContext(content) {\n  const primaryParentId = extractParentIdFromContent(content);\n  const allMentionedIds = extractAllMentionedPostIds(content);\n  \n  return {\n    primaryParentId: primaryParentId,\n    allMentionedPostIds: allMentionedIds,\n    hasMentions: allMentionedIds.length > 0,\n    mentionCount: allMentionedIds.length,\n    isThreadedReply: primaryParentId !== null\n  };\n}\n\n/**\n * Validate threading data before submission\n * \n * Performs validation on the threading data to ensure it's valid\n * before the reply is submitted to the server.\n * \n * @param {Object} data - The reply data object\n * @returns {Object} - Validation result with isValid boolean and any error messages\n */\nexport function validateThreadingData(data) {\n  const result = {\n    isValid: true,\n    errors: [],\n    warnings: []\n  };\n  \n  // Check if parent_id is present and valid\n  if (data.parent_id !== undefined) {\n    if (typeof data.parent_id !== 'number' || data.parent_id <= 0) {\n      result.isValid = false;\n      result.errors.push('Invalid parent_id: must be a positive number');\n    }\n  }\n  \n  // Check for potential threading issues\n  if (data.content && hasPostMentions(data.content)) {\n    const context = getThreadingContext(data.content);\n    \n    if (!data.parent_id && context.isThreadedReply) {\n      result.warnings.push('Content contains post mentions but no parent_id was set');\n    }\n    \n    if (context.mentionCount > 1) {\n      result.warnings.push(`Multiple post mentions found (${context.mentionCount}), only first will be used for threading`);\n    }\n  }\n  \n  return result;\n}\n\n/**\n * Clean threading data for submission\n * \n * Ensures threading data is properly formatted and cleaned before\n * being sent to the server.\n * \n * @param {Object} data - The reply data object\n * @returns {Object} - Cleaned data object\n */\nexport function cleanThreadingData(data) {\n  const cleanedData = { ...data };\n  \n  // Ensure parent_id is a proper integer or remove it\n  if (cleanedData.parent_id !== undefined) {\n    const parentId = parseInt(cleanedData.parent_id, 10);\n    if (!isNaN(parentId) && parentId > 0) {\n      cleanedData.parent_id = parentId;\n    } else {\n      delete cleanedData.parent_id;\n    }\n  }\n  \n  return cleanedData;\n} ","/**\n * Threaded Post Component Extensions\n * \n * Handles Post component extensions for threading functionality.\n * This module is responsible for:\n * - Adding threading CSS classes to posts based on their depth\n * - Managing post-specific threading visual elements\n * - Integrating with the ThreadDepth utility for depth calculations\n * \n * @author Threadify Extension\n */\n\nimport { extend } from 'flarum/common/extend';\nimport Post from 'flarum/forum/components/Post';\nimport { getThreadCssClasses } from '../utils/SimplifiedThreadDepth';\n\n/**\n * Initialize Post component extensions for threading\n * \n * Sets up all the necessary hooks and extensions for the Post component\n * to display threading information properly.\n */\nexport function initThreadedPost() {\n  // Hook into Post component to add threading CSS classes\n  extend(Post.prototype, 'classes', function(classes) {\n    const post = this.attrs.post;\n    \n    // Skip processing if we don't have a valid post\n    if (!post) {\n      console.warn('[Threadify] No post in ThreadedPost.classes');\n      return classes;\n    }\n    \n    // Get threading CSS classes from simplified utility\n    const threadClasses = getThreadCssClasses(post);\n    console.log(`[Threadify] Adding classes to post ${post.id()}: ${threadClasses.join(', ')}`);\n    \n    threadClasses.forEach(className => {\n      classes.push(className);\n    });\n    \n    return classes;\n  });\n}\n\n/**\n * Get thread metadata for a post\n * \n * Extracts useful threading metadata from a post that can be used\n * by other components or for debugging purposes.\n * \n * @param {Post} post - The post to extract metadata from\n * @param {Post[]} allPosts - All posts in the discussion\n * @returns {Object} - Thread metadata object\n */\nexport function getPostThreadMetadata(post, allPosts) {\n  if (!post) return null;\n  \n  const parentId = post.attribute('parent_id');\n  const parentPost = parentId ? allPosts.find(p => p && p.id() == parentId) : null;\n  \n  // Find direct children of this post\n  const children = allPosts.filter(p => \n    p && p.attribute('parent_id') == post.id()\n  );\n  \n  // Calculate some thread statistics\n  const descendants = getDescendantCount(post, allPosts);\n  \n  return {\n    postId: post.id(),\n    parentId: parentId,\n    hasParent: !!parentPost,\n    parentPost: parentPost,\n    directChildren: children,\n    childrenCount: children.length,\n    descendantCount: descendants,\n    isRootPost: !parentId,\n    threadClasses: getThreadCssClasses(post, allPosts)\n  };\n}\n\n/**\n * Count all descendants (children, grandchildren, etc.) of a post\n * \n * @param {Post} post - The post to count descendants for\n * @param {Post[]} allPosts - All posts in the discussion\n * @returns {number} - Total number of descendants\n */\nfunction getDescendantCount(post, allPosts) {\n  const directChildren = allPosts.filter(p => \n    p && p.attribute('parent_id') == post.id()\n  );\n  \n  let count = directChildren.length;\n  \n  // Recursively count descendants of each child\n  directChildren.forEach(child => {\n    count += getDescendantCount(child, allPosts);\n  });\n  \n  return count;\n}\n\n/**\n * Check if a post is part of a specific thread branch\n * \n * Determines if a post is either a descendant or ancestor of another post.\n * Useful for highlighting related posts or collapsing thread branches.\n * \n * @param {Post} post1 - First post\n * @param {Post} post2 - Second post  \n * @param {Post[]} allPosts - All posts in the discussion\n * @returns {boolean} - True if posts are in the same thread branch\n */\nexport function arePostsInSameBranch(post1, post2, allPosts) {\n  if (!post1 || !post2 || post1.id() === post2.id()) {\n    return false;\n  }\n  \n  // Check if post1 is an ancestor of post2\n  let currentPost = post2;\n  while (currentPost) {\n    const parentId = currentPost.attribute('parent_id');\n    if (!parentId) break;\n    \n    if (parentId == post1.id()) {\n      return true; // post1 is an ancestor of post2\n    }\n    \n    currentPost = allPosts.find(p => p && p.id() == parentId);\n  }\n  \n  // Check if post2 is an ancestor of post1\n  currentPost = post1;\n  while (currentPost) {\n    const parentId = currentPost.attribute('parent_id');\n    if (!parentId) break;\n    \n    if (parentId == post2.id()) {\n      return true; // post2 is an ancestor of post1\n    }\n    \n    currentPost = allPosts.find(p => p && p.id() == parentId);\n  }\n  \n  return false;\n}\n\n/**\n * Get the root post of a thread branch\n * \n * Traces back through parent relationships to find the root post\n * of the thread branch that contains the given post.\n * \n * @param {Post} post - The post to find the root for\n * @param {Post[]} allPosts - All posts in the discussion\n * @returns {Post|null} - The root post of the thread branch\n */\nexport function getThreadRoot(post, allPosts) {\n  if (!post) return null;\n  \n  let currentPost = post;\n  let rootPost = post;\n  \n  // Trace back through parents until we find a post with no parent\n  while (currentPost) {\n    const parentId = currentPost.attribute('parent_id');\n    if (!parentId) {\n      rootPost = currentPost;\n      break;\n    }\n    \n    const parentPost = allPosts.find(p => p && p.id() == parentId);\n    if (!parentPost) {\n      // Parent not found, current post becomes the effective root\n      rootPost = currentPost;\n      break;\n    }\n    \n    rootPost = parentPost;\n    currentPost = parentPost;\n  }\n  \n  return rootPost;\n} \n"],"names":["__webpack_require__","module","getter","__esModule","d","a","exports","definition","key","o","Object","defineProperty","enumerable","get","obj","prop","prototype","hasOwnProperty","call","flarum","core","compat","_cache","Map","getPostThreadMetadata","post","discussion","did","id","rec","discussionId","postId","entry","Number","map","getOrderRecord","depth","threadPath","isRoot","parentId","childCount","descendantCount","rootPostId","prefetchThreadOrder","opts","_coerceDid","Promise","resolve","now","Date","inflight","ts","set","force","bust","app","request","method","url","forum","attribute","then","res","order","forEach","_ref","parentPostId","isFinite","window","dispatchEvent","CustomEvent","detail","_unused","e","console","warn","getCachedOrderMap","undefined","n","String","clampDepth","x","Math","max","min","getThreadCssClasses","isInteger","_","md","guard","seen","Set","current","pid","has","add","parent","store","getById","walkDepthByParentChain","getThreadDepth","classes","push","prefParent","getDidFromComponent","ps","_ps$stream$discussion","_ps$stream","stream","getContainer","_ps$element","_ps$element2","element","classList","contains","querySelector","document","isPostItem","el","nodeType","matches","reorderOnce","container","centerFlagObj","size","waitOrderMap","posts","kids","Array","from","children","collectChildren","length","left","right","anchor","L","findIndex","R","concat","reverse","slice","filter","findPostsRange","nodes","orderMap","presentIds","dataset","movable","baseOrder","NaN","leftKnown","fill","rightKnown","last","i","_step","_iterator","_createForOfIteratorHelperLoose","done","node","value","k","count","buildNodes","target","sort","b","computeTarget","targetNodes","cur","nextEl","ref","parentNode","insertBefore","applyOrder","targetId","onceFlagObj","scrollIntoView","block","inline","_unused3","recenterIfNeeded","near","URLSearchParams","location","search","test","m","hash","match","_unused2","getNearIdFromURL","KEY","methods","__threadifyConsoleOriginal","name","bind","enabled","localStorage","getItem","setEnabled","v","setItem","threadifyLogs","enable","disable","toggle","status","original","_len","arguments","args","_key","first","indexOf","apply","extend","ReplyComposer","data","content","postMentionMatch","parseInt","isNaN","extractParentIdFromContent","parent_id","log","Post","this","attrs","threadClasses","join","className","PostStream","_this","__threadifyNearCentered","scheduled","observer","MutationObserver","muts","some","type","requestAnimationFrame","observe","childList","__threadifyDomObserver","disconnect","_unused4","DiscussionPage","DiscussionListItem","handler","addEventListener","once","passive"],"sourceRoot":""}