{"version":3,"file":"forum.js","mappings":"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","sources":["webpack://@syntaxoutlaw/flarum-ext-threadify/webpack/bootstrap","webpack://@syntaxoutlaw/flarum-ext-threadify/webpack/runtime/compat get default export","webpack://@syntaxoutlaw/flarum-ext-threadify/webpack/runtime/define property getters","webpack://@syntaxoutlaw/flarum-ext-threadify/webpack/runtime/hasOwnProperty shorthand","webpack://@syntaxoutlaw/flarum-ext-threadify/external root \"flarum.core.compat['forum/app']\"","webpack://@syntaxoutlaw/flarum-ext-threadify/external root \"flarum.core.compat['common/extend']\"","webpack://@syntaxoutlaw/flarum-ext-threadify/external root \"flarum.core.compat['forum/components/DiscussionPage']\"","webpack://@syntaxoutlaw/flarum-ext-threadify/external root \"flarum.core.compat['forum/components/DiscussionListItem']\"","webpack://@syntaxoutlaw/flarum-ext-threadify/external root \"flarum.core.compat['forum/components/Post']\"","webpack://@syntaxoutlaw/flarum-ext-threadify/./src/forum/utils/ThreadsApi.js","webpack://@syntaxoutlaw/flarum-ext-threadify/./src/forum/utils/ThreadOrderPrefetch.js","webpack://@syntaxoutlaw/flarum-ext-threadify/./src/forum/utils/SimplifiedThreadDepth.js","webpack://@syntaxoutlaw/flarum-ext-threadify/external root \"flarum.core.compat['forum/components/ReplyComposer']\"","webpack://@syntaxoutlaw/flarum-ext-threadify/external root \"flarum.core.compat['forum/components/PostStream']\"","webpack://@syntaxoutlaw/flarum-ext-threadify/external root \"flarum.core.compat['forum/states/PostStreamState']\"","webpack://@syntaxoutlaw/flarum-ext-threadify/./src/forum/utils/ThreadTree.js","webpack://@syntaxoutlaw/flarum-ext-threadify/./src/forum/utils/ThreadDepth.js","webpack://@syntaxoutlaw/flarum-ext-threadify/./src/forum/utils/PostLoader.js","webpack://@syntaxoutlaw/flarum-ext-threadify/./src/forum/components/ThreadedPostStream.js","webpack://@syntaxoutlaw/flarum-ext-threadify/./src/forum/index.js","webpack://@syntaxoutlaw/flarum-ext-threadify/./src/forum/components/ThreadedPost.js","webpack://@syntaxoutlaw/flarum-ext-threadify/./src/forum/components/ThreadedReplyComposer.js"],"sourcesContent":["// The require scope\nvar __webpack_require__ = {};\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/app'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/extend'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/DiscussionPage'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/DiscussionListItem'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/Post'];","/**\n * Threads API Utilities\n * \n * Simple API interface for loading threaded post data from the new\n * threadify_threads table. This replaces the complex dynamic threading\n * logic with efficient pre-computed thread structures.\n * \n * @author Threadify Extension\n */\n\n/**\n * Load all threads for a discussion\n * \n * Makes a single API call to get complete thread structure with all\n * posts in proper threaded order. No complex post loading or tree\n * building needed on the frontend.\n * \n * @param {number} discussionId - The discussion ID to load threads for\n * @returns {Promise<Object[]>} - Promise resolving to array of thread objects\n */\nexport function loadDiscussionThreads(discussionId) {\n  console.log(`[Threadify] Loading threads for discussion ${discussionId}`);\n  \n  // Use Flarum's request method to call our custom API endpoint\n  return app.request({\n    method: 'GET',\n    url: app.forum.attribute('apiUrl') + '/discussions/' + discussionId + '/threads'\n  }).then(response => {\n    console.log(`[Threadify] Loaded ${response.data.length} thread entries`);\n    \n    // Process included data first to populate the store\n    if (response.included) {\n      console.log(`[Threadify] Processing ${response.included.length} included items`);\n      response.included.forEach(item => {\n        console.log(`[Threadify] Including ${item.type}:${item.id}`);\n        app.store.pushObject(item);\n      });\n    }\n    \n    // Convert thread data to posts with threading metadata\n    const threadedPosts = response.data.map(threadData => {\n      // Find the post in Flarum's store\n      const postId = threadData.attributes.postId;\n      let post = app.store.getById('posts', postId);\n      \n      if (post) {\n        // Debug: Check if post has user relationship\n        console.log(`[Threadify] Post ${postId} found, user:`, post.user ? post.user() : 'NO USER');\n        \n        // Add threading metadata to the post\n        post._threadDepth = threadData.attributes.depth;\n        post._threadPath = threadData.attributes.threadPath;\n        post._isRoot = threadData.attributes.isRoot;\n        post._childCount = threadData.attributes.childCount;\n        post._descendantCount = threadData.attributes.descendantCount;\n        post._rootPostId = threadData.attributes.rootPostId;\n        post._parentPostId = threadData.attributes.parentPostId;\n        \n        console.log(`[Threadify] Post ${postId} depth: ${post._threadDepth}, path: ${post._threadPath}`);\n      } else {\n        console.warn(`[Threadify] Post ${postId} not found in store`);\n      }\n      \n      return post;\n    }).filter(post => post !== null); // Filter out any null posts\n    \n    console.log(`[Threadify] Processed ${threadedPosts.length} threaded posts`);\n    \n    return threadedPosts;\n  }).catch(error => {\n    console.error('[Threadify] Failed to load discussion threads:', error);\n    \n    // Fallback: return empty array - existing PostStream will handle this gracefully\n    return [];\n  });\n}\n\n/**\n * Check if threads API is available for a discussion\n * \n * @param {Discussion} discussion - The discussion to check\n * @returns {boolean} - True if threads API should be used\n */\nexport function shouldUseThreadsApi(discussion) {\n  // For now, always try to use the threads API\n  // In the future, this could be configurable or based on discussion settings\n  return true;\n}\n\n/**\n * Get thread metadata for a post\n * \n * Extracts threading information that was added by loadDiscussionThreads\n * \n * @param {Post} post - The post to get metadata for\n * @returns {Object|null} - Thread metadata or null if not available\n */\nexport function getPostThreadMetadata(post) {\n  if (!post || typeof post._threadDepth === 'undefined') {\n    return null;\n  }\n  \n  return {\n    depth: post._threadDepth,\n    threadPath: post._threadPath,\n    isRoot: post._isRoot,\n    childCount: post._childCount,\n    descendantCount: post._descendantCount,\n    rootPostId: post._rootPostId\n  };\n}\n\n/**\n * Check if a post has threading metadata\n * \n * @param {Post} post - The post to check\n * @returns {boolean} - True if post has threading metadata\n */\nexport function hasThreadMetadata(post) {\n  return post && typeof post._threadDepth !== 'undefined';\n} ","/**\n * 轻量顺序预取：/discussions/:id/threads-order\n * 提供：\n *  - prefetchThreadOrder(did) -> Promise<void>\n *  - getOrderIndex(did, postId) -> number|undefined\n *  - getDepth(did, postId) / getParentId(did, postId)\n */\n\nconst _cache = new Map(); // did -> { map: Map<postId, {order, depth, parentId}>, ready: Promise }\n\nexport function prefetchThreadOrder(discussionId) {\n  const did = String(discussionId);\n  if (_cache.has(did) && _cache.get(did).ready) return _cache.get(did).ready;\n\n  const entry = { map: new Map(), ready: null };\n  _cache.set(did, entry);\n\n  entry.ready = app.request({\n    method: 'GET',\n    url: `${app.forum.attribute('apiUrl')}/discussions/${did}/threads-order`,\n  }).then((res) => {\n    const map = new Map();\n    (res.order || []).forEach(({ postId, order, depth, parentPostId }) => {\n      map.set(Number(postId), { order: Number(order), depth: Number(depth), parentId: parentPostId ? Number(parentPostId) : null });\n    });\n    entry.map = map;\n    m.redraw(); // 预取完成后让可见列表按顺序重绘（通常很快）\n  }).catch((e) => {\n    console.warn('[Threadify] order prefetch failed', e);\n  });\n\n  return entry.ready;\n}\n\nexport function getOrderIndex(discussionId, postId) {\n  const entry = _cache.get(String(discussionId));\n  if (!entry || !entry.map) return undefined;\n  const rec = entry.map.get(Number(postId));\n  return rec ? rec.order : undefined;\n}\n\nexport function getDepthPrefetched(discussionId, postId) {\n  const entry = _cache.get(String(discussionId));\n  if (!entry || !entry.map) return undefined;\n  const rec = entry.map.get(Number(postId));\n  return rec ? rec.depth : undefined;\n}\n\nexport function getParentPrefetched(discussionId, postId) {\n  const entry = _cache.get(String(discussionId));\n  if (!entry || !entry.map) return undefined;\n  const rec = entry.map.get(Number(postId));\n  return rec ? rec.parentId : undefined;\n}\n","/**\n * Simplified Thread Depth Utilities (fixed)\n *\n * 优先级：\n *  1) /threads-order 预取的 depth\n *  2) /threads 元数据里的 _threadDepth\n *  3) 本地沿 parent_id 向上爬链计算\n *\n * 始终返回 0..MAX_DISPLAY_DEPTH，且不会抛错。\n */\n\nimport { getPostThreadMetadata } from './ThreadsApi';\nimport { getDepthPrefetched, getParentPrefetched } from './ThreadOrderPrefetch';\n\nconst MAX_DISPLAY_DEPTH = 10;\n\n/** ---- helpers ---- */\nfunction clampDepth(n) {\n  const x = Number(n);\n  return Number.isFinite(x) ? Math.max(0, Math.min(MAX_DISPLAY_DEPTH, x)) : 0;\n}\n\nfunction walkDepthByParentChain(post) {\n  // 沿 parent_id 向上爬；即便父帖未加载也能给出“已知最大深度”\n  let depth = 0;\n  let guard = 0;\n  const seen = new Set();\n\n  let current = post;\n  while (current && guard < 100) {\n    const pid = current.attribute ? current.attribute('parent_id') : null;\n    if (!pid) break;\n\n    // 循环保护\n    if (seen.has(pid)) {\n      console.warn('[Threadify] cycle detected while walking parents of', post && post.id && post.id());\n      depth = 0;\n      break;\n    }\n    seen.add(pid);\n\n    depth += 1;\n    // 试着从 store 取父贴，取不到就以当前深度作准（父贴可能尚未加载）\n    const parent = app.store.getById('posts', String(pid));\n    if (!parent) break;\n\n    current = parent;\n    guard++;\n    if (depth >= MAX_DISPLAY_DEPTH) break;\n  }\n  return clampDepth(depth);\n}\n\n/** ---- public API ---- */\n\n/**\n * Get thread depth for a post (0=root)\n */\nexport function getThreadDepth(post) {\n  if (!post || typeof post.id !== 'function') return 0;\n\n  // 1) 预取顺序里的 depth（最快、最稳定）\n  try {\n    const did =\n      (post.discussion && typeof post.discussion === 'function' && post.discussion() && post.discussion().id && post.discussion().id()) ||\n      null;\n    if (did != null) {\n      const d = getDepthPrefetched(did, post.id());\n      if (Number.isInteger(d)) return clampDepth(d);\n    }\n  } catch (_) {\n    // ignore\n  }\n\n  // 2) /threads 元数据（若前端曾调用过 loadDiscussionThreads）\n  try {\n    const md = getPostThreadMetadata(post);\n    if (md && Number.isInteger(md.depth)) return clampDepth(md.depth);\n  } catch (_) {\n    // ignore\n  }\n\n  // 3) 本地按 parent_id 向上爬链\n  return walkDepthByParentChain(post);\n}\n\n/**\n * CSS classes for a post based on its thread depth.\n * 统一使用：threaded-post / thread-root / thread-depth-N / thread-deep / thread-very-deep\n */\nexport function getThreadCssClasses(post) {\n  const depth = getThreadDepth(post);\n  const classes = [];\n\n  if (depth > 0) {\n    classes.push('threaded-post');\n    classes.push(`thread-depth-${depth}`);\n    if (depth >= 3) classes.push('thread-deep');\n    if (depth >= 5) classes.push('thread-very-deep');\n  } else {\n    classes.push('thread-root');\n  }\n\n  // 尽量从预取或元数据补充“根/父”信息（可选）\n  try {\n    const did =\n      (post.discussion && typeof post.discussion === 'function' && post.discussion() && post.discussion().id && post.discussion().id()) ||\n      null;\n    const prefParent = did != null ? getParentPrefetched(did, post.id()) : undefined;\n    const md = getPostThreadMetadata(post);\n\n    const isRoot =\n      (prefParent === null || prefParent === undefined) ?\n        (!post.attribute || !post.attribute('parent_id')) :\n        (prefParent == null);\n\n    if (isRoot) classes.push('thread-root-confirmed');\n\n    // 可根据 md.childCount / md.descendantCount 再加细化类名（没有就跳过）\n    if (md && Number.isInteger(md.childCount) && md.childCount > 0) {\n      classes.push('has-children', `child-count-${Math.min(md.childCount, 10)}`);\n    }\n    if (md && Number.isInteger(md.descendantCount) && md.descendantCount > 0) {\n      classes.push('has-descendants');\n    }\n  } catch (_) {\n    // 忽略补充信息失败\n  }\n\n  return classes;\n}\n\n/** convenience helpers */\nexport function isRootPost(post) {\n  return getThreadDepth(post) === 0;\n}\n\nexport function getThreadRootId(/* post */) {\n  // 若后续需要，可接入预取 map 里的 rootId；当前仅用于样式则不强制实现\n  return null;\n}\n\nexport function getChildCount(post) {\n  const md = getPostThreadMetadata(post);\n  return md && Number.isInteger(md.childCount) ? md.childCount : 0;\n}\n\nexport function getDescendantCount(post) {\n  const md = getPostThreadMetadata(post);\n  return md && Number.isInteger(md.descendantCount) ? md.descendantCount : 0;\n}\n\nexport function getThreadPath(post) {\n  const md = getPostThreadMetadata(post);\n  return md ? md.threadPath || null : null;\n}\n","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/ReplyComposer'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/PostStream'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/states/PostStreamState'];","/**\n * Thread Tree Utilities\n * \n * Handles building and flattening thread tree structures from Flarum posts.\n * This module is responsible for:\n * - Building hierarchical thread structures from flat post arrays\n * - Flattening thread trees back to linear arrays in threaded order\n * - Maintaining parent-child relationships between posts\n * \n * @author Threadify Extension\n */\n\n/**\n * Build a threaded tree structure from posts\n * \n * Takes a flat array of posts and organizes them into a hierarchical tree\n * structure based on their parent_id attributes. Posts without a parent_id\n * become root posts, while posts with parent_id become children of their\n * respective parents.\n * \n * @param {Post[]} posts - All posts in the discussion\n * @returns {Post[]} - Array of root posts with _threadChildren attached\n */\nexport function buildThreadTree(posts) {\n  const tree = [];\n  const postMap = new Map();\n  const childrenMap = new Map();\n  \n  // First pass: create post map and initialize children arrays\n  posts.forEach(post => {\n    if (!post) return;\n    \n    const postId = post.id();\n    postMap.set(postId, post);\n    childrenMap.set(postId, []);\n  });\n  \n  // Second pass: organize posts by parent-child relationships\n  posts.forEach(post => {\n    if (!post) return;\n    \n    const postId = post.id();\n    const parentId = post.attribute('parent_id');\n    \n    if (parentId && postMap.has(String(parentId))) {\n      // This post has a parent, add it to parent's children\n      childrenMap.get(String(parentId)).push(post);\n    } else {\n      // This is a root post (no parent or parent not found)\n      tree.push(post);\n    }\n  });\n  \n  // Third pass: attach children to posts for easy access\n  posts.forEach(post => {\n    if (!post) return;\n    post._threadChildren = childrenMap.get(post.id()) || [];\n  });\n  \n  return tree;\n}\n\n/**\n * Flatten thread tree back to linear array in threaded order\n * \n * Takes a hierarchical tree of posts and flattens it back to a linear array\n * while maintaining the threaded order (parent followed by all its children\n * recursively). This preserves the threading visual structure when posts\n * are rendered linearly.\n * \n * @param {Post[]} rootPosts - Root posts with their children attached via _threadChildren\n * @returns {Post[]} - Flattened array in threaded order\n */\nexport function flattenThreadTree(rootPosts) {\n  const result = [];\n  \n  /**\n   * Recursively add a post and all its children to the result array\n   * @param {Post} post - The post to add\n   * @param {number} depth - Current nesting depth (for potential future use)\n   */\n  function addPostAndChildren(post, depth = 0) {\n    if (!post) return;\n    \n    result.push(post);\n    \n    // Get children and sort them chronologically within each thread level\n    const children = post._threadChildren || [];\n    children.sort((a, b) => {\n      const timeA = a.createdAt ? a.createdAt().getTime() : 0;\n      const timeB = b.createdAt ? b.createdAt().getTime() : 0;\n      return timeA - timeB;\n    });\n    \n    // Recursively add all children\n    children.forEach(child => {\n      addPostAndChildren(child, depth + 1);\n    });\n  }\n  \n  // Sort root posts chronologically to maintain discussion flow\n  rootPosts.sort((a, b) => {\n    const timeA = a.createdAt ? a.createdAt().getTime() : 0;\n    const timeB = b.createdAt ? b.createdAt().getTime() : 0;\n    return timeA - timeB;\n  });\n  \n  // Add each root post and its entire thread branch\n  rootPosts.forEach(rootPost => {\n    addPostAndChildren(rootPost);\n  });\n  \n  return result;\n}\n\n/**\n * Create a threaded post array from flat posts\n * \n * Convenience function that combines buildThreadTree and flattenThreadTree\n * to convert a flat array of posts directly into threaded order.\n * \n * @param {Post[]} posts - Flat array of posts\n * @returns {Post[]} - Posts reordered in threaded structure\n */\nexport function createThreadedPosts(posts) {\n  const threadTree = buildThreadTree(posts);\n  return flattenThreadTree(threadTree);\n} ","/**\n * Thread Depth Calculator\n * \n * Handles calculating and caching thread depth for posts.\n * Thread depth determines how many levels deep a post is in a thread\n * (0 = root post, 1 = direct reply, 2 = reply to reply, etc.)\n * \n * Uses caching to avoid expensive recalculations and includes cycle detection\n * to prevent infinite loops in case of malformed parent relationships.\n * \n * @author Threadify Extension\n */\n\n// Cache for thread depth calculations to avoid recalculating\nconst threadDepthCache = new Map();\n\n// Maximum allowed thread depth to prevent excessive UI indentation\nconst MAX_THREAD_DEPTH = 10;\n\n/**\n * Calculate the thread depth of a post\n * \n * Determines how many levels deep a post is in the thread hierarchy.\n * Uses caching for performance and includes cycle detection for safety.\n * \n * @param {Post} post - The post to calculate depth for\n * @param {Post[]} allPosts - All posts in the discussion (for parent lookup)\n * @returns {number} - The depth (0 = root, 1 = direct reply, etc.)\n */\nexport function calculateThreadDepth(post, allPosts) {\n  const postId = post.id();\n  \n  // Check cache first for performance\n  if (threadDepthCache.has(postId)) {\n    return threadDepthCache.get(postId);\n  }\n  \n  // If no parent_id, this is a root post (depth 0)\n  const parentId = post.attribute('parent_id');\n  if (!parentId) {\n    threadDepthCache.set(postId, 0);\n    return 0;\n  }\n  \n  // Find the parent post\n  const parentPost = allPosts.find(p => p && p.id() == parentId);\n  if (!parentPost) {\n    // Parent not found, treat as root\n    threadDepthCache.set(postId, 0);\n    return 0;\n  }\n  \n  // Cycle detection: if we're calculating depth for a post that's already\n  // in our calculation chain, we have a cycle\n  const visited = new Set();\n  const depth = calculateDepthRecursive(post, allPosts, visited);\n  \n  // Cache and return the calculated depth\n  threadDepthCache.set(postId, depth);\n  return depth;\n}\n\n/**\n * Recursive helper for depth calculation with cycle detection\n * @param {Post} post - Current post\n * @param {Post[]} allPosts - All posts for parent lookup\n * @param {Set} visited - Set of visited post IDs to detect cycles\n * @returns {number} - Calculated depth\n */\nfunction calculateDepthRecursive(post, allPosts, visited) {\n  const postId = post.id();\n  \n  // Cycle detection\n  if (visited.has(postId)) {\n    console.warn(`[Threadify] Cycle detected for post ${postId}`);\n    return 0; // Treat cyclic posts as root to break the cycle\n  }\n  \n  // Check cache\n  if (threadDepthCache.has(postId)) {\n    return threadDepthCache.get(postId);\n  }\n  \n  // If no parent, this is root level\n  const parentId = post.attribute('parent_id');\n  if (!parentId) {\n    return 0;\n  }\n  \n  // Find parent post\n  const parentPost = allPosts.find(p => p && p.id() == parentId);\n  if (!parentPost) {\n    return 0; // Parent not found, treat as root\n  }\n  \n  // Add current post to visited set\n  visited.add(postId);\n  \n  // Recursively calculate parent's depth\n  const parentDepth = calculateDepthRecursive(parentPost, allPosts, visited);\n  const depth = parentDepth + 1;\n  \n  // Remove from visited set (backtrack)\n  visited.delete(postId);\n  \n  // Apply maximum depth limit to prevent excessive UI indentation\n  return Math.min(depth, MAX_THREAD_DEPTH);\n}\n\n/**\n * Clear the thread depth cache\n * \n * Should be called when posts are updated, removed, or when switching discussions\n * to ensure fresh calculations.\n */\nexport function clearThreadDepthCache() {\n  threadDepthCache.clear();\n}\n\n/**\n * Get CSS classes for a post based on its thread depth\n * \n * Generates appropriate CSS classes for styling threaded posts.\n * \n * @param {Post} post - The post to generate classes for\n * @param {Post[]} allPosts - All posts in the discussion\n * @returns {string[]} - Array of CSS classes\n */\nexport function getThreadCssClasses(post, allPosts) {\n  const threadDepth = calculateThreadDepth(post, allPosts);\n  const classes = [];\n  \n  if (threadDepth > 0) {\n    classes.push('Post--threaded');\n    classes.push(`Post--thread-depth-${threadDepth}`);\n  }\n  \n  return classes;\n}\n\n/**\n * Check if a post is a root post (no parent)\n * @param {Post} post - The post to check\n * @returns {boolean} - True if the post is a root post\n */\nexport function isRootPost(post) {\n  return !post.attribute('parent_id');\n}\n\n/**\n * Check if a post is a direct reply (depth 1)\n * @param {Post} post - The post to check\n * @param {Post[]} allPosts - All posts in the discussion\n * @returns {boolean} - True if the post is a direct reply\n */\nexport function isDirectReply(post, allPosts) {\n  return calculateThreadDepth(post, allPosts) === 1;\n} ","/**\n * Post Loader Utilities (fixed for Flarum 1.8)\n *\n * 修复点：\n * 1) 统一使用字符串比较 ID，避免 number/string 混用造成的漏判。\n * 2) 兼容 postStream.discussion 与 postStream.stream.discussion。\n * 3) 提供 mergeUniquePostsById 以防重复注入同一帖子。\n */\n\nimport app from 'flarum/forum/app';\n\n/** -------------------- Helpers -------------------- **/\n\nfunction toStrId(x) {\n  return x == null ? '' : String(x);\n}\n\nfunction getDiscussionFrom(postStream) {\n  // 兼容两种拿法\n  return postStream?.discussion || postStream?.stream?.discussion || null;\n}\n\nfunction mergeUniquePostsById(basePosts, extraPosts) {\n  const map = new Map();\n  basePosts.filter(Boolean).forEach((p) => map.set(toStrId(p.id()), p));\n  extraPosts.filter(Boolean).forEach((p) => map.set(toStrId(p.id()), p));\n  return Array.from(map.values());\n}\n\nfunction loadPostsByIds(postIds) {\n  const ids = (postIds || []).map(toStrId).filter(Boolean);\n  if (ids.length === 0) return Promise.resolve([]);\n\n  return app.store.find('posts', {\n    filter: { id: ids.join(',') },\n    // page: { limit: ids.length } // 可选：限制体积\n  });\n}\n\n/** -------------------- Public APIs -------------------- **/\n\n/**\n * 递归补齐“缺失父帖”\n * - 扫描 currentPosts，找出其 parent_id 未在集合中的父帖，批量拉取；\n * - 合并后若仍有更上层父帖缺失，则继续递归，直到根或已齐全。\n */\nexport function loadMissingParentPosts(postStream, currentPosts) {\n  const posts = (currentPosts || []).filter(Boolean);\n  const currentIdSet = new Set(posts.map((p) => toStrId(p.id())));\n  const missingParentIds = [];\n\n  posts.forEach((p) => {\n    const pid = toStrId(p?.attribute?.('parent_id'));\n    if (pid && !currentIdSet.has(pid)) missingParentIds.push(pid);\n  });\n\n  const uniqueMissing = Array.from(new Set(missingParentIds));\n  if (uniqueMissing.length === 0) {\n    return Promise.resolve(posts);\n  }\n\n  return loadPostsByIds(uniqueMissing)\n    .then((loadedParents) => {\n      const merged = mergeUniquePostsById(posts, loadedParents);\n      // 递归，直到没有缺父帖\n      return loadMissingParentPosts(postStream, merged);\n    })\n    .catch((err) => {\n      console.warn('[Threadify] Failed to load parent posts:', err);\n      // 出错时保守返回已有帖子，避免卡住\n      return posts;\n    });\n}\n\n/**\n * 仅“保守”补少量子帖\n * - 按讨论里尚未加载的 postId 取一个小样本（默认 5~10）；\n * - 只把其 parent_id 指向“当前已加载集合”的帖子作为“实际子帖”纳入；\n * - 不递归，避免二次抖动。\n */\nexport function loadMinimalChildren(postStream, currentPosts) {\n  const discussion = getDiscussionFrom(postStream);\n  const posts = (currentPosts || []).filter(Boolean);\n  const currentIdSet = new Set(posts.map((p) => toStrId(p.id())));\n\n  if (!discussion || typeof discussion.postIds !== 'function') {\n    return Promise.resolve(posts);\n  }\n\n  const discussionPostIds = (discussion.postIds() || []).map(toStrId);\n  const unloadedIds = discussionPostIds.filter((id) => id && !currentIdSet.has(id));\n\n  if (unloadedIds.length === 0) {\n    return Promise.resolve(posts);\n  }\n\n  const sampleSize = Math.min(10, unloadedIds.length); // 轻量探测\n  const recentUnloaded = unloadedIds.slice(-sampleSize);\n\n  return loadPostsByIds(recentUnloaded)\n    .then((loadedSample) => {\n      // 只收“父在集合里”的实际子帖\n      const actualChildren = (loadedSample || []).filter((p) => {\n        const pid = toStrId(p?.attribute?.('parent_id'));\n        return pid && currentIdSet.has(pid);\n      });\n\n      if (actualChildren.length === 0) {\n        return posts;\n      }\n      return mergeUniquePostsById(posts, actualChildren);\n    })\n    .catch((err) => {\n      console.warn('[Threadify] Failed to load child posts:', err);\n      return posts;\n    });\n}\n\n/**\n * 检测是否“有理由补上下文”\n * - 目前仅检测是否存在缺失父帖；如需可扩展。\n */\nexport function needsThreadContext(posts) {\n  const arr = (posts || []).filter(Boolean);\n  if (arr.length === 0) return false;\n\n  const idSet = new Set(arr.map((p) => toStrId(p.id())));\n  return arr.some((p) => {\n    const pid = toStrId(p?.attribute?.('parent_id'));\n    return pid && !idSet.has(pid);\n  });\n}\n","import app from 'flarum/forum/app';\nimport { extend, override } from 'flarum/common/extend';\nimport PostStream from 'flarum/forum/components/PostStream';\nimport PostStreamState from 'flarum/forum/states/PostStreamState';\n\nimport { createThreadedPosts } from '../utils/ThreadTree';\nimport { clearThreadDepthCache } from '../utils/ThreadDepth';\nimport { loadMissingParentPosts, loadMinimalChildren } from '../utils/PostLoader';\nimport { prefetchThreadOrder, getOrderIndex } from '../utils/ThreadOrderPrefetch';\n\n// —— 全局状态 —— //\nlet isReordering = false;\nlet reorderedPostsCache = null;\nlet originalPostsMethod = null;\nlet lastPostCount = 0;\nlet currentDiscussionId = null;\n\n// 分页期间：彻底暂停线程化（返回原生 posts），避免 anchorScroll 取不到锚点\nlet suspendThreading = false;\nlet rebuildPending = false;\n\n// 轻量补充：补父 / 少量子（可开关）\nconst enableMinimalChildLoading = true;\n\nexport function initThreadedPostStream() {\n  // 在分页开始/结束时切换“暂停重排”标志，并在结束后补做一次重排\n  override(PostStreamState.prototype, '_loadPrevious', function (original, ...args) {\n    suspendThreading = true;\n    const p = original(...args);\n    return Promise.resolve(p).finally(() => {\n      suspendThreading = false;\n      if (rebuildPending) {\n        rebuildPending = false;\n        const ps = this.discussion && this.discussion.postStream ? this.discussion.postStream : null;\n        if (ps) scheduleRebuild(ps);\n      }\n    });\n  });\n\n  override(PostStreamState.prototype, '_loadNext', function (original, ...args) {\n    suspendThreading = true;\n    const p = original(...args);\n    return Promise.resolve(p).finally(() => {\n      suspendThreading = false;\n      if (rebuildPending) {\n        rebuildPending = false;\n        const ps = this.discussion && this.discussion.postStream ? this.discussion.postStream : null;\n        if (ps) scheduleRebuild(ps);\n      }\n    });\n  });\n\n  // 绑定 PostStream 生命周期\n  extend(PostStream.prototype, 'oninit', function () {\n    const did = this.stream && this.stream.discussion && this.stream.discussion.id();\n    if (currentDiscussionId !== did) resetState(did);\n\n    if (did) prefetchThreadOrder(did);          // 首帧预取全局顺序（非常轻）\n\n    if (!originalPostsMethod) originalPostsMethod = this.stream.posts;\n\n    // 覆盖 posts()：分页中直接返回原生 posts；平时优先返回缓存\n    this.stream.posts = () => {\n      if (suspendThreading) {\n        // 分页期：完全回退到原生顺序，保障 anchorScroll\n        return originalPostsMethod.call(this.stream) || [];\n      }\n      if (reorderedPostsCache) return reorderedPostsCache;\n\n      const original = originalPostsMethod.call(this.stream) || [];\n      // 初载且有内容时拉起一次重排（异步，不阻断首帧）\n      if (!isReordering && original.filter(Boolean).length > 0) {\n        scheduleRebuild(this);\n      }\n      return original;\n    };\n\n    // 记录当前帖子数\n    const cur = originalPostsMethod.call(this.stream) || [];\n    lastPostCount = cur.filter(Boolean).length;\n\n    // 首帧尽量重排（若不在分页中）\n    if (lastPostCount > 0 && !suspendThreading) scheduleRebuild(this);\n  });\n\n  extend(PostStream.prototype, 'oncreate', function () {\n    clearThreadDepthCache();\n  });\n\n  // 帖子数变化：分页中仅做标记，结束后补排；非分页立即重排\n  extend(PostStream.prototype, 'onupdate', function () {\n    if (!originalPostsMethod) return;\n    const current = originalPostsMethod.call(this.stream) || [];\n    const count = current.filter(Boolean).length;\n\n    if (count !== lastPostCount) {\n      lastPostCount = count;\n      reorderedPostsCache = null;\n      clearThreadDepthCache();\n\n      if (suspendThreading) {\n        rebuildPending = true;\n      } else {\n        scheduleRebuild(this);\n      }\n    }\n  });\n}\n\n// ========== 重排主流程 ========== //\n\nfunction scheduleRebuild(postStream) {\n  // 避免同步阻塞渲染\n  setTimeout(() => updateReorderedCache(postStream), 0);\n}\n\nfunction updateReorderedCache(postStream) {\n  if (isReordering) return;\n  if (suspendThreading) {\n    rebuildPending = true;\n    return;\n  }\n  isReordering = true;\n\n  try {\n    if (!originalPostsMethod) return finish(null);\n\n    const originalPosts = originalPostsMethod.call(postStream.stream) || [];\n    const valid = originalPosts.filter(Boolean);\n    if (valid.length === 0) return finish(null);\n\n    ensureParentsLoaded(postStream, valid)\n      .then((postsWithParents) =>\n        enableMinimalChildLoading\n          ? ensureMinimalChildren(postStream, postsWithParents)\n          : postsWithParents\n      )\n      .then((postsReady) => {\n        const did = postStream.stream && postStream.stream.discussion && postStream.stream.discussion.id();\n\n        // —— 优先按 /threads-order 预取顺序排序 —— //\n        const orderOf = (p) => {\n          const id = p && p.id ? p.id() : null;\n          if (!id) return null;\n          const idx = getOrderIndex(did, id);\n          return Number.isInteger(idx) ? idx : null;\n        };\n\n        let sorted;\n        const hasAnyOrder = postsReady.some((p) => orderOf(p) !== null);\n\n        if (hasAnyOrder) {\n          sorted = postsReady.slice().sort((a, b) => {\n            const ao = orderOf(a);\n            const bo = orderOf(b);\n            if (ao == null && bo == null) return 0;\n            if (ao == null) return 1;\n            if (bo == null) return -1;\n            return ao - bo;\n          });\n        } else {\n          // 退回本地“父后跟子”的轻量线程化\n          sorted = createThreadedPosts(postsReady);\n        }\n\n        const threadedArray = padToOriginalLength(originalPosts, sorted);\n        finish(threadedArray);\n      })\n      .catch((err) => {\n        console.warn('[Threadify] reorder fallback due to error:', err);\n        const fallback = createThreadedPosts(valid);\n        const threadedArray = padToOriginalLength(originalPosts, fallback);\n        finish(threadedArray);\n      });\n  } catch (e) {\n    console.error('[Threadify] Cache update failed:', e);\n    finish(null);\n  }\n\n  function finish(arr) {\n    reorderedPostsCache = arr;         // 允许为 null：上层会回退原数组\n    isReordering = false;\n    setTimeout(() => m.redraw(), 0);\n  }\n}\n\nfunction padToOriginalLength(originalPosts, threadedPosts) {\n  if (!Array.isArray(threadedPosts) || threadedPosts.length === 0) return originalPosts;\n  const result = [...threadedPosts];\n  const need = Math.max(0, originalPosts.length - threadedPosts.length);\n  for (let i = 0; i < need; i++) result.push(null); // 只补 null，绝不返回 undefined\n  return result;\n}\n\n// —— 按需补父/少量子（失败即原样返回） —— //\nfunction ensureParentsLoaded(postStream, posts) {\n  if (typeof loadMissingParentPosts === 'function') {\n    const ctx = postStream.discussion ? postStream : { discussion: postStream.stream.discussion };\n    return loadMissingParentPosts(ctx, posts).catch(() => Promise.resolve(posts));\n  }\n  return Promise.resolve(posts);\n}\nfunction ensureMinimalChildren(postStream, posts) {\n  if (typeof loadMinimalChildren === 'function') {\n    const ctx = postStream.discussion ? postStream : { discussion: postStream.stream.discussion };\n    return loadMinimalChildren(ctx, posts).catch(() => Promise.resolve(posts));\n  }\n  return Promise.resolve(posts);\n}\n\n// —— 切讨论时复位 —— //\nfunction resetState(discussionId) {\n  currentDiscussionId = discussionId;\n  isReordering = false;\n  reorderedPostsCache = null;\n  originalPostsMethod = null;\n  lastPostCount = 0;\n  suspendThreading = false;\n  rebuildPending = false;\n  clearThreadDepthCache();\n}\n\n// Debug（可选）\nexport function getThreadedPostsCache() { return reorderedPostsCache; }\nexport function forceRebuildCache(ps) { reorderedPostsCache = null; clearThreadDepthCache(); scheduleRebuild(ps); }\nexport function isThreadingActive() { return !!(reorderedPostsCache && originalPostsMethod); }\nexport function getThreadingStats() {\n  return {\n    hasCachedPosts: !!reorderedPostsCache,\n    cachedPostCount: reorderedPostsCache ? reorderedPostsCache.filter(Boolean).length : 0,\n    isReordering, lastPostCount, suspendThreading, rebuildPending, discussionId: currentDiscussionId,\n    hasOriginalMethod: !!originalPostsMethod,\n  };\n}\n","// js/src/forum/index.js\nimport app from 'flarum/forum/app';\nimport { extend } from 'flarum/common/extend';\n\nimport DiscussionPage from 'flarum/forum/components/DiscussionPage';\nimport DiscussionListItem from 'flarum/forum/components/DiscussionListItem';\n\nimport { initThreadedPost } from './components/ThreadedPost';\nimport { initThreadedReplyComposer } from './components/ThreadedReplyComposer';\nimport { initThreadedPostStream } from './components/ThreadedPostStream';\nimport { prefetchThreadOrder } from './utils/ThreadOrderPrefetch';\n\n/**\n * 日志控制（默认屏蔽，可在控制台开启）\n * 仅影响以 \"[Threadify]\" 开头的日志；其余 console 输出不受影响。\n */\n(function setupThreadifyLoggingToggle() {\n  const NS = '[Threadify]';\n  const KEY = 'threadify:logs';\n  const methods = ['log', 'info', 'warn', 'debug', 'error'];\n\n  // 避免多次包裹\n  if (!window.__threadifyConsoleOriginal) {\n    window.__threadifyConsoleOriginal = {};\n    methods.forEach((name) => {\n      window.__threadifyConsoleOriginal[name] =\n        console[name] ? console[name].bind(console) : () => {};\n    });\n  }\n\n  // 默认关闭；读取本地持久化状态\n  const persisted =\n    typeof localStorage !== 'undefined' ? localStorage.getItem(KEY) : null;\n  let enabled = persisted === '1';\n\n  // 应用包裹\n  function applyWrap() {\n    methods.forEach((name) => {\n      const original = window.__threadifyConsoleOriginal[name];\n      console[name] = (...args) => {\n        const first = args && args[0];\n        const isThreadifyMsg = typeof first === 'string' && first.indexOf(NS) === 0;\n        if (isThreadifyMsg && !enabled) return; // 屏蔽本扩展日志\n        return original(...args);\n      };\n    });\n  }\n\n  function setEnabled(v) {\n    enabled = !!v;\n    if (typeof localStorage !== 'undefined') {\n      localStorage.setItem(KEY, enabled ? '1' : '0');\n    }\n  }\n\n  // 暴露可切换的控制器到全局（控制台使用）\n  window.threadifyLogs = {\n    enable() {\n      setEnabled(true);\n      return 'Threadify logs: ON';\n    },\n    disable() {\n      setEnabled(false);\n      return 'Threadify logs: OFF';\n    },\n    toggle() {\n      setEnabled(!enabled);\n      return `Threadify logs: ${enabled ? 'ON' : 'OFF'}`;\n    },\n    status() {\n      return enabled;\n    },\n  };\n\n  applyWrap();\n})();\n\napp.initializers.add('syntaxoutlaw-threadify', () => {\n  // 样式/行为初始化\n  initThreadedPost();\n  initThreadedReplyComposer();\n  initThreadedPostStream();\n\n  // 进入讨论页即预取顺序\n  extend(DiscussionPage.prototype, 'oninit', function () {\n    const did =\n      (this.discussion && typeof this.discussion.id === 'function' && this.discussion.id()) ||\n      (this.discussion && this.discussion.id) ||\n      null;\n    if (did) prefetchThreadOrder(did);\n  });\n\n  // 讨论列表项：首个鼠标悬停/触摸即预取，提升命中率\n  extend(DiscussionListItem.prototype, 'oncreate', function () {\n    const discussion = this.attrs.discussion;\n    if (!discussion) return;\n    const did = discussion.id();\n    const handler = () => prefetchThreadOrder(did);\n\n    if (this.element) {\n      this.element.addEventListener('mouseenter', handler, { once: true });\n      this.element.addEventListener('touchstart', handler, { once: true, passive: true });\n    }\n  });\n});\n","/**\n * Threaded Post Component Extensions\n * \n * Handles Post component extensions for threading functionality.\n * This module is responsible for:\n * - Adding threading CSS classes to posts based on their depth\n * - Managing post-specific threading visual elements\n * - Integrating with the ThreadDepth utility for depth calculations\n * \n * @author Threadify Extension\n */\n\nimport { extend } from 'flarum/common/extend';\nimport Post from 'flarum/forum/components/Post';\nimport { getThreadCssClasses } from '../utils/SimplifiedThreadDepth';\n\n/**\n * Initialize Post component extensions for threading\n * \n * Sets up all the necessary hooks and extensions for the Post component\n * to display threading information properly.\n */\nexport function initThreadedPost() {\n  // Hook into Post component to add threading CSS classes\n  extend(Post.prototype, 'classes', function(classes) {\n    const post = this.attrs.post;\n    \n    // Skip processing if we don't have a valid post\n    if (!post) {\n      console.warn('[Threadify] No post in ThreadedPost.classes');\n      return classes;\n    }\n    \n    // Get threading CSS classes from simplified utility\n    const threadClasses = getThreadCssClasses(post);\n    console.log(`[Threadify] Adding classes to post ${post.id()}: ${threadClasses.join(', ')}`);\n    \n    threadClasses.forEach(className => {\n      classes.push(className);\n    });\n    \n    return classes;\n  });\n}\n\n/**\n * Get thread metadata for a post\n * \n * Extracts useful threading metadata from a post that can be used\n * by other components or for debugging purposes.\n * \n * @param {Post} post - The post to extract metadata from\n * @param {Post[]} allPosts - All posts in the discussion\n * @returns {Object} - Thread metadata object\n */\nexport function getPostThreadMetadata(post, allPosts) {\n  if (!post) return null;\n  \n  const parentId = post.attribute('parent_id');\n  const parentPost = parentId ? allPosts.find(p => p && p.id() == parentId) : null;\n  \n  // Find direct children of this post\n  const children = allPosts.filter(p => \n    p && p.attribute('parent_id') == post.id()\n  );\n  \n  // Calculate some thread statistics\n  const descendants = getDescendantCount(post, allPosts);\n  \n  return {\n    postId: post.id(),\n    parentId: parentId,\n    hasParent: !!parentPost,\n    parentPost: parentPost,\n    directChildren: children,\n    childrenCount: children.length,\n    descendantCount: descendants,\n    isRootPost: !parentId,\n    threadClasses: getThreadCssClasses(post, allPosts)\n  };\n}\n\n/**\n * Count all descendants (children, grandchildren, etc.) of a post\n * \n * @param {Post} post - The post to count descendants for\n * @param {Post[]} allPosts - All posts in the discussion\n * @returns {number} - Total number of descendants\n */\nfunction getDescendantCount(post, allPosts) {\n  const directChildren = allPosts.filter(p => \n    p && p.attribute('parent_id') == post.id()\n  );\n  \n  let count = directChildren.length;\n  \n  // Recursively count descendants of each child\n  directChildren.forEach(child => {\n    count += getDescendantCount(child, allPosts);\n  });\n  \n  return count;\n}\n\n/**\n * Check if a post is part of a specific thread branch\n * \n * Determines if a post is either a descendant or ancestor of another post.\n * Useful for highlighting related posts or collapsing thread branches.\n * \n * @param {Post} post1 - First post\n * @param {Post} post2 - Second post  \n * @param {Post[]} allPosts - All posts in the discussion\n * @returns {boolean} - True if posts are in the same thread branch\n */\nexport function arePostsInSameBranch(post1, post2, allPosts) {\n  if (!post1 || !post2 || post1.id() === post2.id()) {\n    return false;\n  }\n  \n  // Check if post1 is an ancestor of post2\n  let currentPost = post2;\n  while (currentPost) {\n    const parentId = currentPost.attribute('parent_id');\n    if (!parentId) break;\n    \n    if (parentId == post1.id()) {\n      return true; // post1 is an ancestor of post2\n    }\n    \n    currentPost = allPosts.find(p => p && p.id() == parentId);\n  }\n  \n  // Check if post2 is an ancestor of post1\n  currentPost = post1;\n  while (currentPost) {\n    const parentId = currentPost.attribute('parent_id');\n    if (!parentId) break;\n    \n    if (parentId == post2.id()) {\n      return true; // post2 is an ancestor of post1\n    }\n    \n    currentPost = allPosts.find(p => p && p.id() == parentId);\n  }\n  \n  return false;\n}\n\n/**\n * Get the root post of a thread branch\n * \n * Traces back through parent relationships to find the root post\n * of the thread branch that contains the given post.\n * \n * @param {Post} post - The post to find the root for\n * @param {Post[]} allPosts - All posts in the discussion\n * @returns {Post|null} - The root post of the thread branch\n */\nexport function getThreadRoot(post, allPosts) {\n  if (!post) return null;\n  \n  let currentPost = post;\n  let rootPost = post;\n  \n  // Trace back through parents until we find a post with no parent\n  while (currentPost) {\n    const parentId = currentPost.attribute('parent_id');\n    if (!parentId) {\n      rootPost = currentPost;\n      break;\n    }\n    \n    const parentPost = allPosts.find(p => p && p.id() == parentId);\n    if (!parentPost) {\n      // Parent not found, current post becomes the effective root\n      rootPost = currentPost;\n      break;\n    }\n    \n    rootPost = parentPost;\n    currentPost = parentPost;\n  }\n  \n  return rootPost;\n} \n","/**\n * Threaded Reply Composer Extensions\n * \n * Handles ReplyComposer component extensions for threading functionality.\n * This module is responsible for:\n * - Extracting parent_id from post mentions in reply content\n * - Adding parent_id to the reply data before submission\n * - Integrating with Flarum's mentions extension for seamless threading\n * \n * The threading system works by detecting post mentions in the format:\n * @\"Display Name\"#p123 where 123 is the post ID that becomes the parent_id\n * \n * @author Threadify Extension\n */\n\nimport { extend } from 'flarum/common/extend';\nimport ReplyComposer from 'flarum/forum/components/ReplyComposer';\n\n/**\n * Initialize ReplyComposer component extensions for threading\n * \n * Sets up hooks to automatically detect and add parent_id relationships\n * when users reply to specific posts using the mentions system.\n */\nexport function initThreadedReplyComposer() {\n  // Hook into reply submission to add parent_id\n  extend(ReplyComposer.prototype, 'data', function(data) {\n    const parentId = extractParentIdFromContent(data.content);\n    \n    if (parentId) {\n      // Add parent_id directly to the data object\n      data.parent_id = parentId;\n      console.log('[Threadify] Reply threading to post', parentId);\n    }\n    \n    return data;\n  });\n}\n\n/**\n * Extract parent post ID from reply content\n * \n * Parses the reply content for post mentions from the mentions extension\n * and extracts the post ID to use as parent_id for threading.\n * \n * Supported mention formats:\n * - @\"Display Name\"#p123 (standard post mention)\n * - Multiple mentions (uses the first one found)\n * \n * @param {string} content - The reply content to parse\n * @returns {number|null} - The parent post ID or null if none found\n */\nexport function extractParentIdFromContent(content) {\n  if (!content || typeof content !== 'string') {\n    return null;\n  }\n  \n  // Parse the content for post mentions from the mentions extension\n  // Format: @\"Display Name\"#p123 where 123 is the post ID\n  const postMentionMatch = content.match(/@\"[^\"]*\"#p(\\d+)/);\n  \n  if (postMentionMatch && postMentionMatch[1]) {\n    const parentId = parseInt(postMentionMatch[1], 10);\n    \n    // Validate that it's a valid number\n    if (!isNaN(parentId) && parentId > 0) {\n      return parentId;\n    }\n  }\n  \n  return null;\n}\n\n/**\n * Extract all mentioned post IDs from content\n * \n * Gets all post mentions from the content, not just the first one.\n * Useful for analytics or advanced threading features.\n * \n * @param {string} content - The reply content to parse\n * @returns {number[]} - Array of mentioned post IDs\n */\nexport function extractAllMentionedPostIds(content) {\n  if (!content || typeof content !== 'string') {\n    return [];\n  }\n  \n  const postMentionRegex = /@\"[^\"]*\"#p(\\d+)/g;\n  const matches = [];\n  let match;\n  \n  while ((match = postMentionRegex.exec(content)) !== null) {\n    const postId = parseInt(match[1], 10);\n    if (!isNaN(postId) && postId > 0) {\n      matches.push(postId);\n    }\n  }\n  \n  return matches;\n}\n\n/**\n * Check if content contains post mentions\n * \n * @param {string} content - The content to check\n * @returns {boolean} - True if content contains post mentions\n */\nexport function hasPostMentions(content) {\n  return extractParentIdFromContent(content) !== null;\n}\n\n/**\n * Get threading context from reply content\n * \n * Extracts comprehensive threading information from reply content,\n * including the primary parent and any additional mentioned posts.\n * \n * @param {string} content - The reply content to analyze\n * @returns {Object} - Threading context object\n */\nexport function getThreadingContext(content) {\n  const primaryParentId = extractParentIdFromContent(content);\n  const allMentionedIds = extractAllMentionedPostIds(content);\n  \n  return {\n    primaryParentId: primaryParentId,\n    allMentionedPostIds: allMentionedIds,\n    hasMentions: allMentionedIds.length > 0,\n    mentionCount: allMentionedIds.length,\n    isThreadedReply: primaryParentId !== null\n  };\n}\n\n/**\n * Validate threading data before submission\n * \n * Performs validation on the threading data to ensure it's valid\n * before the reply is submitted to the server.\n * \n * @param {Object} data - The reply data object\n * @returns {Object} - Validation result with isValid boolean and any error messages\n */\nexport function validateThreadingData(data) {\n  const result = {\n    isValid: true,\n    errors: [],\n    warnings: []\n  };\n  \n  // Check if parent_id is present and valid\n  if (data.parent_id !== undefined) {\n    if (typeof data.parent_id !== 'number' || data.parent_id <= 0) {\n      result.isValid = false;\n      result.errors.push('Invalid parent_id: must be a positive number');\n    }\n  }\n  \n  // Check for potential threading issues\n  if (data.content && hasPostMentions(data.content)) {\n    const context = getThreadingContext(data.content);\n    \n    if (!data.parent_id && context.isThreadedReply) {\n      result.warnings.push('Content contains post mentions but no parent_id was set');\n    }\n    \n    if (context.mentionCount > 1) {\n      result.warnings.push(`Multiple post mentions found (${context.mentionCount}), only first will be used for threading`);\n    }\n  }\n  \n  return result;\n}\n\n/**\n * Clean threading data for submission\n * \n * Ensures threading data is properly formatted and cleaned before\n * being sent to the server.\n * \n * @param {Object} data - The reply data object\n * @returns {Object} - Cleaned data object\n */\nexport function cleanThreadingData(data) {\n  const cleanedData = { ...data };\n  \n  // Ensure parent_id is a proper integer or remove it\n  if (cleanedData.parent_id !== undefined) {\n    const parentId = parseInt(cleanedData.parent_id, 10);\n    if (!isNaN(parentId) && parentId > 0) {\n      cleanedData.parent_id = parentId;\n    } else {\n      delete cleanedData.parent_id;\n    }\n  }\n  \n  return cleanedData;\n} "],"names":["__webpack_require__","module","getter","__esModule","d","a","exports","definition","key","o","Object","defineProperty","enumerable","get","obj","prop","prototype","hasOwnProperty","call","flarum","core","compat","getPostThreadMetadata","post","_threadDepth","depth","threadPath","_threadPath","isRoot","_isRoot","childCount","_childCount","descendantCount","_descendantCount","rootPostId","_rootPostId","_cache","Map","prefetchThreadOrder","discussionId","did","String","has","ready","entry","map","set","app","request","method","url","forum","attribute","then","res","order","forEach","_ref","postId","parentPostId","Number","parentId","m","redraw","e","console","warn","clampDepth","n","x","isFinite","Math","max","min","getThreadCssClasses","id","discussion","rec","undefined","getDepthPrefetched","isInteger","_","md","guard","seen","Set","current","pid","add","parent","store","getById","walkDepthByParentChain","getThreadDepth","classes","push","prefParent","getParentPrefetched","flattenThreadTree","rootPosts","result","addPostAndChildren","children","_threadChildren","sort","b","createdAt","getTime","child","rootPost","createThreadedPosts","posts","threadTree","tree","postMap","childrenMap","buildThreadTree","threadDepthCache","clearThreadDepthCache","clear","toStrId","mergeUniquePostsById","basePosts","extraPosts","filter","Boolean","p","Array","from","values","loadPostsByIds","postIds","ids","length","Promise","resolve","find","join","loadMissingParentPosts","postStream","currentPosts","currentIdSet","missingParentIds","uniqueMissing","loadedParents","merged","err","isReordering","reorderedPostsCache","originalPostsMethod","lastPostCount","currentDiscussionId","suspendThreading","rebuildPending","scheduleRebuild","setTimeout","finish","originalPosts","stream","valid","ensureParentsLoaded","postsWithParents","_postStream$stream","getDiscussionFrom","unloadedIds","sampleSize","slice","loadedSample","actualChildren","loadMinimalChildren","ensureMinimalChildren","postsReady","sorted","orderOf","idx","getOrderIndex","some","ao","bo","padToOriginalLength","fallback","error","arr","updateReorderedCache","threadedPosts","isArray","concat","need","i","KEY","methods","window","__threadifyConsoleOriginal","name","bind","enabled","localStorage","getItem","setEnabled","v","setItem","threadifyLogs","enable","disable","toggle","status","original","_len","arguments","args","_key","first","indexOf","apply","extend","Post","this","attrs","threadClasses","log","className","ReplyComposer","data","content","postMentionMatch","match","parseInt","isNaN","extractParentIdFromContent","parent_id","override","PostStreamState","_this","ps","_this2","_len2","_key2","PostStream","_this3","cur","count","DiscussionPage","DiscussionListItem","handler","element","addEventListener","once","passive"],"sourceRoot":""}