(()=>{var t={9:(t,e,n)=>{"use strict";n.r(e),n.d(e,{forceRebuildCache:()=>b,getThreadedPostsCache:()=>T,getThreadingDebugInfo:()=>_,getThreadingStats:()=>C,initThreadedPostStream:()=>g,isThreadingActive:()=>P,logThreadingDebug:()=>S,setMinimalChildLoading:()=>w});var r=n(26);const o=flarum.core.compat["forum/components/PostStream"];var i=n.n(o);function a(t){var e=[];function n(t,r){if(void 0===r&&(r=0),t){e.push(t);var o=t._threadChildren||[];o.sort(function(t,e){return(t.createdAt?t.createdAt().getTime():0)-(e.createdAt?e.createdAt().getTime():0)}),o.forEach(function(t){n(t,r+1)})}}return t.sort(function(t,e){return(t.createdAt?t.createdAt().getTime():0)-(e.createdAt?e.createdAt().getTime():0)}),t.forEach(function(t){n(t)}),e}function u(t){var e=function(t){var e=[],n=new Map,r=new Map;return t.forEach(function(t){if(t){var e=t.id();n.set(e,t),r.set(e,[])}}),t.forEach(function(t){if(t){t.id();var o=t.attribute("parent_id");o&&n.has(String(o))?r.get(String(o)).push(t):e.push(t)}}),t.forEach(function(t){t&&(t._threadChildren=r.get(t.id())||[])}),e}(t);return a(e)}var c=new Map;function l(){c.clear()}var s=!1,d=null,h=0,f=null,p=!1;function g(){(0,r.extend)(i().prototype,"oninit",function(){var t=this;f=this.stream.posts,this.stream.posts=function(){if(d)return console.log("[Threadify] Returning threaded posts ("+d.filter(function(t){return t}).length+" posts)"),d;var e=f.call(t.stream);return console.log("[Threadify] No cache, returning original posts ("+(e?e.filter(function(t){return t}).length:0)+" posts)"),e&&e.filter(function(t){return t}).length>0&&!s&&(console.log("[Threadify] Triggering cache rebuild"),v(t)),e};var e=f.call(this.stream);h=e?e.filter(function(t){return t}).length:0,console.log("[Threadify] Initial post count: "+h),e&&e.length>0&&v(this)}),(0,r.extend)(i().prototype,"view",function(t){return!d&&f&&v(this),t}),(0,r.extend)(i().prototype,"oncreate",function(){l()}),(0,r.extend)(i().prototype,"onupdate",function(){!function(t){if(!s&&f){var e=f.call(t.stream),n=e?e.filter(function(t){return t}).length:0;n!==h&&(console.log("[Threadify] Post count changed: "+h+" -> "+n+", rebuilding cache"),h=n,d=null,l(),v(t))}}(this)})}function v(t){if(!s){s=!0;try{if(!f)return void(d=null);var e=f.call(t.stream);if(!e||0===e.length)return void(d=null);var n=e.filter(function(t){return t});if(0===n.length)return void(d=null);if(p)(function(t,e){var n=e.map(function(t){return t.id()});if(0===n.length)return Promise.resolve(e);var r=t.discussion.postIds(),o=new Set(n.map(function(t){return String(t)})),i=r.filter(function(t){return!o.has(String(t))});if(0===i.length)return Promise.resolve(e);var a=Math.min(5,i.length),u=i.slice(-a);return console.log("[Threadify] Checking only "+a+" recent posts for children"),function(t){if(!t||0===t.length)return Promise.resolve([]);var e=t.join(",");return app.store.find("posts",{filter:{id:e}})}(u).then(function(t){var r=t.filter(function(t){var e=t.attribute("parent_id");return e&&n.includes(String(e))});return console.log("[Threadify] Found "+r.length+" children from minimal sample"),r.length>0?[].concat(e,r):e}).catch(function(t){return console.warn("[Threadify] Minimal child loading failed:",t),e})})(t,n).then(function(t){if(s){var n=u(t),r=y(e,n);d=r,console.log("[Threadify] Applied threading with minimal children ("+n.length+" posts)"),setTimeout(function(){m.redraw()},10)}}).catch(function(t){console.warn("[Threadify] Minimal child loading failed, using basic threading:",t);var r=u(n),o=y(e,r);d=o}).finally(function(){s=!1});else{var r=u(n),o=y(e,r);d=o,console.log("[Threadify] Applied simple threading ("+r.length+" posts)"),setTimeout(function(){m.redraw()},10),s=!1}}catch(t){console.error("[Threadify] Cache update failed:",t),s=!1}}}function y(t,e){if(!e||0===e.length)return t;for(var n=[].concat(e),r=(t.filter(function(t){return null!==t}).length,Math.max(0,t.length-e.length)),o=0;o<r;o++)n.push(null);return n}function T(){return d}function b(t){console.log("[Threadify] Force rebuilding cache"),d=null,l(),v(t)}function P(){return!(!d||!f)}function C(){return{hasCachedPosts:!!d,cachedPostCount:d?d.filter(function(t){return t}).length:0,isReordering:s,lastPostCount:h,hasOriginalMethod:!!f}}function _(){return{isReordering:s,hasCachedPosts:!!d,cachedPostCount:d?d.filter(function(t){return t}).length:0,lastPostCount:h,hasOriginalMethod:!!f}}function S(){var t=_();if(console.log("[Threadify] Debug Info:",t),d){var e=d.filter(function(t){return t});console.log("[Threadify] Cache contains posts:",e.map(function(t){return"#"+t.id()+" (parent: "+(t.attribute("parent_id")||"none")+")"}))}}function w(t){p=t,console.log("[Threadify] Minimal child loading "+(t?"enabled":"disabled"))}},26:t=>{"use strict";t.exports=flarum.core.compat["common/extend"]}},e={};function n(r){var o=e[r];if(void 0!==o)return o.exports;var i=e[r]={exports:{}};return t[r](i,i.exports,n),i.exports}n.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return n.d(e,{a:e}),e},n.d=(t,e)=>{for(var r in e)n.o(e,r)&&!n.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:e[r]})},n.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),n.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},(()=>{"use strict";var t=n(9),e=n(26);const r=flarum.core.compat["forum/components/Post"];var o=n.n(r);function i(t){return t&&void 0!==t._threadDepth?{depth:t._threadDepth,threadPath:t._threadPath,isRoot:t._isRoot,childCount:t._childCount,descendantCount:t._descendantCount,rootPostId:t._rootPostId}:null}const a=flarum.core.compat["forum/components/ReplyComposer"];var u=n.n(a);app.initializers.add("syntaxoutlaw-threadify",function(){try{(0,t.initThreadedPostStream)(),(0,e.extend)(o().prototype,"classes",function(t){var e=this.attrs.post;if(!e)return console.warn("[Threadify] No post in ThreadedPost.classes"),t;var n=function(t){var e=function(t){if(!t)return 0;var e=i(t);return e?Math.min(e.depth,10):t.attribute("parent_id")?1:0}(t),n=[];e>0?(n.push("threaded-post"),n.push("thread-depth-"+e),e>=3&&n.push("thread-deep"),e>=5&&n.push("thread-very-deep")):n.push("thread-root");var r=i(t);return r&&(r.isRoot&&n.push("thread-root-confirmed"),r.childCount>0&&(n.push("has-children"),n.push("child-count-"+Math.min(r.childCount,10))),r.descendantCount>0&&n.push("has-descendants")),n}(e);return console.log("[Threadify] Adding classes to post "+e.id()+": "+n.join(", ")),n.forEach(function(e){t.push(e)}),t}),(0,e.extend)(u().prototype,"data",function(t){var e=function(t){if(!t||"string"!=typeof t)return null;var e=t.match(/@"[^"]*"#p(\d+)/);if(e&&e[1]){var n=parseInt(e[1],10);if(!isNaN(n)&&n>0)return n}return null}(t.content);return e&&(t.parent_id=e,console.log("[Threadify] Reply threading to post",e)),t}),console.log("[Threadify] stable PostStreamState wrapper loaded"),window.threadifyDebug={forceRebuild:function(t){(0,n(9).forceRebuildCache)(t)}}}catch(t){console.error("[Threadify] init failed:",t)}})})(),module.exports={}})();
//# sourceMappingURL=forum.js.map