(()=>{var t={n:r=>{var n=r&&r.__esModule?()=>r.default:()=>r;return t.d(n,{a:n}),n},d:(r,n)=>{for(var e in n)t.o(n,e)&&!t.o(r,e)&&Object.defineProperty(r,e,{enumerable:!0,get:n[e]})},o:(t,r)=>Object.prototype.hasOwnProperty.call(t,r)};(()=>{"use strict";const r=flarum.core.compat["forum/app"];var n=t.n(r);const e=flarum.core.compat["common/extend"],o=flarum.core.compat["forum/components/DiscussionPage"];var i=t.n(o);const a=flarum.core.compat["forum/components/DiscussionListItem"];var s=t.n(a);const u=flarum.core.compat["forum/components/Post"];var c=t.n(u);function l(t){return t&&void 0!==t._threadDepth?{depth:t._threadDepth,threadPath:t._threadPath,isRoot:t._isRoot,childCount:t._childCount,descendantCount:t._descendantCount,rootPostId:t._rootPostId}:null}const d=flarum.core.compat["forum/components/ReplyComposer"];var f=t.n(d);const h=flarum.core.compat["forum/components/PostStream"];var p=t.n(h);const v=flarum.core.compat["forum/states/PostStreamState"];var y=t.n(v);function g(t){var r=[];function n(t,e){if(void 0===e&&(e=0),t){r.push(t);var o=t._threadChildren||[];o.sort(function(t,r){return(t.createdAt?t.createdAt().getTime():0)-(r.createdAt?r.createdAt().getTime():0)}),o.forEach(function(t){n(t,e+1)})}}return t.sort(function(t,r){return(t.createdAt?t.createdAt().getTime():0)-(r.createdAt?r.createdAt().getTime():0)}),t.forEach(function(t){n(t)}),r}function P(t){var r=function(t){var r=[],n=new Map,e=new Map;return t.forEach(function(t){if(t){var r=t.id();n.set(r,t),e.set(r,[])}}),t.forEach(function(t){if(t){t.id();var o=t.attribute("parent_id");o&&n.has(String(o))?e.get(String(o)).push(t):r.push(t)}}),t.forEach(function(t){t&&(t._threadChildren=e.get(t.id())||[])}),r}(t);return g(r)}var w=new Map;function b(){w.clear()}function _(t){return null==t?"":String(t)}function A(t,r){var n=new Map;return t.filter(Boolean).forEach(function(t){return n.set(_(t.id()),t)}),r.filter(Boolean).forEach(function(t){return n.set(_(t.id()),t)}),Array.from(n.values())}function T(t){var r=(t||[]).map(_).filter(Boolean);return 0===r.length?Promise.resolve([]):n().store.find("posts",{filter:{id:r.join(",")}})}function S(t,r){var n=(r||[]).filter(Boolean),e=new Set(n.map(function(t){return _(t.id())})),o=[];n.forEach(function(t){var r=_(null==t||null==t.attribute?void 0:t.attribute("parent_id"));r&&!e.has(r)&&o.push(r)});var i=Array.from(new Set(o));return 0===i.length?Promise.resolve(n):T(i).then(function(r){var e=A(n,r);return S(t,e)}).catch(function(t){return console.warn("[Threadify] Failed to load parent posts:",t),n})}var x=new Map;function E(t){var r=String(t);if(x.has(r)&&x.get(r).ready)return x.get(r).ready;var n={map:new Map,ready:null};return x.set(r,n),n.ready=app.request({method:"GET",url:app.forum.attribute("apiUrl")+"/discussions/"+r+"/threads-order"}).then(function(t){var r=new Map;(t.order||[]).forEach(function(t){var n=t.postId,e=t.order,o=t.depth,i=t.parentPostId;r.set(Number(n),{order:Number(e),depth:Number(o),parentId:i?Number(i):null})}),n.map=r,m.redraw()}).catch(function(t){console.warn("[Threadify] order prefetch failed",t)}),n.ready}function M(t,r){var n=x.get(String(t));if(n&&n.map){var e=n.map.get(Number(r));return e?e.order:void 0}}var C=!1,I=null,N=null,B=0,R=null,j=!1,D=!1;function L(t){setTimeout(function(){return function(t){if(!C)if(j)D=!0;else{C=!0;try{if(!N)return e(null);var r=N.call(t.stream)||[],n=r.filter(Boolean);if(0===n.length)return e(null);(function(t,r){return S(t.discussion?t:{discussion:t.stream.discussion},r).catch(function(){return Promise.resolve(r)})})(t,n).then(function(r){return function(t,r){return function(t,r){var n=function(t){var r;return(null==t?void 0:t.discussion)||(null==t||null==(r=t.stream)?void 0:r.discussion)||null}(t),e=(r||[]).filter(Boolean),o=new Set(e.map(function(t){return _(t.id())}));if(!n||"function"!=typeof n.postIds)return Promise.resolve(e);var i=(n.postIds()||[]).map(_).filter(function(t){return t&&!o.has(t)});if(0===i.length)return Promise.resolve(e);var a=Math.min(10,i.length);return T(i.slice(-a)).then(function(t){var r=(t||[]).filter(function(t){var r=_(null==t||null==t.attribute?void 0:t.attribute("parent_id"));return r&&o.has(r)});return 0===r.length?e:A(e,r)}).catch(function(t){return console.warn("[Threadify] Failed to load child posts:",t),e})}(t.discussion?t:{discussion:t.stream.discussion},r).catch(function(){return Promise.resolve(r)})}(t,r)}).then(function(n){var o,i=t.stream&&t.stream.discussion&&t.stream.discussion.id(),a=function(t){var r=t&&t.id?t.id():null;if(!r)return null;var n=M(i,r);return Number.isInteger(n)?n:null};o=n.some(function(t){return null!==a(t)})?n.slice().sort(function(t,r){var n=a(t),e=a(r);return null==n&&null==e?0:null==n?1:null==e?-1:n-e}):P(n),e(O(r,o))}).catch(function(t){console.warn("[Threadify] reorder fallback due to error:",t);var o=P(n);e(O(r,o))})}catch(t){console.error("[Threadify] Cache update failed:",t),e(null)}}function e(t){I=t,C=!1,setTimeout(function(){return m.redraw()},0)}}(t)},0)}function O(t,r){if(!Array.isArray(r)||0===r.length)return t;for(var n=[].concat(r),e=Math.max(0,t.length-r.length),o=0;o<e;o++)n.push(null);return n}n().initializers.add("syntaxoutlaw-threadify",function(){(0,e.extend)(c().prototype,"classes",function(t){var r=this.attrs.post;if(!r)return console.warn("[Threadify] No post in ThreadedPost.classes"),t;var n=function(t){var r=function(t){if(!t)return 0;var r=l(t);return r?Math.min(r.depth,10):t.attribute("parent_id")?1:0}(t),n=[];r>0?(n.push("threaded-post"),n.push("thread-depth-"+r),r>=3&&n.push("thread-deep"),r>=5&&n.push("thread-very-deep")):n.push("thread-root");var e=l(t);return e&&(e.isRoot&&n.push("thread-root-confirmed"),e.childCount>0&&(n.push("has-children"),n.push("child-count-"+Math.min(e.childCount,10))),e.descendantCount>0&&n.push("has-descendants")),n}(r);return console.log("[Threadify] Adding classes to post "+r.id()+": "+n.join(", ")),n.forEach(function(r){t.push(r)}),t}),(0,e.extend)(f().prototype,"data",function(t){var r=function(t){if(!t||"string"!=typeof t)return null;var r=t.match(/@"[^"]*"#p(\d+)/);if(r&&r[1]){var n=parseInt(r[1],10);if(!isNaN(n)&&n>0)return n}return null}(t.content);return r&&(t.parent_id=r,console.log("[Threadify] Reply threading to post",r)),t}),(0,e.override)(y().prototype,"_loadPrevious",function(t){var r=this;j=!0;for(var n=arguments.length,e=new Array(n>1?n-1:0),o=1;o<n;o++)e[o-1]=arguments[o];var i=t.apply(void 0,e);return Promise.resolve(i).finally(function(){if(j=!1,D){D=!1;var t=r.discussion&&r.discussion.postStream?r.discussion.postStream:null;t&&L(t)}})}),(0,e.override)(y().prototype,"_loadNext",function(t){var r=this;j=!0;for(var n=arguments.length,e=new Array(n>1?n-1:0),o=1;o<n;o++)e[o-1]=arguments[o];var i=t.apply(void 0,e);return Promise.resolve(i).finally(function(){if(j=!1,D){D=!1;var t=r.discussion&&r.discussion.postStream?r.discussion.postStream:null;t&&L(t)}})}),(0,e.extend)(y().prototype,"visiblePosts",function(t){if(Array.isArray(t)&&!(t.length<=1)){var r=this.discussion&&"function"==typeof this.discussion.id&&this.discussion.id()||this.discussion&&this.discussion.id||null;t.sort(function(t,n){var e=t&&t.id?t.id():null,o=n&&n.id?n.id():null;if(!e||!o)return 0;var i=M(r,e),a=M(r,o);if(null!=i||null!=a){if(null==i)return 1;if(null==a)return-1;if(i!==a)return i-a}return 0})}}),(0,e.extend)(p().prototype,"oninit",function(){var t=this,r=this.stream&&this.stream.discussion&&this.stream.discussion.id();R!==r&&(R=r,C=!1,I=null,N=null,B=0,j=!1,D=!1,b()),r&&E(r),N||(N=this.stream.posts),this.stream.posts=function(){if(j)return N.call(t.stream)||[];if(I)return I;var r=N.call(t.stream)||[];return!C&&r.filter(Boolean).length>0&&L(t),r};var n=N.call(this.stream)||[];(B=n.filter(Boolean).length)>0&&!j&&L(this)}),(0,e.extend)(p().prototype,"oncreate",function(){b()}),(0,e.extend)(p().prototype,"onupdate",function(){if(N){var t=(N.call(this.stream)||[]).filter(Boolean).length;t!==B&&(B=t,I=null,b(),j?D=!0:L(this))}}),(0,e.extend)(i().prototype,"oninit",function(){var t=this.discussion&&this.discussion.id&&this.discussion.id();t&&E(t)}),(0,e.extend)(s().prototype,"oncreate",function(){var t=this.attrs.discussion;if(t){var r=t.id(),n=function(){return E(r)};this.element&&this.element.addEventListener("mouseenter",n,{once:!0}),this.element&&this.element.addEventListener("touchstart",n,{once:!0,passive:!0})}})})})(),module.exports={}})();
//# sourceMappingURL=forum.js.map