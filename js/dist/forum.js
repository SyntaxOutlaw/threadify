(()=>{var t={n:n=>{var r=n&&n.__esModule?()=>n.default:()=>n;return t.d(r,{a:r}),r},d:(n,r)=>{for(var e in r)t.o(r,e)&&!t.o(n,e)&&Object.defineProperty(n,e,{enumerable:!0,get:r[e]})},o:(t,n)=>Object.prototype.hasOwnProperty.call(t,n)};(()=>{"use strict";const n=flarum.core.compat["forum/app"];var r=t.n(n);const e=flarum.core.compat["common/extend"],o=flarum.core.compat["forum/components/DiscussionPage"];var i=t.n(o);const a=flarum.core.compat["forum/components/DiscussionListItem"];var s=t.n(a);const u=flarum.core.compat["forum/components/Post"];var c=t.n(u);function l(t){return t&&void 0!==t._threadDepth?{depth:t._threadDepth,threadPath:t._threadPath,isRoot:t._isRoot,childCount:t._childCount,descendantCount:t._descendantCount,rootPostId:t._rootPostId}:null}var d=new Map;function f(t){var n=String(t);if(d.has(n)&&d.get(n).ready)return d.get(n).ready;var r={map:new Map,ready:null};return d.set(n,r),r.ready=app.request({method:"GET",url:app.forum.attribute("apiUrl")+"/discussions/"+n+"/threads-order"}).then(function(t){var n=new Map;(t.order||[]).forEach(function(t){var r=t.postId,e=t.order,o=t.depth,i=t.parentPostId;n.set(Number(r),{order:Number(e),depth:Number(o),parentId:i?Number(i):null})}),r.map=n,m.redraw()}).catch(function(t){console.warn("[Threadify] order prefetch failed",t)}),r.ready}function h(t){var n=Number(t);return Number.isFinite(n)?Math.max(0,Math.min(10,n)):0}function p(t){var n=function(t){if(!t||"function"!=typeof t.id)return 0;try{var n=t.discussion&&"function"==typeof t.discussion&&t.discussion()&&t.discussion().id&&t.discussion().id()||null;if(null!=n){var r=function(t,n){var r=d.get(String(t));if(r&&r.map){var e=r.map.get(Number(n));return e?e.depth:void 0}}(n,t.id());if(Number.isInteger(r))return h(r)}}catch(t){}try{var e=l(t);if(e&&Number.isInteger(e.depth))return h(e.depth)}catch(t){}return function(t){for(var n=0,r=0,e=new Set,o=t;o&&r<100;){var i=o.attribute?o.attribute("parent_id"):null;if(!i)break;if(e.has(i)){console.warn("[Threadify] cycle detected while walking parents of",t&&t.id&&t.id()),n=0;break}e.add(i),n+=1;var a=app.store.getById("posts",String(i));if(!a)break;if(o=a,r++,n>=10)break}return h(n)}(t)}(t),r=[];n>0?(r.push("threaded-post"),r.push("thread-depth-"+n),n>=3&&r.push("thread-deep"),n>=5&&r.push("thread-very-deep")):r.push("thread-root");try{var e=t.discussion&&"function"==typeof t.discussion&&t.discussion()&&t.discussion().id&&t.discussion().id()||null,o=null!=e?function(t,n){var r=d.get(String(t));if(r&&r.map){var e=r.map.get(Number(n));return e?e.parentId:void 0}}(e,t.id()):void 0,i=l(t);(null==o?!t.attribute||!t.attribute("parent_id"):null==o)&&r.push("thread-root-confirmed"),i&&Number.isInteger(i.childCount)&&i.childCount>0&&r.push("has-children","child-count-"+Math.min(i.childCount,10)),i&&Number.isInteger(i.descendantCount)&&i.descendantCount>0&&r.push("has-descendants")}catch(t){}return r}const v=flarum.core.compat["forum/components/ReplyComposer"];var g=t.n(v);const y=flarum.core.compat["forum/components/PostStream"];var w=t.n(y);const b=flarum.core.compat["forum/states/PostStreamState"];var _=t.n(b);function S(t){var n=[];function r(t,e){if(void 0===e&&(e=0),t){n.push(t);var o=t._threadChildren||[];o.sort(function(t,n){return(t.createdAt?t.createdAt().getTime():0)-(n.createdAt?n.createdAt().getTime():0)}),o.forEach(function(t){r(t,e+1)})}}return t.sort(function(t,n){return(t.createdAt?t.createdAt().getTime():0)-(n.createdAt?n.createdAt().getTime():0)}),t.forEach(function(t){r(t)}),n}function P(t){var n=function(t){var n=[],r=new Map,e=new Map;return t.forEach(function(t){if(t){var n=t.id();r.set(n,t),e.set(n,[])}}),t.forEach(function(t){if(t){t.id();var o=t.attribute("parent_id");o&&r.has(String(o))?e.get(String(o)).push(t):n.push(t)}}),t.forEach(function(t){t&&(t._threadChildren=e.get(t.id())||[])}),n}(t);return S(n)}var T=new Map;function N(){T.clear()}function I(t){return null==t?"":String(t)}function C(t,n){var r=new Map;return t.filter(Boolean).forEach(function(t){return r.set(I(t.id()),t)}),n.filter(Boolean).forEach(function(t){return r.set(I(t.id()),t)}),Array.from(r.values())}function A(t){var n=(t||[]).map(I).filter(Boolean);return 0===n.length?Promise.resolve([]):r().store.find("posts",{filter:{id:n.join(",")}})}function E(t,n){var r=(n||[]).filter(Boolean),e=new Set(r.map(function(t){return I(t.id())})),o=[];r.forEach(function(t){var n=I(null==t||null==t.attribute?void 0:t.attribute("parent_id"));n&&!e.has(n)&&o.push(n)});var i=Array.from(new Set(o));return 0===i.length?Promise.resolve(r):A(i).then(function(n){var e=C(r,n);return E(t,e)}).catch(function(t){return console.warn("[Threadify] Failed to load parent posts:",t),r})}var x=!1,M=null,O=null,B=0,F=null,k=!1,j=!1;function D(t){setTimeout(function(){return function(t){if(!x)if(k)j=!0;else{x=!0;try{if(!O)return e(null);var n=O.call(t.stream)||[],r=n.filter(Boolean);if(0===r.length)return e(null);(function(t,n){return E(t.discussion?t:{discussion:t.stream.discussion},n).catch(function(){return Promise.resolve(n)})})(t,r).then(function(n){return function(t,n){return function(t,n){var r=function(t){var n;return(null==t?void 0:t.discussion)||(null==t||null==(n=t.stream)?void 0:n.discussion)||null}(t),e=(n||[]).filter(Boolean),o=new Set(e.map(function(t){return I(t.id())}));if(!r||"function"!=typeof r.postIds)return Promise.resolve(e);var i=(r.postIds()||[]).map(I).filter(function(t){return t&&!o.has(t)});if(0===i.length)return Promise.resolve(e);var a=Math.min(10,i.length);return A(i.slice(-a)).then(function(t){var n=(t||[]).filter(function(t){var n=I(null==t||null==t.attribute?void 0:t.attribute("parent_id"));return n&&o.has(n)});return 0===n.length?e:C(e,n)}).catch(function(t){return console.warn("[Threadify] Failed to load child posts:",t),e})}(t.discussion?t:{discussion:t.stream.discussion},n).catch(function(){return Promise.resolve(n)})}(t,n)}).then(function(r){var o,i=t.stream&&t.stream.discussion&&t.stream.discussion.id(),a=function(t){var n=t&&t.id?t.id():null;if(!n)return null;var r=function(t,n){var r=d.get(String(t));if(r&&r.map){var e=r.map.get(Number(n));return e?e.order:void 0}}(i,n);return Number.isInteger(r)?r:null};o=r.some(function(t){return null!==a(t)})?r.slice().sort(function(t,n){var r=a(t),e=a(n);return null==r&&null==e?0:null==r?1:null==e?-1:r-e}):P(r),e(L(n,o))}).catch(function(t){console.warn("[Threadify] reorder fallback due to error:",t);var o=P(r);e(L(n,o))})}catch(t){console.error("[Threadify] Cache update failed:",t),e(null)}}function e(t){M=t,x=!1,setTimeout(function(){return m.redraw()},0)}}(t)},0)}function L(t,n){if(!Array.isArray(n)||0===n.length)return t;for(var r=[].concat(n),e=Math.max(0,t.length-n.length),o=0;o<e;o++)r.push(null);return r}!function(){var t="threadify:logs",n=["log","info","warn","debug","error"];window.__threadifyConsoleOriginal||(window.__threadifyConsoleOriginal={},n.forEach(function(t){window.__threadifyConsoleOriginal[t]=console[t]?console[t].bind(console):function(){}}));var r="1"===("undefined"!=typeof localStorage?localStorage.getItem(t):null);function e(n){r=!!n,"undefined"!=typeof localStorage&&localStorage.setItem(t,r?"1":"0")}window.threadifyLogs={enable:function(){return e(!0),"Threadify logs: ON"},disable:function(){return e(!1),"Threadify logs: OFF"},toggle:function(){return e(!r),"Threadify logs: "+(r?"ON":"OFF")},status:function(){return r}},n.forEach(function(t){var n=window.__threadifyConsoleOriginal[t];console[t]=function(){for(var t=arguments.length,e=new Array(t),o=0;o<t;o++)e[o]=arguments[o];var i=e&&e[0];if("string"!=typeof i||0!==i.indexOf("[Threadify]")||r)return n.apply(void 0,e)}})}(),r().initializers.add("syntaxoutlaw-threadify",function(){(0,e.extend)(c().prototype,"classes",function(t){var n=this.attrs.post;if(!n)return console.warn("[Threadify] No post in ThreadedPost.classes"),t;var r=p(n);return console.log("[Threadify] Adding classes to post "+n.id()+": "+r.join(", ")),r.forEach(function(n){t.push(n)}),t}),(0,e.extend)(g().prototype,"data",function(t){var n=function(t){if(!t||"string"!=typeof t)return null;var n=t.match(/@"[^"]*"#p(\d+)/);if(n&&n[1]){var r=parseInt(n[1],10);if(!isNaN(r)&&r>0)return r}return null}(t.content);return n&&(t.parent_id=n,console.log("[Threadify] Reply threading to post",n)),t}),(0,e.override)(_().prototype,"_loadPrevious",function(t){var n=this;k=!0;for(var r=arguments.length,e=new Array(r>1?r-1:0),o=1;o<r;o++)e[o-1]=arguments[o];var i=t.apply(void 0,e);return Promise.resolve(i).finally(function(){if(k=!1,j){j=!1;var t=n.discussion&&n.discussion.postStream?n.discussion.postStream:null;t&&D(t)}})}),(0,e.override)(_().prototype,"_loadNext",function(t){var n=this;k=!0;for(var r=arguments.length,e=new Array(r>1?r-1:0),o=1;o<r;o++)e[o-1]=arguments[o];var i=t.apply(void 0,e);return Promise.resolve(i).finally(function(){if(k=!1,j){j=!1;var t=n.discussion&&n.discussion.postStream?n.discussion.postStream:null;t&&D(t)}})}),(0,e.extend)(w().prototype,"oninit",function(){var t=this,n=this.stream&&this.stream.discussion&&this.stream.discussion.id();F!==n&&(F=n,x=!1,M=null,O=null,B=0,k=!1,j=!1,N()),n&&f(n),O||(O=this.stream.posts),this.stream.posts=function(){if(k)return O.call(t.stream)||[];if(M)return M;var n=O.call(t.stream)||[];return!x&&n.filter(Boolean).length>0&&D(t),n};var r=O.call(this.stream)||[];(B=r.filter(Boolean).length)>0&&!k&&D(this)}),(0,e.extend)(w().prototype,"oncreate",function(){N()}),(0,e.extend)(w().prototype,"onupdate",function(){if(O){var t=(O.call(this.stream)||[]).filter(Boolean).length;t!==B&&(B=t,M=null,N(),k?j=!0:D(this))}}),(0,e.extend)(i().prototype,"oninit",function(){var t=this.discussion&&"function"==typeof this.discussion.id&&this.discussion.id()||this.discussion&&this.discussion.id||null;t&&f(t)}),(0,e.extend)(s().prototype,"oncreate",function(){var t=this.attrs.discussion;if(t){var n=t.id(),r=function(){return f(n)};this.element&&(this.element.addEventListener("mouseenter",r,{once:!0}),this.element.addEventListener("touchstart",r,{once:!0,passive:!0}))}})})})(),module.exports={}})();
//# sourceMappingURL=forum.js.map