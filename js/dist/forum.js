(()=>{var e={n:t=>{var n=t&&t.__esModule?()=>t.default:()=>t;return e.d(n,{a:n}),n},d:(t,n)=>{for(var r in n)e.o(n,r)&&!e.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:n[r]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};(()=>{"use strict";const t=flarum.core.compat["forum/app"];var n=e.n(t);const r=flarum.core.compat["common/extend"],o=flarum.core.compat["forum/components/DiscussionPage"];var i=e.n(o);const a=flarum.core.compat["forum/components/DiscussionListItem"];var u=e.n(a);const s=flarum.core.compat["forum/components/Post"];var l=e.n(s),d=new Map;function c(e){if(!e)return null;var t=e.discussion&&e.discussion(),n=t&&t.id&&t.id();if(!n)return null;var r=function(e,t){var n=d.get(Number(e));if(n)return n.map.get(Number(t))}(n,e.id());return r?{depth:r.depth,threadPath:null,isRoot:!r.parentId,childCount:0,descendantCount:0,rootPostId:null}:null}var f=new Map;function h(e,t){void 0===t&&(t={});var n=m(e);if(!n)return Promise.resolve();var r=Date.now(),o=f.get(n)||{map:new Map,inflight:null,ts:0};if(f.set(n,o),!t.force&&r-o.ts<1e4)return o.inflight||Promise.resolve();if(o.inflight&&!t.force)return o.inflight;var i=r;return o.inflight=app.request({method:"GET",url:app.forum.attribute("apiUrl")+"/discussions/"+n+"/threads-order?bust="+i}).then(function(e){var t=new Map;(e&&e.order?e.order:[]).forEach(function(e){var n=e.postId,r=e.order,o=e.depth,i=e.parentPostId;n=Number(n),t.set(n,{order:Number(r),depth:Number.isFinite(o)?Number(o):0,parentId:i?Number(i):null})}),o.map=t,o.ts=Date.now();try{window.dispatchEvent(new CustomEvent("threadify:order-ready",{detail:{discussionId:Number(n)}}))}catch(e){}}).catch(function(e){console.warn("[Threadify] order prefetch failed",e)}).finally(function(){o.inflight=null}),o.inflight}function p(e){var t=m(e);if(t){var n=f.get(t);return n?n.map:void 0}}function m(e){if(null==e)return null;var t=Number(e);return Number.isFinite(t)&&t>0?String(t):null}function v(e){var t=Number(e);return Number.isFinite(t)?Math.max(0,Math.min(10,t)):0}function y(e){var t,n,r,o,i=function(e){if(!e||"function"!=typeof e.id)return 0;try{var t=e.discussion&&"function"==typeof e.discussion&&e.discussion()&&e.discussion().id&&e.discussion().id()||null;if(null!=t){var n=(r=t,o=e.id(),(a=(i=p(r))&&i.get(Number(o)))?a.depth:void 0);if(Number.isInteger(n))return v(n)}}catch(e){}var r,o,i,a;try{var u=c(e);if(u&&Number.isInteger(u.depth))return v(u.depth)}catch(e){}return function(e){for(var t=0,n=0,r=new Set,o=e;o&&n<100;){var i=o.attribute?o.attribute("parent_id"):null;if(!i)break;if(r.has(i)){console.warn("[Threadify] cycle detected while walking parents of",e&&e.id&&e.id()),t=0;break}r.add(i),t+=1;var a=app.store.getById("posts",String(i));if(!a)break;if(o=a,n++,t>=10)break}return v(t)}(e)}(e),a=[];i>0?(a.push("threaded-post"),a.push("thread-depth-"+i),i>=3&&a.push("thread-deep"),i>=5&&a.push("thread-very-deep")):a.push("thread-root");try{var u=e.discussion&&"function"==typeof e.discussion&&e.discussion()&&e.discussion().id&&e.discussion().id()||null,s=null!=u?(t=u,n=e.id(),(o=(r=p(t))&&r.get(Number(n)))?o.parentId:void 0):void 0,l=c(e);(null==s?!e.attribute||!e.attribute("parent_id"):null==s)&&a.push("thread-root-confirmed"),l&&Number.isInteger(l.childCount)&&l.childCount>0&&a.push("has-children","child-count-"+Math.min(l.childCount,10)),l&&Number.isInteger(l.descendantCount)&&l.descendantCount>0&&a.push("has-descendants")}catch(e){}return a}const g=flarum.core.compat["forum/components/ReplyComposer"];var b=e.n(g);const w=flarum.core.compat["forum/components/PostStream"];var N=e.n(w);function S(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(n)return(n=n.call(e)).next.bind(n);if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return I(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?I(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0;return function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function I(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}var _=1e7;function O(e){try{var t,n;return null!=(t=null==e||null==(n=e.stream)||null==(n=n.discussion)||null==n.id?void 0:n.id())?t:null}catch(e){return null}}function P(e){var t;return null!=e&&e.element&&e.element.classList&&e.element.classList.contains("PostStream")?e.element:(null==e||null==(t=e.element)||null==t.querySelector?void 0:t.querySelector(".PostStream"))||document.querySelector(".PostStream")||null}function x(e){return e&&1===e.nodeType&&e.matches(".PostStream-item[data-id]")}function C(e){var t=function(e){return Array.from((null==e?void 0:e.children)||[])}(e);if(!t.length)return{posts:[],left:-1,right:-1,anchor:null};var n=t.findIndex(x);if(n<0)return{posts:[],left:-1,right:-1,anchor:t[0]||null};var r=t.length-1-[].concat(t).reverse().findIndex(x);return r<n&&(r=n),{posts:t.slice(n,r+1).filter(x),left:n,right:r,anchor:t[r+1]||null}}function T(e,t){return(null==e||null==e.querySelector?void 0:e.querySelector('.PostStream-item[data-id="'+t+'"]'))||null}function M(e,t){var n=Number(t.dataset.id),r=e.get(n),o=r?Number(r.order):_+n;return Number.isFinite(o)?o:_+n}function A(e,t){return function(e){var t=m(e);if(!t)return Promise.resolve(new Map);var n=Date.now(),r=f.get(t)||{map:new Map,inflight:null,ts:0};return f.set(t,r),n-r.ts<1e4&&r.map&&r.map.size>=0?Promise.resolve(r.map):(r.inflight||h(t)).then(function(){return p(t)||new Map})}(t).then(function(t){var n=C(e).posts;n.length&&function(e,t,n){var r=function(e,t,n){for(var r,o=new Set,i=new Set(t.map(function(e){return Number(e.dataset.id)})),a=S(t);!(r=a()).done;){var u=r.value,s=Number(u.dataset.id),l=n.get(s);l&&(null!=l.parentId?(i.has(l.parentId)||T(e,l.parentId))&&o.add(s):o.add(s))}return o}(e,t,n),o=function(e,t,n,r){for(var o,i=t.filter(function(e){return r.has(Number(e.dataset.id))}),a=i.slice().sort(function(e,t){var r=M(n,e),o=M(n,t);return r!==o?r-o:Number(e.dataset.id)-Number(t.dataset.id)}),u=[],s=0,l=S(t);!(o=l()).done;){var d=o.value,c=Number(d.dataset.id);r.has(c)?u.push(a[s++]):u.push(d)}return u}(0,t,n,r);if(!function(e,t){if(e.length!==t.length)return!1;for(var n=0;n<e.length;n++)if(e[n]!==t[n])return!1;return!0}(t,o)){var i=C(e),a=i.anchor&&i.anchor.parentNode===e?i.anchor:null;try{for(var u,s=S(o);!(u=s()).done;){var l=u.value;a&&a.parentNode===e?e.insertBefore(l,a):e.appendChild(l)}}catch(e){console.warn("[Threadify] reorder failed (will retry on next tick)",e)}}}(e,n,t||new Map)}).catch(function(e){console.warn("[Threadify] order map unavailable",e)})}!function(){var e="threadify:logs",t=["log","info","warn","debug","error"];window.__threadifyConsoleOriginal||(window.__threadifyConsoleOriginal={},t.forEach(function(e){window.__threadifyConsoleOriginal[e]=console[e]?console[e].bind(console):function(){}}));var n="1"===("undefined"!=typeof localStorage?localStorage.getItem(e):null);function r(t){n=!!t,"undefined"!=typeof localStorage&&localStorage.setItem(e,n?"1":"0")}window.threadifyLogs={enable:function(){return r(!0),"Threadify logs: ON"},disable:function(){return r(!1),"Threadify logs: OFF"},toggle:function(){return r(!n),"Threadify logs: "+(n?"ON":"OFF")},status:function(){return n}},t.forEach(function(e){var t=window.__threadifyConsoleOriginal[e];console[e]=function(){for(var e=arguments.length,r=new Array(e),o=0;o<e;o++)r[o]=arguments[o];var i=r&&r[0];if("string"!=typeof i||0!==i.indexOf("[Threadify]")||n)return t.apply(void 0,r)}})}(),n().initializers.add("syntaxoutlaw-threadify",function(){(0,r.extend)(b().prototype,"data",function(e){var t=function(e){if(!e||"string"!=typeof e)return null;var t=e.match(/@"[^"]*"#p(\d+)/);if(t&&t[1]){var n=parseInt(t[1],10);if(!isNaN(n)&&n>0)return n}return null}(e.content);return t&&(e.parent_id=t,console.log("[Threadify] Reply threading to post",t)),e}),(0,r.extend)(l().prototype,"classes",function(e){var t=this.attrs.post;if(!t)return console.warn("[Threadify] No post in ThreadedPost.classes"),e;var n=y(t);return console.log("[Threadify] Adding classes to post "+t.id()+": "+n.join(", ")),n.forEach(function(t){e.push(t)}),e}),(0,r.extend)(N().prototype,"oncreate",function(){var e=O(this),t=P(this);if(e&&t){A(t,e);var n=!1,r=new MutationObserver(function(r){r.some(function(e){return"childList"===e.type})&&(n||(n=!0,requestAnimationFrame(function(){n=!1,A(t,e)})))});r.observe(t,{childList:!0}),this.__threadifyDomObserver=r}}),(0,r.extend)(N().prototype,"onupdate",function(){var e=O(this),t=P(this);e&&t&&A(t,e)}),(0,r.extend)(N().prototype,"onremove",function(){if(this.__threadifyDomObserver){try{this.__threadifyDomObserver.disconnect()}catch(e){}this.__threadifyDomObserver=null}}),(0,r.extend)(i().prototype,"oninit",function(){var e=this.discussion&&"function"==typeof this.discussion.id&&this.discussion.id()||this.discussion&&this.discussion.id||null;e&&h(e)}),(0,r.extend)(u().prototype,"oncreate",function(){var e=this.attrs.discussion;if(e){var t=e.id(),n=function(){return h(t)};this.element&&(this.element.addEventListener("mouseenter",n,{once:!0}),this.element.addEventListener("touchstart",n,{once:!0,passive:!0}))}})})})(),module.exports={}})();
//# sourceMappingURL=forum.js.map