(()=>{var t={n:e=>{var r=e&&e.__esModule?()=>e.default:()=>e;return t.d(r,{a:r}),r},d:(e,r)=>{for(var n in r)t.o(r,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:r[n]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)};(()=>{"use strict";const e=flarum.core.compat["forum/app"];var r=t.n(e);const n=flarum.core.compat["common/extend"],i=flarum.core.compat["forum/components/DiscussionPage"];var o=t.n(i);const s=flarum.core.compat["forum/components/Post"];var a=t.n(s),u=new Map;function d(t){var e=Number(t);if(!e)return Promise.resolve();var r=u.get(e);if(r&&r.ready)return r.ready;var n={ready:null,map:new Map};return u.set(e,n),n.ready=app.request({method:"GET",url:app.forum.attribute("apiUrl")+"/discussions/"+e+"/threads-order"}).then(function(t){var r=new Map;(t.order||[]).forEach(function(t){var e=t.postId,n=t.order,i=t.depth,o=t.parentPostId;r.set(Number(e),{order:Number(n),depth:Number.isFinite(i)?Number(i):0,parentId:o?Number(o):null})}),n.map=r;try{window.dispatchEvent(new CustomEvent("threadify:order-ready",{detail:{discussionId:e}}))}catch(t){}}).catch(function(t){console.warn("[Threadify] threads-order prefetch failed",t)}),n.ready}function c(t,e){var r=u.get(Number(t));if(r)return r.map.get(Number(e))}function f(t){if(!t)return null;var e=t.discussion&&t.discussion(),r=e&&e.id&&e.id();if(!r)return null;var n=c(r,t.id());return n?{depth:n.depth,threadPath:null,isRoot:!n.parentId,childCount:0,descendantCount:0,rootPostId:null}:null}var l=new Map;function h(t){var e=Number(t);return Number.isFinite(e)?Math.max(0,Math.min(10,e)):0}function p(t){var e=function(t){if(!t||"function"!=typeof t.id)return 0;try{var e=t.discussion&&"function"==typeof t.discussion&&t.discussion()&&t.discussion().id&&t.discussion().id()||null;if(null!=e){var r=function(t,e){var r=l.get(String(t));if(r&&r.map){var n=r.map.get(Number(e));return n?n.depth:void 0}}(e,t.id());if(Number.isInteger(r))return h(r)}}catch(t){}try{var n=f(t);if(n&&Number.isInteger(n.depth))return h(n.depth)}catch(t){}return function(t){for(var e=0,r=0,n=new Set,i=t;i&&r<100;){var o=i.attribute?i.attribute("parent_id"):null;if(!o)break;if(n.has(o)){console.warn("[Threadify] cycle detected while walking parents of",t&&t.id&&t.id()),e=0;break}n.add(o),e+=1;var s=app.store.getById("posts",String(o));if(!s)break;if(i=s,r++,e>=10)break}return h(e)}(t)}(t),r=[];e>0?(r.push("threaded-post"),r.push("thread-depth-"+e),e>=3&&r.push("thread-deep"),e>=5&&r.push("thread-very-deep")):r.push("thread-root");try{var n=t.discussion&&"function"==typeof t.discussion&&t.discussion()&&t.discussion().id&&t.discussion().id()||null,i=null!=n?function(t,e){var r=l.get(String(t));if(r&&r.map){var n=r.map.get(Number(e));return n?n.parentId:void 0}}(n,t.id()):void 0,o=f(t);(null==i?!t.attribute||!t.attribute("parent_id"):null==i)&&r.push("thread-root-confirmed"),o&&Number.isInteger(o.childCount)&&o.childCount>0&&r.push("has-children","child-count-"+Math.min(o.childCount,10)),o&&Number.isInteger(o.descendantCount)&&o.descendantCount>0&&r.push("has-descendants")}catch(t){}return r}const y=flarum.core.compat["forum/components/ReplyComposer"];var v=t.n(y);const g=flarum.core.compat["forum/components/PostStream"];var b=t.n(g),_=null,w=null,N=-1,T=null;function O(t){if(t&&T){var e=t.stream&&t.stream.discussion&&t.stream.discussion.id();if(e){var r=T.call(t.stream);if(r&&r.length){var n,i,o=r.filter(function(t){return!!t}).length;if(n=e,!((i=u.get(Number(n)))&&i.map&&i.map.size))return d(e).finally(function(){}),w=r,void(N=o);w&&o===N||(w=function(t,e){for(var r=t.slice(),n=0,i=r.length-1;n<r.length&&!r[n];)n++;for(;i>=0&&!r[i];)i--;if(n>i)return r;var o=r.slice(n,i+1).filter(Boolean);o.sort(function(t,r){var n=c(e,t.id()),i=c(e,r.id()),o=n?n.order:Number.MAX_SAFE_INTEGER,s=i?i.order:Number.MAX_SAFE_INTEGER;return o===s?t.id()-r.id():o-s});for(var s=r.slice(),a=0,u=n;u<=i;u++)s[u]&&(s[u]=o[a++]||s[u]);return s}(r,e),N=o)}else w=r}}}flarum.core.compat["forum/states/PostStreamState"];var I=new Map;var S=!1;function C(t){setTimeout(function(){return function(){if(!S){false,S=!0;try{return t(null)}catch(e){console.error("[Threadify] Cache update failed:",e),t(null)}}function t(t){S=!1,setTimeout(function(){return m.redraw()},0)}}()},0)}function x(){(0,n.extend)(b().prototype,"oncreate",function(){var t=this.element;if(t){this.__threadifyObs&&this.__threadifyObs.disconnect();var e=null,r=new MutationObserver(function(t){t.some(function(t){return[].concat(t.addedNodes).some(function(t){return 1===t.nodeType&&t.matches&&t.matches(".PostStream-item[data-id]")})})&&(clearTimeout(e),e=setTimeout(function(){try{I.clear(),C()}catch(t){console.warn("[threadify] forceRebuildCache failed:",t)}},30))});r.observe(t,{childList:!0,subtree:!0}),this.__threadifyObs=r,this.__threadifyObsTimer=e}}),(0,n.extend)(b().prototype,"onremove",function(){this.__threadifyObs&&this.__threadifyObs.disconnect(),this.__threadifyObsTimer&&clearTimeout(this.__threadifyObsTimer),this.__threadifyObs=null,this.__threadifyObsTimer=null})}!function(){var t="threadify:logs",e=["log","info","warn","debug","error"];window.__threadifyConsoleOriginal||(window.__threadifyConsoleOriginal={},e.forEach(function(t){window.__threadifyConsoleOriginal[t]=console[t]?console[t].bind(console):function(){}}));var r="1"===("undefined"!=typeof localStorage?localStorage.getItem(t):null);function n(e){r=!!e,"undefined"!=typeof localStorage&&localStorage.setItem(t,r?"1":"0")}window.threadifyLogs={enable:function(){return n(!0),"Threadify logs: ON"},disable:function(){return n(!1),"Threadify logs: OFF"},toggle:function(){return n(!r),"Threadify logs: "+(r?"ON":"OFF")},status:function(){return r}},e.forEach(function(t){var e=window.__threadifyConsoleOriginal[t];console[t]=function(){for(var t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];var o=n&&n[0];if("string"!=typeof o||0!==o.indexOf("[Threadify]")||r)return e.apply(void 0,n)}})}(),r().initializers.add("syntaxoutlaw-threadify",function(){(0,n.extend)(a().prototype,"classes",function(t){var e=this.attrs.post;if(!e)return console.warn("[Threadify] No post in ThreadedPost.classes"),t;var r=p(e);return console.log("[Threadify] Adding classes to post "+e.id()+": "+r.join(", ")),r.forEach(function(e){t.push(e)}),t}),(0,n.extend)(v().prototype,"data",function(t){var e=function(t){if(!t||"string"!=typeof t)return null;var e=t.match(/@"[^"]*"#p(\d+)/);if(e&&e[1]){var r=parseInt(e[1],10);if(!isNaN(r)&&r>0)return r}return null}(t.content);return e&&(t.parent_id=e,console.log("[Threadify] Reply threading to post",e)),t}),(0,n.extend)(b().prototype,"oninit",function(){T||(T=this.stream.posts)}),(0,n.extend)(b().prototype,"oncreate",function(){var t=this.stream&&this.stream.discussion&&this.stream.discussion.id();t&&t!==_&&(_=t,w=null,N=-1,d(t)),O(this)}),(0,n.extend)(b().prototype,"onupdate",function(){O(this)}),(0,n.extend)(b().prototype,"posts",function(t){return w&&_===(this.stream&&this.stream.discussion&&this.stream.discussion.id())?w:t()}),x(),(0,n.extend)(o().prototype,"oninit",function(){var t=this.discussion&&"function"==typeof this.discussion.id&&this.discussion.id()||this.discussion&&this.discussion.id||null;t&&d(t)}),window.addEventListener("threadify:order-ready",function(t){var e=t&&t.detail&&t.detail.discussionId;if(e)try{var n=r().current&&r().current.get&&r().current.get("component"),i=n&&n.discussion&&"function"==typeof n.discussion.id&&n.discussion.id()||n&&n.discussion&&n.discussion.id||null;i&&String(i)===String(e)&&m.redraw()}catch(t){}})})})(),module.exports={}})();
//# sourceMappingURL=forum.js.map