(()=>{var e={n:t=>{var n=t&&t.__esModule?()=>t.default:()=>t;return e.d(n,{a:n}),n},d:(t,n)=>{for(var r in n)e.o(n,r)&&!e.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:n[r]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};(()=>{"use strict";const t=flarum.core.compat["forum/app"];var n=e.n(t);const r=flarum.core.compat["common/extend"],i=flarum.core.compat["forum/components/DiscussionPage"];var o=e.n(i);const a=flarum.core.compat["forum/components/DiscussionListItem"];var u=e.n(a);const s=flarum.core.compat["forum/components/Post"];var l=e.n(s),d=new Map;function c(e){if(!e)return null;var t=e.discussion&&e.discussion(),n=t&&t.id&&t.id();if(!n)return null;var r=function(e,t){var n=d.get(Number(e));if(n)return n.map.get(Number(t))}(n,e.id());return r?{depth:r.depth,threadPath:null,isRoot:!r.parentId,childCount:0,descendantCount:0,rootPostId:null}:null}var f=new Map;function h(e,t){void 0===t&&(t={});var n=m(e);if(!n)return Promise.resolve();var r=Date.now(),i=f.get(n)||{map:new Map,inflight:null,ts:0};if(f.set(n,i),!t.force&&r-i.ts<1e4)return i.inflight||Promise.resolve();if(i.inflight&&!t.force)return i.inflight;var o=r;return i.inflight=app.request({method:"GET",url:app.forum.attribute("apiUrl")+"/discussions/"+n+"/threads-order?bust="+o}).then(function(e){var t=new Map;(e&&e.order?e.order:[]).forEach(function(e){var n=e.postId,r=e.order,i=e.depth,o=e.parentPostId;n=Number(n),t.set(n,{order:Number(r),depth:Number.isFinite(i)?Number(i):0,parentId:o?Number(o):null})}),i.map=t,i.ts=Date.now();try{window.dispatchEvent(new CustomEvent("threadify:order-ready",{detail:{discussionId:Number(n)}}))}catch(e){}}).catch(function(e){console.warn("[Threadify] order prefetch failed",e)}).finally(function(){i.inflight=null}),i.inflight}function p(e){var t=m(e);if(t){var n=f.get(t);return n?n.map:void 0}}function m(e){if(null==e)return null;var t=Number(e);return Number.isFinite(t)&&t>0?String(t):null}function v(e){var t=Number(e);return Number.isFinite(t)?Math.max(0,Math.min(10,t)):0}function y(e){var t,n,r,i,o=function(e){if(!e||"function"!=typeof e.id)return 0;try{var t=e.discussion&&"function"==typeof e.discussion&&e.discussion()&&e.discussion().id&&e.discussion().id()||null;if(null!=t){var n=(r=t,i=e.id(),(a=(o=p(r))&&o.get(Number(i)))?a.depth:void 0);if(Number.isInteger(n))return v(n)}}catch(e){}var r,i,o,a;try{var u=c(e);if(u&&Number.isInteger(u.depth))return v(u.depth)}catch(e){}return function(e){for(var t=0,n=0,r=new Set,i=e;i&&n<100;){var o=i.attribute?i.attribute("parent_id"):null;if(!o)break;if(r.has(o)){console.warn("[Threadify] cycle detected while walking parents of",e&&e.id&&e.id()),t=0;break}r.add(o),t+=1;var a=app.store.getById("posts",String(o));if(!a)break;if(i=a,n++,t>=10)break}return v(t)}(e)}(e),a=[];o>0?(a.push("threaded-post"),a.push("thread-depth-"+o),o>=3&&a.push("thread-deep"),o>=5&&a.push("thread-very-deep")):a.push("thread-root");try{var u=e.discussion&&"function"==typeof e.discussion&&e.discussion()&&e.discussion().id&&e.discussion().id()||null,s=null!=u?(t=u,n=e.id(),(i=(r=p(t))&&r.get(Number(n)))?i.parentId:void 0):void 0,l=c(e);(null==s?!e.attribute||!e.attribute("parent_id"):null==s)&&a.push("thread-root-confirmed"),l&&Number.isInteger(l.childCount)&&l.childCount>0&&a.push("has-children","child-count-"+Math.min(l.childCount,10)),l&&Number.isInteger(l.descendantCount)&&l.descendantCount>0&&a.push("has-descendants")}catch(e){}return a}const b=flarum.core.compat["forum/components/ReplyComposer"];var g=e.n(b);const N=flarum.core.compat["forum/components/PostStream"];var w=e.n(N);function S(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(n)return(n=n.call(e)).next.bind(n);if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return I(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?I(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0;return function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function I(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}var P=1e7;function _(e){try{var t,n;return null!=(t=null==e||null==(n=e.stream)||null==(n=n.discussion)||null==n.id?void 0:n.id())?t:null}catch(e){return null}}function T(e){var t,n;return null!=e&&null!=(t=e.element)&&null!=(t=t.classList)&&t.contains("PostStream")?e.element:(null==e||null==(n=e.element)||null==n.querySelector?void 0:n.querySelector(".PostStream"))||document.querySelector(".PostStream")||null}function O(e){return e&&1===e.nodeType&&e.matches(".PostStream-item[data-id]")}function M(e){var t=Array.from((null==e?void 0:e.children)||[]);if(!t.length)return{posts:[],anchor:null};var n=t.findIndex(O);if(n<0)return{posts:[],anchor:t[0]||null};var r=t.length-1-[].concat(t).reverse().findIndex(O);return r<n&&(r=n),{posts:t.slice(n,r+1).filter(O),anchor:t[r+1]||null}}function x(e){try{return n().store.getById("posts",String(e))}catch(e){return null}}function C(e){try{var t=e&&"function"==typeof e.number?e.number():null;return Number.isFinite(t)?t:null}catch(e){return null}}function E(e){try{var t=e&&"function"==typeof e.createdAt?e.createdAt():null;return t instanceof Date?t.getTime():null}catch(e){return null}}function A(e,t){var n,r,i=function(e){try{var t;if(!e)return null;if("function"==typeof e.contentType)return e.contentType();if("function"==typeof e.attribute)return null!=(t=e.attribute("contentType"))?t:null}catch(e){}return null}(t);return!(!i||"comment"===i)||!!(null!=e&&null!=(n=e.classList)&&n.contains("EventPost")||null!=e&&null!=(r=e.classList)&&r.contains("Post-event"))||!(null==e||null==e.querySelector||!e.querySelector(".EventPost, .Post-event, .EventPost-icon"))}function D(e,t,n){if(e&&Number.isFinite(e.order))return Number(e.order);var r=C(t);if(null!=r)return r;var i=E(t);return null!=i?P/2+i:P+Number(n)}function F(e,t){var n=E(e);if(null!=n)return n;var r=C(e);return null!=r?P/2+r:P+Number(t)}function L(e,t){return function(e){var t=m(e);if(!t)return Promise.resolve(new Map);var n=Date.now(),r=f.get(t)||{map:new Map,inflight:null,ts:0};return f.set(t,r),n-r.ts<1e4&&r.map&&r.map.size>=0?Promise.resolve(r.map):(r.inflight||h(t)).then(function(){return p(t)||new Map})}(t).then(function(t){var n=M(e).posts;if(n.length){var r=function(e,t,n){for(var r,i=new Set(t.map(function(e){return Number(e.dataset.id)})),o=new Map(t.map(function(e){return[Number(e.dataset.id),x(Number(e.dataset.id))]})),a=new Map,u=S(t);!(r=u()).done;){var s=r.value,l=Number(s.dataset.id),d=n.get(l),c=o.get(l),f=d?d.parentId:null!=c&&c.attribute?c.attribute("parent_id"):null;a.set(l,null==f?null:Number(f))}for(var h,p=new Set,m=S(t);!(h=m()).done;){var v=h.value,y=Number(v.dataset.id);A(v,o.get(y))&&p.add(y)}for(var b,g=new Set,N=S(t);!(b=N()).done;){var w=b.value,I=Number(w.dataset.id);o.get(I),p.has(I)||null==a.get(I)&&g.add(I)}for(var P=!0;P;){P=!1;for(var _,T=S(t);!(_=T()).done;){var O=_.value,M=Number(O.dataset.id);if(!g.has(M)&&!p.has(M)){var C=a.get(M);null!=C&&i.has(C)&&g.has(C)&&(g.add(M),P=!0)}}}return{eligible:g,events:p,models:o}}(0,n,t||new Map),i=r.eligible,o=r.events,a=r.models,u=function(e,t,n,r,i){for(var o,a=e.filter(function(e){return t.has(Number(e.dataset.id))}),u=a.slice().sort(function(e,t){var n=Number(e.dataset.id),o=Number(t.dataset.id),a=D(r.get(n),i.get(n),n),u=D(r.get(o),i.get(o),o);return a===u?n-o:a-u}),s=[],l=0,d=S(e);!(o=d()).done;){var c=o.value,f=Number(c.dataset.id);t.has(f)?s.push(u[l++]):s.push(c)}var h=s.filter(function(e){return!n.has(Number(e.dataset.id))}),p=e.filter(function(e){return n.has(Number(e.dataset.id))});function m(e){var t=Number(e.dataset.id);return F(i.get(t),t)}p.sort(function(e,t){var n=Number(e.dataset.id),r=Number(t.dataset.id),o=F(i.get(n),n),a=F(i.get(r),r);return o===a?n-r:o-a});for(var v,y=h.slice(),b=S(p);!(v=b()).done;){for(var g=v.value,N=Number(g.dataset.id),w=F(i.get(N),N),I=-1,P=0;P<y.length;P++)if(m(y[P])>w){I=P;break}-1===I?y.push(g):y.splice(I,0,g)}return y}(n,i,o,t||new Map,a);if(!function(e,t){if(e.length!==t.length)return!1;for(var n=0;n<e.length;n++)if(e[n]!==t[n])return!1;return!0}(n,u)){var s=M(e),l=s.anchor&&s.anchor.parentNode===e?s.anchor:null;try{for(var d,c=S(u);!(d=c()).done;){var f=d.value;l&&l.parentNode===e?e.insertBefore(f,l):e.appendChild(f)}}catch(e){console.warn("[Threadify] reorder failed (retry next tick)",e)}}}}).catch(function(e){console.warn("[Threadify] order map unavailable",e)})}!function(){var e="threadify:logs",t=["log","info","warn","debug","error"];window.__threadifyConsoleOriginal||(window.__threadifyConsoleOriginal={},t.forEach(function(e){window.__threadifyConsoleOriginal[e]=console[e]?console[e].bind(console):function(){}}));var n="1"===("undefined"!=typeof localStorage?localStorage.getItem(e):null);function r(t){n=!!t,"undefined"!=typeof localStorage&&localStorage.setItem(e,n?"1":"0")}window.threadifyLogs={enable:function(){return r(!0),"Threadify logs: ON"},disable:function(){return r(!1),"Threadify logs: OFF"},toggle:function(){return r(!n),"Threadify logs: "+(n?"ON":"OFF")},status:function(){return n}},t.forEach(function(e){var t=window.__threadifyConsoleOriginal[e];console[e]=function(){for(var e=arguments.length,r=new Array(e),i=0;i<e;i++)r[i]=arguments[i];var o=r&&r[0];if("string"!=typeof o||0!==o.indexOf("[Threadify]")||n)return t.apply(void 0,r)}})}(),n().initializers.add("syntaxoutlaw-threadify",function(){(0,r.extend)(g().prototype,"data",function(e){var t=function(e){if(!e||"string"!=typeof e)return null;var t=e.match(/@"[^"]*"#p(\d+)/);if(t&&t[1]){var n=parseInt(t[1],10);if(!isNaN(n)&&n>0)return n}return null}(e.content);return t&&(e.parent_id=t,console.log("[Threadify] Reply threading to post",t)),e}),(0,r.extend)(l().prototype,"classes",function(e){var t=this.attrs.post;if(!t)return console.warn("[Threadify] No post in ThreadedPost.classes"),e;var n=y(t);return console.log("[Threadify] Adding classes to post "+t.id()+": "+n.join(", ")),n.forEach(function(t){e.push(t)}),e}),(0,r.extend)(w().prototype,"oncreate",function(){var e=_(this),t=T(this);if(e&&t){L(t,e);var n=!1,r=new MutationObserver(function(r){r.some(function(e){return"childList"===e.type})&&(n||(n=!0,requestAnimationFrame(function(){n=!1,L(t,e)})))});r.observe(t,{childList:!0}),this.__threadifyDomObserver=r}}),(0,r.extend)(w().prototype,"onupdate",function(){var e=_(this),t=T(this);e&&t&&L(t,e)}),(0,r.extend)(w().prototype,"onremove",function(){if(this.__threadifyDomObserver){try{this.__threadifyDomObserver.disconnect()}catch(e){}this.__threadifyDomObserver=null}}),(0,r.extend)(o().prototype,"oninit",function(){var e=this.discussion&&"function"==typeof this.discussion.id&&this.discussion.id()||this.discussion&&this.discussion.id||null;e&&h(e)}),(0,r.extend)(u().prototype,"oncreate",function(){var e=this.attrs.discussion;if(e){var t=e.id(),n=function(){return h(t)};this.element&&(this.element.addEventListener("mouseenter",n,{once:!0}),this.element.addEventListener("touchstart",n,{once:!0,passive:!0}))}})})})(),module.exports={}})();
//# sourceMappingURL=forum.js.map