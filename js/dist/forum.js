(()=>{var t={n:r=>{var e=r&&r.__esModule?()=>r.default:()=>r;return t.d(e,{a:e}),e},d:(r,e)=>{for(var n in e)t.o(e,n)&&!t.o(r,n)&&Object.defineProperty(r,n,{enumerable:!0,get:e[n]})},o:(t,r)=>Object.prototype.hasOwnProperty.call(t,r)};(()=>{"use strict";const r=flarum.core.compat["forum/app"];var e=t.n(r);const n=flarum.core.compat["common/extend"],o=flarum.core.compat["forum/components/DiscussionPage"];var i=t.n(o);const a=flarum.core.compat["forum/components/DiscussionListItem"];var u=t.n(a);const s=flarum.core.compat["forum/components/Post"];var d=t.n(s);function c(t){return t&&void 0!==t._threadDepth?{depth:t._threadDepth,threadPath:t._threadPath,isRoot:t._isRoot,childCount:t._childCount,descendantCount:t._descendantCount,rootPostId:t._rootPostId}:null}const l=flarum.core.compat["forum/components/ReplyComposer"];var f=t.n(l);const h=flarum.core.compat["forum/components/PostStream"];var p=t.n(h);const v=flarum.core.compat["forum/states/PostStreamState"];var y=t.n(v);function g(t){var r=[];function e(t,n){if(void 0===n&&(n=0),t){r.push(t);var o=t._threadChildren||[];o.sort(function(t,r){return(t.createdAt?t.createdAt().getTime():0)-(r.createdAt?r.createdAt().getTime():0)}),o.forEach(function(t){e(t,n+1)})}}return t.sort(function(t,r){return(t.createdAt?t.createdAt().getTime():0)-(r.createdAt?r.createdAt().getTime():0)}),t.forEach(function(t){e(t)}),r}function b(t){var r=function(t){var r=[],e=new Map,n=new Map;return t.forEach(function(t){if(t){var r=t.id();e.set(r,t),n.set(r,[])}}),t.forEach(function(t){if(t){t.id();var o=t.attribute("parent_id");o&&e.has(String(o))?n.get(String(o)).push(t):r.push(t)}}),t.forEach(function(t){t&&(t._threadChildren=n.get(t.id())||[])}),r}(t);return g(r)}var w=new Map;function _(){w.clear()}function A(t){return null==t?"":String(t)}function N(t,r){var e=new Map;return t.filter(Boolean).forEach(function(t){return e.set(A(t.id()),t)}),r.filter(Boolean).forEach(function(t){return e.set(A(t.id()),t)}),Array.from(e.values())}function P(t){var r=(t||[]).map(A).filter(Boolean);return 0===r.length?Promise.resolve([]):e().store.find("posts",{filter:{id:r.join(",")}})}function E(t,r){var e=(r||[]).filter(Boolean),n=new Set(e.map(function(t){return A(t.id())})),o=[];e.forEach(function(t){var r=A(null==t||null==t.attribute?void 0:t.attribute("parent_id"));r&&!n.has(r)&&o.push(r)});var i=Array.from(new Set(o));return 0===i.length?Promise.resolve(e):P(i).then(function(r){var n=N(e,r);return E(t,n)}).catch(function(t){return console.warn("[Threadify] Failed to load parent posts:",t),e})}function S(t,r){(null==r||r>t.length)&&(r=t.length);for(var e=0,n=Array(r);e<r;e++)n[e]=t[e];return n}var T=new Map;function M(t){var r=String(t),n=T.get(r);if(!0===(null==n?void 0:n.ready))return Promise.resolve();if(null!=n&&n.ready&&"function"==typeof n.ready.then)return n.ready;var o={map:new Map,ready:null};return T.set(r,o),o.ready=e().request({method:"GET",url:e().forum.attribute("apiUrl")+"/discussions/"+encodeURIComponent(r)+"/threads-order"}).then(function(t){for(var e,n=new Map,i=function(t,r){var e="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(e)return(e=e.call(t)).next.bind(e);if(Array.isArray(t)||(e=function(t,r){if(t){if("string"==typeof t)return S(t,r);var e={}.toString.call(t).slice(8,-1);return"Object"===e&&t.constructor&&(e=t.constructor.name),"Map"===e||"Set"===e?Array.from(t):"Arguments"===e||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e)?S(t,r):void 0}}(t))||r&&t&&"number"==typeof t.length){e&&(t=e);var n=0;return function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(Array.isArray(null==t?void 0:t.order)?t.order:[]);!(e=i()).done;){var a=e.value;if(a){var u=Number(a.postId),s=Number(a.order),d=Number(a.depth),c=null!=a.parentPostId?Number(a.parentPostId):null;Number.isNaN(u)||Number.isNaN(s)||n.set(u,{order:s,depth:Number.isNaN(d)?0:d,parentId:c})}}o.map=n,o.ready=!0;try{window.dispatchEvent(new CustomEvent("threadify:orderReady",{detail:Number(r)}))}catch(t){}try{setTimeout(function(){return m.redraw()},0)}catch(t){}}).catch(function(t){console.warn("[Threadify] order prefetch failed:",t),o.ready=!0}),o.ready}function I(t,r){var e=T.get(String(t));if(null!=e&&e.map){var n=e.map.get(Number(r));return n?n.order:void 0}}var x=!1,C=null,O=null,R="";function j(t){return!!t&&!!(t.loading||t.loadingPrevious||t.loadingNext||t.loadingNear||t._loadingPrevious||t._loadingNext)}function B(t,r,e){void 0===e&&(e=40);var n=t&&t.stream;if(!n)return r();if(!j(n))try{return requestAnimationFrame(function(){return r()})}catch(t){return setTimeout(r,0)}e<=0||setTimeout(function(){return B(t,r,e-1)},50)}function H(t){if(!x){x=!0;var r=function(t){C=t||null,x=!1;try{m.redraw()}catch(t){}};try{var e=(t.stream.posts()||[]).filter(function(t){return t&&"function"==typeof t.id});if(0===e.length)return r(null);var n=t.discussion?t:{discussion:t.stream.discussion};E(n,e).then(function(t){return function(t,r){var e=function(t){var r;return(null==t?void 0:t.discussion)||(null==t||null==(r=t.stream)?void 0:r.discussion)||null}(t),n=(r||[]).filter(Boolean),o=new Set(n.map(function(t){return A(t.id())}));if(!e||"function"!=typeof e.postIds)return Promise.resolve(n);var i=(e.postIds()||[]).map(A).filter(function(t){return t&&!o.has(t)});if(0===i.length)return Promise.resolve(n);var a=Math.min(10,i.length);return P(i.slice(-a)).then(function(t){var r=(t||[]).filter(function(t){var r=A(null==t||null==t.attribute?void 0:t.attribute("parent_id"));return r&&o.has(r)});return 0===r.length?n:N(n,r)}).catch(function(t){return console.warn("[Threadify] Failed to load child posts:",t),n})}(n,t).catch(function(){return t})}).then(function(t){var e=b(t),n=new Map,o=0;e.forEach(function(t){t&&"function"==typeof t.id&&n.set(t.id(),o++)}),r(n)}).catch(function(){var t=b(e),n=new Map,o=0;t.forEach(function(t){t&&"function"==typeof t.id&&n.set(t.id(),o++)}),r(n)})}catch(t){console.error("[Threadify] buildOrderMap failed:",t),r(null)}}}e().initializers.add("syntaxoutlaw-threadify",function(){(0,n.extend)(d().prototype,"classes",function(t){var r=this.attrs.post;if(!r)return console.warn("[Threadify] No post in ThreadedPost.classes"),t;var e=function(t){var r=function(t){if(!t)return 0;var r=c(t);return r?Math.min(r.depth,10):t.attribute("parent_id")?1:0}(t),e=[];r>0?(e.push("threaded-post"),e.push("thread-depth-"+r),r>=3&&e.push("thread-deep"),r>=5&&e.push("thread-very-deep")):e.push("thread-root");var n=c(t);return n&&(n.isRoot&&e.push("thread-root-confirmed"),n.childCount>0&&(e.push("has-children"),e.push("child-count-"+Math.min(n.childCount,10))),n.descendantCount>0&&e.push("has-descendants")),e}(r);return console.log("[Threadify] Adding classes to post "+r.id()+": "+e.join(", ")),e.forEach(function(r){t.push(r)}),t}),(0,n.extend)(f().prototype,"data",function(t){var r=function(t){if(!t||"string"!=typeof t)return null;var r=t.match(/@"[^"]*"#p(\d+)/);if(r&&r[1]){var e=parseInt(r[1],10);if(!isNaN(e)&&e>0)return e}return null}(t.content);return r&&(t.parent_id=r,console.log("[Threadify] Reply threading to post",r)),t}),(0,n.extend)(p().prototype,"oninit",function(){var t,r=this,e=null==(t=this.stream.discussion)||null==t.id?void 0:t.id();O!==e&&(O=e||null,C=null,x=!1,R="",_()),e&&M(e),this._threadifyOrderHandler=function(t){String(e)===String(null==t?void 0:t.detail)&&B(r,function(){return H(r)})};try{window.addEventListener("threadify:orderReady",this._threadifyOrderHandler)}catch(t){}B(this,function(){return H(r)})}),(0,n.extend)(p().prototype,"onupdate",function(){var t=this,r=(this.stream.posts()||[]).filter(function(t){return t&&"function"==typeof t.id}).map(function(t){return t.id()}).join(",");r!==R&&(R=r,_(),B(this,function(){return H(t)}))}),(0,n.extend)(p().prototype,"onremove",function(){try{this._threadifyOrderHandler&&(window.removeEventListener("threadify:orderReady",this._threadifyOrderHandler),this._threadifyOrderHandler=null)}catch(t){}}),(0,n.override)(y().prototype,"visiblePosts",function(t){var r,e=t.call(this);if(j(this))return e;var n=null==(r=this.discussion)||null==r.id?void 0:r.id();if(!n||!Array.isArray(e)||e.length<=1)return e;var o=e.slice();return o.sort(function(t,r){var e,o,i=!(!t||"function"!=typeof t.id),a=!(!r||"function"!=typeof r.id);if(!i||!a)return 0;var u=t.id(),s=r.id(),d=I(n,u),c=I(n,s);if(null!=d||null!=c){if(null==d)return 1;if(null==c)return-1;if(d!==c)return d-c}var l=null==(e=C)||null==e.get?void 0:e.get(u),f=null==(o=C)||null==o.get?void 0:o.get(s);if(null!=l||null!=f){if(null==l)return 1;if(null==f)return-1;if(l!==f)return l-f}return 0}),o}),(0,n.extend)(i().prototype,"oninit",function(){var t=this.discussion&&this.discussion.id&&this.discussion.id();t&&M(t)}),(0,n.extend)(u().prototype,"oncreate",function(){var t=this.attrs.discussion;if(t){var r=t.id(),e=function(){return M(r)};this.element&&this.element.addEventListener("mouseenter",e,{once:!0}),this.element&&this.element.addEventListener("touchstart",e,{once:!0,passive:!0})}})})})(),module.exports={}})();
//# sourceMappingURL=forum.js.map