(()=>{var t={n:e=>{var n=e&&e.__esModule?()=>e.default:()=>e;return t.d(n,{a:n}),n},d:(e,n)=>{for(var r in n)t.o(n,r)&&!t.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:n[r]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};(()=>{"use strict";t.r(e),t.d(e,{calculateThreadDepth:()=>x,clearThreadDepthCache:()=>M,createThreadedPosts:()=>C,extractParentIdFromContent:()=>A,getThreadifyStatus:()=>O,isThreadingActive:()=>b});const n=flarum.core.compat["forum/app"];var r=t.n(n);const o=flarum.core.compat["common/extend"],i=flarum.core.compat["forum/components/PostStream"];var a=t.n(i);const s=flarum.core.compat["forum/components/DiscussionPage"];var d=t.n(s);function u(t){if(!t)return console.log("[Threadify] shouldUseThreadsApi: no discussion, returning false"),!1;var e=app.forum&&"function"==typeof app.forum.attribute?app.forum.attribute("threadifyMode"):null,n=e||"default",r=(app.forum&&"function"==typeof app.forum.attribute?app.forum.attribute("threadifyTag"):null)||"threadify";if(console.log("[Threadify] shouldUseThreadsApi:","discussion id =","function"==typeof t.id?t.id():t.id,"mode from setting =",e,"effective mode =",n,"configured tag =",r),"default"===n)return console.log("[Threadify] shouldUseThreadsApi: mode=default → threading ENABLED for all discussions"),!0;if("tag"===n){var o=[];if("function"==typeof t.tags){var i=t.tags();Array.isArray(i)&&(o=i)}else t.data&&t.data.relationships&&t.data.relationships.tags&&(o=(t.data.relationships.tags.data||[]).map(function(t){return t&&t.id&&app.store&&app.store.getById?app.store.getById("tags",t.id):null}).filter(function(t){return t}));if(!o||!o.length)return console.log("[Threadify] shouldUseThreadsApi: mode=tag but discussion has no tags → threading DISABLED"),!1;var a=o.map(function(t){return t?"function"==typeof t.slug?t.slug():t.slug?t.slug:t.data&&t.data.attributes&&t.data.attributes.slug?t.data.attributes.slug:"(unknown)":"(null)"}),s=a.includes(r);return console.log("[Threadify] shouldUseThreadsApi: mode=tag, configured tag =",r,"discussion tags =",a,"→ hasConfiguredTag =",s),s}return console.log("[Threadify] shouldUseThreadsApi: unknown mode value",n,"→ threading DISABLED"),!1}function c(t){return t&&void 0!==t._threadDepth?{depth:t._threadDepth,threadPath:t._threadPath,isRoot:t._isRoot,childCount:t._childCount,descendantCount:t._descendantCount,rootPostId:t._rootPostId}:null}var l=!1,h=null,f=null,p=0;function g(t,e){return null!=t&&null!=e&&String(t)===String(e)}function y(t){t&&(f=t,l=!1,h=null,function(t){return console.log("[Threadify] Loading threads for discussion "+t),app.request({method:"GET",url:app.forum.attribute("apiUrl")+"/discussions/"+t+"/threads"}).then(function(t){console.log("[Threadify] Loaded "+t.data.length+" thread entries"),t.included&&(console.log("[Threadify] Processing "+t.included.length+" posts"),t.included.filter(function(t){return t&&t.type&&t.id}).forEach(function(t){app.store.pushObject(t)}));var e=t.data.map(function(t){var e=t.attributes.postId,n=app.store.getById("posts",e);return n&&(n._threadDepth=t.attributes.depth,n._threadPath=t.attributes.threadPath,n._isRoot=t.attributes.isRoot,n._childCount=t.attributes.childCount,n._descendantCount=t.attributes.descendantCount,n._rootPostId=t.attributes.rootPostId,n._parentPostId=t.attributes.parentPostId),n}).filter(function(t){return null!==t});return console.log("[Threadify] Processed "+e.length+" threaded posts (API order)"),e}).catch(function(t){return console.error("[Threadify] Failed to load discussion threads:",t),[]})}(t).then(function(e){g(f,t)&&(l=!0,p=(h=e||[]).filter(function(t){return t}).length,function(t,e){if(e&&e.length){var n=r().store.getById("discussions",String(t))||r().store.getById("discussions",Number(t));if(n){var o=e.map(function(t){return{type:"posts",id:String("function"==typeof t.id?t.id():t.id)}});n.data.relationships||(n.data.relationships={}),n.data.relationships.posts={data:o},n.freshness=new Date;var i=r().current.get("stream");i&&i.discussion===n&&(i.viewingEnd=function(){return!0})}else{var a;"undefined"!=typeof window&&window.threadifyDebug&&console.warn("[Threadify] Discussion not in store:",t,"store keys:",null!=(a=r().store.data)&&a.discussions?Object.keys(r().store.data.discussions):[])}}}(t,h),m.redraw())}).catch(function(){l=!0,h=null,m.redraw()}))}function v(){return{threadsLoaded:l,hasThreadedPosts:!!h,threadedPostCount:h?h.length:0,currentDiscussionId:f}}function T(){l=!1,h=null,f&&y(f),m.redraw()}function b(){return l&&!!h}const w=flarum.core.compat["forum/components/Post"];var I=t.n(w);const P=flarum.core.compat["forum/components/ReplyComposer"];var _=t.n(P);function A(t){if(!t||"string"!=typeof t)return null;var e=t.match(/@"[^"]*"#p(\d+)/);if(e&&e[1]){var n=parseInt(e[1],10);if(!isNaN(n)&&n>0)return n}return null}function D(t){var e=[];function n(t,r){if(void 0===r&&(r=0),t){e.push(t);var o=t._threadChildren||[];o.sort(function(t,e){return(t.createdAt?t.createdAt().getTime():0)-(e.createdAt?e.createdAt().getTime():0)}),o.forEach(function(t){n(t,r+1)})}}return t.sort(function(t,e){return(t.createdAt?t.createdAt().getTime():0)-(e.createdAt?e.createdAt().getTime():0)}),t.forEach(function(t){n(t)}),e}function C(t){var e=function(t){var e=[],n=new Map,r=new Map,o=function(t){return t&&"function"==typeof t.id?String(t.id()):String(t)};return t.forEach(function(t){if(t){var e=o(t);n.set(e,t),r.set(e,[])}}),t.forEach(function(t){var o;if(t){var i=null!=(o=t.attribute("parent_id"))?o:t._parentPostId,a=null!=i?String(i):null;a&&n.has(a)?r.get(a).push(t):e.push(t)}}),t.forEach(function(t){t&&(t._threadChildren=r.get(o(t))||[])}),e}(t);return D(e)}var S=new Map,E=10;function x(t,e){var n=t.id();if(S.has(n))return S.get(n);var r=t.attribute("parent_id");if(!r)return S.set(n,0),0;if(!e.find(function(t){return t&&t.id()==r}))return S.set(n,0),0;var o=B(t,e,new Set);return S.set(n,o),o}function B(t,e,n){var r=t.id();if(n.has(r))return console.warn("[Threadify] Cycle detected for post "+r),0;if(S.has(r))return S.get(r);var o=t.attribute("parent_id");if(!o)return 0;var i=e.find(function(t){return t&&t.id()==o});if(!i)return 0;n.add(r);var a=B(i,e,n)+1;return n.delete(r),Math.min(a,E)}function M(){S.clear()}function O(){return{version:"1.1",name:"Threadify",author:"syntaxoutlaw",isActive:!0,components:{postStream:"loaded",post:"loaded",replyComposer:"loaded"},features:["Post threading via mentions","Automatic parent/child post loading","Visual thread depth indication","Thread tree caching for performance"]}}app.initializers.add("syntaxoutlaw-threadify",function(){try{(0,o.extend)(d().prototype,"show",function(t){return function(e){if(t.call(this,e),this.stream&&this.stream.discussion){var n=this.stream.discussion,r=n.id();g(f,r)||(f=r,l=!1,h=null),u(n)&&y(r)}}}),(0,o.extend)(a().prototype,"oninit",function(){var t=this.stream;if(t&&t.discussion){var e=t.discussion.id();g(f,e)||(f=e,l=!1,h=null),u(t.discussion)&&(t.viewingEnd=function(){return!0},l||y(e))}}),(0,o.extend)(a().prototype,"onupdate",function(){if(u(this.stream.discussion)){var t=this.stream,e=t.discussion?(t.discussion.postIds()||[]).length:0;e!==p&&(p=e,l=!1,h=null,y(t.discussion.id()))}}),(0,o.extend)(I().prototype,"classes",function(t){var e=this.attrs.post;if(!e)return console.warn("[Threadify] No post in ThreadedPost.classes"),t;var n="function"==typeof e.discussion?e.discussion():null;return n&&u(n)?(function(t){var e=function(t){if(!t)return 0;var e=c(t);return e?Math.min(e.depth,10):t.attribute("parent_id")?1:0}(t),n=[];e>0?(n.push("threaded-post"),n.push("thread-depth-"+e),e>=3&&n.push("thread-deep"),e>=5&&n.push("thread-very-deep")):n.push("thread-root");var r=c(t);return r&&(r.isRoot&&n.push("thread-root-confirmed"),r.childCount>0&&(n.push("has-children"),n.push("child-count-"+Math.min(r.childCount,10))),r.descendantCount>0&&n.push("has-descendants")),n}(e).forEach(function(e){t.push(e)}),t):t}),(0,o.extend)(_().prototype,"data",function(t){var e=A(t.content);return e&&(t.parent_id=e,console.log("[Threadify] Reply threading to post",e)),t}),console.log("[Threadify] Threaded extension loaded"),window.threadifyDebug={getState:v,reload:T,isActive:b,help:function(){console.log("\n[Threadify] Debug Commands:\n- threadifyDebug.getState() - Get current threading state\n- threadifyDebug.reload() - Force reload threads for current discussion\n- threadifyDebug.isActive() - Check if threading is currently active\n- threadifyDebug.diagnose() - Log why order might be wrong on this page\n- threadifyDebug.help() - Show this help\n        ")},diagnose:function(){var t=app.current.get("discussion"),e=v(),n=t?app.store.getById("discussions",String(t.id()))||app.store.getById("discussions",Number(t.id())):null,r=t?t.postIds&&t.postIds():null;console.log("[Threadify] Diagnose:",{state:e,hasCurrentDiscussion:!!t,discussionId:t?t.id():null,discussionInStore:!!n,sameObject:t===n,postIdsLength:r?r.length:0,postIdsFirstFive:r?r.slice(0,5):null,relationshipOrder:t&&t.data&&t.data.relationships&&t.data.relationships.posts?t.data.relationships.posts.data.slice(0,5).map(function(t){return t.id}):null})}}}catch(t){console.error("[Threadify] Failed to initialize:",t)}})})(),module.exports=e})();
//# sourceMappingURL=forum.js.map