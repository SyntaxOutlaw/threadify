(()=>{var t={n:e=>{var r=e&&e.__esModule?()=>e.default:()=>e;return t.d(r,{a:r}),r},d:(e,r)=>{for(var n in r)t.o(r,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:r[n]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)};(()=>{"use strict";const e=flarum.core.compat["forum/app"];var r=t.n(e);const n=flarum.core.compat["common/extend"],o=flarum.core.compat["forum/components/DiscussionPage"];var a=t.n(o);const s=flarum.core.compat["forum/components/DiscussionListItem"];var i=t.n(s);const u=flarum.core.compat["forum/components/Post"];var d=t.n(u);function c(t){return t&&void 0!==t._threadDepth?{depth:t._threadDepth,threadPath:t._threadPath,isRoot:t._isRoot,childCount:t._childCount,descendantCount:t._descendantCount,rootPostId:t._rootPostId}:null}const p=flarum.core.compat["forum/components/ReplyComposer"];var h=t.n(p);const l=flarum.core.compat["forum/states/PostStreamState"];var f=t.n(l);const v=flarum.core.compat["forum/components/PostStream"];var y=t.n(v),g=new Map;function P(t){var e=String(t);if(g.has(e)&&g.get(e).ready)return g.get(e).ready;var n={map:new Map,ready:null};return g.set(e,n),n.ready=r().request({method:"GET",url:r().forum.attribute("apiUrl")+"/discussions/"+e+"/threads-order"}).then(function(t){var e=new Map;(t.order||[]).forEach(function(t){var r=t.postId,n=t.order,o=t.depth,a=t.parentPostId;e.set(Number(r),{order:Number(n),depth:Number(o),parentId:a?Number(a):null})}),n.map=e,m.redraw()}).catch(function(t){console.warn("[Threadify] order prefetch failed",t)}),n.ready}function _(t,e){var r=g.get(String(t));if(r&&r.map){var n=r.map.get(Number(e));return n?n.order:void 0}}var x=0;r().initializers.add("syntaxoutlaw-threadify",function(){(0,n.extend)(d().prototype,"classes",function(t){var e=this.attrs.post;if(!e)return console.warn("[Threadify] No post in ThreadedPost.classes"),t;var r=function(t){var e=function(t){if(!t)return 0;var e=c(t);return e?Math.min(e.depth,10):t.attribute("parent_id")?1:0}(t),r=[];e>0?(r.push("threaded-post"),r.push("thread-depth-"+e),e>=3&&r.push("thread-deep"),e>=5&&r.push("thread-very-deep")):r.push("thread-root");var n=c(t);return n&&(n.isRoot&&r.push("thread-root-confirmed"),n.childCount>0&&(r.push("has-children"),r.push("child-count-"+Math.min(n.childCount,10))),n.descendantCount>0&&r.push("has-descendants")),r}(e);return console.log("[Threadify] Adding classes to post "+e.id()+": "+r.join(", ")),r.forEach(function(e){t.push(e)}),t}),(0,n.extend)(h().prototype,"data",function(t){var e=function(t){if(!t||"string"!=typeof t)return null;var e=t.match(/@"[^"]*"#p(\d+)/);if(e&&e[1]){var r=parseInt(e[1],10);if(!isNaN(r)&&r>0)return r}return null}(t.content);return e&&(t.parent_id=e,console.log("[Threadify] Reply threading to post",e)),t}),(0,n.extend)(y().prototype,"oninit",function(){var t=this.stream&&this.stream.discussion&&this.stream.discussion.id();t&&P(t)}),(0,n.override)(f().prototype,"_loadPrevious",function(t){x++;for(var e=arguments.length,r=new Array(e>1?e-1:0),n=1;n<e;n++)r[n-1]=arguments[n];var o=t.apply(void 0,r);return Promise.resolve(o).finally(function(){x=Math.max(0,x-1)})}),(0,n.override)(f().prototype,"_loadNext",function(t){x++;for(var e=arguments.length,r=new Array(e>1?e-1:0),n=1;n<e;n++)r[n-1]=arguments[n];var o=t.apply(void 0,r);return Promise.resolve(o).finally(function(){x=Math.max(0,x-1)})}),(0,n.extend)(f().prototype,"visiblePosts",function(t){if(!Array.isArray(t)||t.length<=1)return t;if(x>0)return t;var e=this.discussion&&this.discussion.id&&this.discussion.id(),r=t.slice();return r.sort(function(t,r){var n=t&&t.id?t.id():null,o=r&&r.id?r.id():null;if(!n||!o)return 0;var a=_(e,n),s=_(e,o);return null==a&&null==s?0:null==a?1:null==s?-1:a-s}),r}),(0,n.extend)(a().prototype,"oninit",function(){var t=this.discussion&&this.discussion.id&&this.discussion.id();t&&P(t)}),(0,n.extend)(i().prototype,"oncreate",function(){var t=this.attrs.discussion;if(t){var e=t.id(),r=function(){return P(e)};this.element&&this.element.addEventListener("mouseenter",r,{once:!0}),this.element&&this.element.addEventListener("touchstart",r,{once:!0,passive:!0})}})})})(),module.exports={}})();
//# sourceMappingURL=forum.js.map