(()=>{var t={n:e=>{var r=e&&e.__esModule?()=>e.default:()=>e;return t.d(r,{a:r}),r},d:(e,r)=>{for(var n in r)t.o(r,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:r[n]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)};(()=>{"use strict";const e=flarum.core.compat["forum/app"];var r=t.n(e);const n=flarum.core.compat["common/extend"],o=flarum.core.compat["forum/components/DiscussionPage"];var i=t.n(o);const a=flarum.core.compat["forum/components/DiscussionListItem"];var u=t.n(a);const s=flarum.core.compat["forum/components/Post"];var c=t.n(s);function d(t){return t&&void 0!==t._threadDepth?{depth:t._threadDepth,threadPath:t._threadPath,isRoot:t._isRoot,childCount:t._childCount,descendantCount:t._descendantCount,rootPostId:t._rootPostId}:null}const l=flarum.core.compat["forum/components/ReplyComposer"];var f=t.n(l);const h=flarum.core.compat["forum/components/PostStream"];var p=t.n(h);function v(t){var e=[];function r(t,n){if(void 0===n&&(n=0),t){e.push(t);var o=t._threadChildren||[];o.sort(function(t,e){return(t.createdAt?t.createdAt().getTime():0)-(e.createdAt?e.createdAt().getTime():0)}),o.forEach(function(t){r(t,n+1)})}}return t.sort(function(t,e){return(t.createdAt?t.createdAt().getTime():0)-(e.createdAt?e.createdAt().getTime():0)}),t.forEach(function(t){r(t)}),e}var g=new Map;function y(){g.clear()}function P(t){return null==t?"":String(t)}function b(t,e){var n=(e||[]).filter(Boolean),o=new Set(n.map(function(t){return P(t.id())})),i=[];n.forEach(function(t){var e=P(null==t||null==t.attribute?void 0:t.attribute("parent_id"));e&&!o.has(e)&&i.push(e)});var a,u,s=Array.from(new Set(i));return 0===s.length?Promise.resolve(n):(a=s,u=(a||[]).map(P).filter(Boolean),0===u.length?Promise.resolve([]):r().store.find("posts",{filter:{id:u.join(",")}})).then(function(e){var r,o,i,a=(r=n,o=e,i=new Map,r.filter(Boolean).forEach(function(t){return i.set(P(t.id()),t)}),o.filter(Boolean).forEach(function(t){return i.set(P(t.id()),t)}),Array.from(i.values()));return b(t,a)}).catch(function(t){return console.warn("[Threadify] Failed to load parent posts:",t),n})}var _=new Map;function w(t){var e=String(t),r=_.get(e);if(r&&!0===r.ready)return Promise.resolve();if(r&&r.ready&&"function"==typeof r.ready.then)return r.ready;var n={map:new Map,ready:null};return _.set(e,n),n.ready=app.request({method:"GET",url:app.forum.attribute("apiUrl")+"/discussions/"+e+"/threads-order"}).then(function(t){var e=new Map;(t.order||[]).forEach(function(t){var r=t.postId,n=t.order,o=t.depth,i=t.parentPostId;e.set(Number(r),{order:Number(n),depth:Number(o),parentId:i?Number(i):null})}),n.map=e,n.ready=!0}).catch(function(t){console.warn("[Threadify] order prefetch failed",t),n.ready=!0}),n.ready}function A(t,e){var r=_.get(String(t));if(r&&r.map){var n=r.map.get(Number(e));return n?n.order:void 0}}var T=!1,E=null,x=0,M=null,C=null;function N(t){return!!t&&!!(t.loading||t.loadingPrevious||t.loadingNext||t.loadingNear||t._loadingPrevious||t._loadingNext)}function S(t){if(!T){T=!0;var e,r,n=function(t){E=t,T=!1,setTimeout(function(){try{m.redraw()}catch(t){}},0)};try{if(!M)return n(null);var o=M.call(t.stream)||[],i=o.filter(Boolean);if(0===i.length)return n(null);var a=t.stream.discussion&&t.stream.discussion.id&&t.stream.discussion.id();(e=a,r=i,Promise.resolve().then(function(){if(!e||!Array.isArray(r)||0===r.length)return null;if(!r.some(function(t){return A(e,t.id&&t.id())}))return null;var t=r.slice();return t.sort(function(t,r){var n=t&&t.id&&t.id(),o=r&&r.id&&r.id(),i=A(e,n),a=A(e,o);if(null!=i||null!=a){if(null==i&&null==a)return 0;if(null==i)return 1;if(null==a)return-1;if(i!==a)return i-a}return 0}),t})).then(function(e){if(e&&e.length){var r=B(e,o.length);n(r)}else(function(t,e){return b(t.discussion?t:{discussion:t.stream.discussion},e).catch(function(){return I(e)})})(t,i).then(function(t){return t}).then(function(t){var e=B(function(t){var e=function(t){var e=[],r=new Map,n=new Map;return t.forEach(function(t){if(t){var e=t.id();r.set(e,t),n.set(e,[])}}),t.forEach(function(t){if(t){t.id();var o=t.attribute("parent_id");o&&r.has(String(o))?n.get(String(o)).push(t):e.push(t)}}),t.forEach(function(t){t&&(t._threadChildren=n.get(t.id())||[])}),e}(t);return v(e)}(t),o.length);n(e)}).catch(function(t){console.warn("[Threadify] prefetch & fallback threading both failed:",t),n(null)})})}catch(t){console.error("[Threadify] buildCacheWithPrefetch failed:",t),T=!1}}}function B(t,e){for(var r=Array.isArray(t)?t.slice():[],n=Math.max(0,e-r.length),o=0;o<n;o++)r.push(null);return r}function I(t){var e=new Map(t.filter(Boolean).map(function(t){return[String(t.id()),t]})),n=[];return t.forEach(function(t){var r=t&&t.attribute?t.attribute("parent_id"):null;r&&!e.has(String(r))&&n.push(String(r))}),0===n.length?Promise.resolve(t):r().store.find("posts",{filter:{id:n.join(",")}}).then(function(e){return I([].concat(t,e))}).catch(function(){return t})}r().initializers.add("syntaxoutlaw-threadify",function(){(0,n.extend)(c().prototype,"classes",function(t){var e=this.attrs.post;if(!e)return console.warn("[Threadify] No post in ThreadedPost.classes"),t;var r=function(t){var e=function(t){if(!t)return 0;var e=d(t);return e?Math.min(e.depth,10):t.attribute("parent_id")?1:0}(t),r=[];e>0?(r.push("threaded-post"),r.push("thread-depth-"+e),e>=3&&r.push("thread-deep"),e>=5&&r.push("thread-very-deep")):r.push("thread-root");var n=d(t);return n&&(n.isRoot&&r.push("thread-root-confirmed"),n.childCount>0&&(r.push("has-children"),r.push("child-count-"+Math.min(n.childCount,10))),n.descendantCount>0&&r.push("has-descendants")),r}(e);return console.log("[Threadify] Adding classes to post "+e.id()+": "+r.join(", ")),r.forEach(function(e){t.push(e)}),t}),(0,n.extend)(f().prototype,"data",function(t){var e=function(t){if(!t||"string"!=typeof t)return null;var e=t.match(/@"[^"]*"#p(\d+)/);if(e&&e[1]){var r=parseInt(e[1],10);if(!isNaN(r)&&r>0)return r}return null}(t.content);return e&&(t.parent_id=e,console.log("[Threadify] Reply threading to post",e)),t}),(0,n.extend)(p().prototype,"oninit",function(){var t=this,e=this.stream.discussion&&this.stream.discussion.id&&this.stream.discussion.id();C!==e&&(C=e,T=!1,E=null,x=0,M=null,y()),M||(M=this.stream.posts),e&&w(e),this.stream.posts=function(){if(E)return E;var e=M.call(t.stream)||[];return!T&&e.filter(Boolean).length>0&&S(t),e};var r=M.call(this.stream)||[];(x=r.filter(Boolean).length)>0&&S(this)}),(0,n.extend)(p().prototype,"onupdate",function(){var t=this;if(M){var e=(M.call(this.stream)||[]).filter(Boolean).length;e!==x&&(x=e,E=null,y(),N(this.stream)?setTimeout(function(){N(t.stream)||S(t)},60):S(this))}}),(0,n.extend)(i().prototype,"oninit",function(){var t=this.discussion&&this.discussion.id&&this.discussion.id();t&&w(t)}),(0,n.extend)(u().prototype,"oncreate",function(){var t=this.attrs.discussion;if(t){var e=t.id(),r=function(){return w(e)};this.element&&this.element.addEventListener("mouseenter",r,{once:!0}),this.element&&this.element.addEventListener("touchstart",r,{once:!0,passive:!0})}})})})(),module.exports={}})();
//# sourceMappingURL=forum.js.map