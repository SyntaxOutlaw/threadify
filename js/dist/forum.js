(()=>{var t={n:e=>{var r=e&&e.__esModule?()=>e.default:()=>e;return t.d(r,{a:r}),r},d:(e,r)=>{for(var n in r)t.o(r,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:r[n]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)};(()=>{"use strict";const e=flarum.core.compat["forum/app"];var r=t.n(e);const n=flarum.core.compat["common/extend"],i=flarum.core.compat["forum/components/DiscussionPage"];var o=t.n(i);const a=flarum.core.compat["forum/components/DiscussionListItem"];var s=t.n(a);const u=flarum.core.compat["forum/components/Post"];var d=t.n(u);function c(t){return t&&void 0!==t._threadDepth?{depth:t._threadDepth,threadPath:t._threadPath,isRoot:t._isRoot,childCount:t._childCount,descendantCount:t._descendantCount,rootPostId:t._rootPostId}:null}var l=new Map;function f(t){var e=String(t);if(l.has(e)&&l.get(e).ready)return l.get(e).ready;var r={map:new Map,ready:null};return l.set(e,r),r.ready=app.request({method:"GET",url:app.forum.attribute("apiUrl")+"/discussions/"+e+"/threads-order"}).then(function(t){var n=new Map;(t.order||[]).forEach(function(t){var e=t.postId,r=t.order,i=t.depth,o=t.parentPostId;n.set(Number(e),{order:Number(r),depth:Number.isFinite(i)?Number(i):0,parentId:o?Number(o):null})}),r.map=n;try{window.dispatchEvent(new CustomEvent("threadify:order-ready",{detail:{discussionId:Number(e)}}))}catch(t){}}).catch(function(t){console.warn("[Threadify] order prefetch failed",t)}),r.ready}function p(t,e){var r=l.get(String(t));if(r&&r.map){var n=r.map.get(Number(e));return n?n.depth:void 0}}function h(t){var e=Number(t);return Number.isFinite(e)?Math.max(0,Math.min(10,e)):0}function m(t){var e=function(t){if(!t||"function"!=typeof t.id)return 0;try{var e=t.discussion&&"function"==typeof t.discussion&&t.discussion()&&t.discussion().id&&t.discussion().id()||null;if(null!=e){var r=p(e,t.id());if(Number.isInteger(r))return h(r)}}catch(t){}try{var n=c(t);if(n&&Number.isInteger(n.depth))return h(n.depth)}catch(t){}return function(t){for(var e=0,r=0,n=new Set,i=t;i&&r<100;){var o=i.attribute?i.attribute("parent_id"):null;if(!o)break;if(n.has(o)){console.warn("[Threadify] cycle detected while walking parents of",t&&t.id&&t.id()),e=0;break}n.add(o),e+=1;var a=app.store.getById("posts",String(o));if(!a)break;if(i=a,r++,e>=10)break}return h(e)}(t)}(t),r=[];e>0?(r.push("threaded-post"),r.push("thread-depth-"+e),e>=3&&r.push("thread-deep"),e>=5&&r.push("thread-very-deep")):r.push("thread-root");try{var n=t.discussion&&"function"==typeof t.discussion&&t.discussion()&&t.discussion().id&&t.discussion().id()||null,i=null!=n?function(t,e){var r=l.get(String(t));if(r&&r.map){var n=r.map.get(Number(e));return n?n.parentId:void 0}}(n,t.id()):void 0,o=c(t);(null==i?!t.attribute||!t.attribute("parent_id"):null==i)&&r.push("thread-root-confirmed"),o&&Number.isInteger(o.childCount)&&o.childCount>0&&r.push("has-children","child-count-"+Math.min(o.childCount,10)),o&&Number.isInteger(o.descendantCount)&&o.descendantCount>0&&r.push("has-descendants")}catch(t){}return r}const v=flarum.core.compat["forum/components/ReplyComposer"];var y=t.n(v);const g=flarum.core.compat["forum/components/PostStream"];var b=t.n(g);const w=flarum.core.compat["forum/states/PostStreamState"];var S=t.n(w),N=!1,P=!1,_=null,I=null,x=new Set;function E(t){N?P=!0:(I&&cancelAnimationFrame(I),I=requestAnimationFrame(function(){try{!function(t){var e=t&&t.element;if(e){var r=T(e);if(r){!function(t){var e=t.style;"flex"!==e.display&&(e.display="flex",e.flexDirection="column")}(r);var n=t.stream&&t.stream.discussion&&t.stream.discussion.id(),i=Array.from(r.querySelectorAll("article.Post[data-id]"));i.forEach(function(t){var e=Number(t.dataset.id);Number.isFinite(e)&&x.add(e)}),i.forEach(function(t){var e=Number(t.dataset.id);if(Number.isFinite(e)){var r=function(t,e){var r=l.get(String(t));if(r&&r.map){var n=r.map.get(Number(e));return n?n.order:void 0}}(n,e),i=Number.isInteger(r)?r:1e7+e;t.style.order=String(i),function(t){var e=[];t.classList.forEach(function(t){0!==t.indexOf("thread-depth-")&&"threaded-post"!==t&&"thread-deep"!==t&&"thread-very-deep"!==t&&"thread-root"!==t||e.push(t)}),e.forEach(function(e){return t.classList.remove(e)})}(t);var o=p(n,e);Number.isFinite(o)&&o>0?(t.classList.add("threaded-post","thread-depth-"+Math.min(o,10)),o>=3&&t.classList.add("thread-deep"),o>=5&&t.classList.add("thread-very-deep")):t.classList.add("thread-root")}})}}}(t)}catch(t){console.warn("[Threadify] flex apply failed:",t)}}))}function C(t){var e=t.discussion&&t.discussion.postStream?t.discussion.postStream:null;e&&E(e)}function T(t){return t?t.classList&&(t.classList.contains("PostStream")||t.matches(".PostStream"))?t:t.querySelector(".PostStream")||t.querySelector(".DiscussionPage-list")||t.querySelector(".PostStream-items")||t:null}!function(){var t="threadify:logs",e=["log","info","warn","debug","error"];window.__threadifyConsoleOriginal||(window.__threadifyConsoleOriginal={},e.forEach(function(t){window.__threadifyConsoleOriginal[t]=console[t]?console[t].bind(console):function(){}}));var r="1"===("undefined"!=typeof localStorage?localStorage.getItem(t):null);function n(e){r=!!e,"undefined"!=typeof localStorage&&localStorage.setItem(t,r?"1":"0")}window.threadifyLogs={enable:function(){return n(!0),"Threadify logs: ON"},disable:function(){return n(!1),"Threadify logs: OFF"},toggle:function(){return n(!r),"Threadify logs: "+(r?"ON":"OFF")},status:function(){return r}},e.forEach(function(t){var e=window.__threadifyConsoleOriginal[t];console[t]=function(){for(var t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];var o=n&&n[0];if("string"!=typeof o||0!==o.indexOf("[Threadify]")||r)return e.apply(void 0,n)}})}(),r().initializers.add("syntaxoutlaw-threadify",function(){(0,n.extend)(d().prototype,"classes",function(t){var e=this.attrs.post;if(!e)return console.warn("[Threadify] No post in ThreadedPost.classes"),t;var r=m(e);return console.log("[Threadify] Adding classes to post "+e.id()+": "+r.join(", ")),r.forEach(function(e){t.push(e)}),t}),(0,n.extend)(y().prototype,"data",function(t){var e=function(t){if(!t||"string"!=typeof t)return null;var e=t.match(/@"[^"]*"#p(\d+)/);if(e&&e[1]){var r=parseInt(e[1],10);if(!isNaN(r)&&r>0)return r}return null}(t.content);return e&&(t.parent_id=e,console.log("[Threadify] Reply threading to post",e)),t}),(0,n.override)(S().prototype,"_loadPrevious",function(t){var e=this;N=!0;for(var r=arguments.length,n=new Array(r>1?r-1:0),i=1;i<r;i++)n[i-1]=arguments[i];var o=t.apply(void 0,n);return Promise.resolve(o).finally(function(){N=!1,P&&(P=!1,C(e))})}),(0,n.override)(S().prototype,"_loadNext",function(t){var e=this;N=!0;for(var r=arguments.length,n=new Array(r>1?r-1:0),i=1;i<r;i++)n[i-1]=arguments[i];var o=t.apply(void 0,n);return Promise.resolve(o).finally(function(){N=!1,P&&(P=!1,C(e))})}),(0,n.extend)(b().prototype,"oncreate",function(){var t=this.stream&&this.stream.discussion&&this.stream.discussion.id();_!==t&&(_=t,x.clear()),function(t,e){if(e){var r=T(t&&t.element);if(r){var n=!1,i=function(){n||(n=!0,r.style.transition="opacity 90ms ease",r.style.opacity="1")};r.style.opacity="0";var o=setTimeout(i,180);f(e).finally(function(){clearTimeout(o),i()})}}}(this,t),E(this)}),(0,n.extend)(b().prototype,"onupdate",function(){var t,e,r=this,n=this.stream&&this.stream.discussion&&this.stream.discussion.id(),i=(t=this.element,e=new Set,t?(t.querySelectorAll("article.Post[data-id]").forEach(function(t){var r=Number(t.dataset.id);Number.isFinite(r)&&e.add(r)}),e):e),o=!1;i.forEach(function(t){x.has(t)||(o=!0,x.add(t))}),o&&n?f(n).finally(function(){return E(r)}):E(this)}),window.addEventListener("threadify:order-ready",function(t){var e=t&&t.detail&&t.detail.discussionId;if(e){var r=function(){var t;if(!document.querySelector(".PostStream")&&!(null==(t=document.querySelector("article.Post"))?void 0:t.closest("*")))return null;app.current&&app.current.get&&"discussion"===app.current.get("route")&&app.current.get("component");var e=app.current&&app.current.get&&app.current.get("discussion");return e&&e.postStream?e.postStream:null}();if(r){var n=r.stream&&r.stream.discussion&&r.stream.discussion.id();Number(n)===Number(e)&&E(r)}}}),(0,n.extend)(o().prototype,"oninit",function(){var t=this.discussion&&"function"==typeof this.discussion.id&&this.discussion.id()||this.discussion&&this.discussion.id||null;t&&f(t)}),(0,n.extend)(s().prototype,"oncreate",function(){var t=this.attrs.discussion;if(t){var e=t.id(),r=function(){return f(e)};this.element&&(this.element.addEventListener("mouseenter",r,{once:!0}),this.element.addEventListener("touchstart",r,{once:!0,passive:!0}))}})})})(),module.exports={}})();
//# sourceMappingURL=forum.js.map