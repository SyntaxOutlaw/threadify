(()=>{var t={n:e=>{var r=e&&e.__esModule?()=>e.default:()=>e;return t.d(r,{a:r}),r},d:(e,r)=>{for(var n in r)t.o(r,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:r[n]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};(()=>{"use strict";t.r(e),t.d(e,{calculateThreadDepth:()=>x,clearThreadDepthCache:()=>L,createThreadedPosts:()=>S,extractParentIdFromContent:()=>P,getThreadifyStatus:()=>M,isThreadingActive:()=>T});const r=flarum.core.compat["forum/app"];var n=t.n(r);const o=flarum.core.compat["common/extend"],a=flarum.core.compat["forum/components/PostStream"];var i=t.n(a);const s=flarum.core.compat["forum/components/DiscussionPage"];var d=t.n(s);function u(t){if(!t)return console.log("[Threadify] shouldUseThreadsApi: no discussion, returning false"),!1;var e,r=app.forum&&"function"==typeof app.forum.attribute?app.forum.attribute("threadifyMode"):null,n=r||"default",o=app.forum&&"function"==typeof app.forum.attribute?app.forum.attribute("threadifyTags"):void 0;if(Array.isArray(o))e=o;else if(app.forum&&"function"==typeof app.forum.attribute){var a=app.forum.attribute("threadifyTag");e=a?[a]:["threadify"]}else e=["threadify"];if(console.log("[Threadify] shouldUseThreadsApi:","discussion id =","function"==typeof t.id?t.id():t.id,"mode from setting =",r,"effective mode =",n,"configured tags =",e),"default"===n)return console.log("[Threadify] shouldUseThreadsApi: mode=default → threading ENABLED for all discussions"),!0;var i=!(!app.forum||"function"!=typeof app.forum.attribute)&&app.forum.attribute("threadifyTagsEnabled");if("tag"===n&&!i)return console.log("[Threadify] shouldUseThreadsApi: mode=tag but Tags extension disabled → threading ENABLED for all discussions"),!0;if("tag"===n){if(Array.isArray(e)&&0===e.length)return console.log("[Threadify] shouldUseThreadsApi: mode=tag but no threadify tags are configured → threading DISABLED for all discussions"),!1;var s=[];if("function"==typeof t.tags){var d=t.tags();Array.isArray(d)&&(s=d)}else t.data&&t.data.relationships&&t.data.relationships.tags&&(s=(t.data.relationships.tags.data||[]).map(function(t){return t&&t.id&&app.store&&app.store.getById?app.store.getById("tags",t.id):null}).filter(function(t){return t}));if(!s||!s.length)return console.log("[Threadify] shouldUseThreadsApi: mode=tag but discussion has no tags → threading DISABLED"),!1;var u=s.map(function(t){return t?"function"==typeof t.slug?t.slug():t.slug?t.slug:t.data&&t.data.attributes&&t.data.attributes.slug?t.data.attributes.slug:"(unknown)":"(null)"}),c=e.some(function(t){return u.includes(t)});return console.log("[Threadify] shouldUseThreadsApi: mode=tag, configured tags =",e,"discussion tags =",u,"→ hasConfiguredTag =",c),c}return console.log("[Threadify] shouldUseThreadsApi: unknown mode value",n,"→ threading DISABLED"),!1}function c(t){return t&&void 0!==t._threadDepth?{depth:t._threadDepth,threadPath:t._threadPath,isRoot:t._isRoot,childCount:t._childCount,descendantCount:t._descendantCount,rootPostId:t._rootPostId}:null}var l=!1,f=null,h=null,p=0;function g(t,e){return null!=t&&null!=e&&String(t)===String(e)}function y(t){t&&(h=t,l=!1,f=null,function(t){return console.log("[Threadify] Loading threads for discussion "+t),app.request({method:"GET",url:app.forum.attribute("apiUrl")+"/discussions/"+t+"/threads"}).then(function(t){console.log("[Threadify] Loaded "+t.data.length+" thread entries"),t.included&&(console.log("[Threadify] Processing "+t.included.length+" posts"),t.included.filter(function(t){return t&&t.type&&t.id}).forEach(function(t){app.store.pushObject(t)}));var e=t.data.map(function(t){var e=t.attributes.postId,r=app.store.getById("posts",e);return r&&(r._threadDepth=t.attributes.depth,r._threadPath=t.attributes.threadPath,r._isRoot=t.attributes.isRoot,r._childCount=t.attributes.childCount,r._descendantCount=t.attributes.descendantCount,r._rootPostId=t.attributes.rootPostId,r._parentPostId=t.attributes.parentPostId),r}).filter(function(t){return null!==t});return console.log("[Threadify] Processed "+e.length+" threaded posts (API order)"),e}).catch(function(t){return console.error("[Threadify] Failed to load discussion threads:",t),[]})}(t).then(function(e){g(h,t)&&(l=!0,p=(f=e||[]).filter(function(t){return t}).length,function(t,e){if(e&&e.length){var r=n().store.getById("discussions",String(t))||n().store.getById("discussions",Number(t));if(r){var o=e.map(function(t){return{type:"posts",id:String("function"==typeof t.id?t.id():t.id)}});r.data.relationships||(r.data.relationships={}),r.data.relationships.posts={data:o},r.freshness=new Date;var a=n().current.get("stream");a&&a.discussion===r&&(a.viewingEnd=function(){return!0})}else{var i;"undefined"!=typeof window&&window.threadifyDebug&&console.warn("[Threadify] Discussion not in store:",t,"store keys:",null!=(i=n().store.data)&&i.discussions?Object.keys(n().store.data.discussions):[])}}}(t,f),m.redraw())}).catch(function(){l=!0,f=null,m.redraw()}))}function v(){return{threadsLoaded:l,hasThreadedPosts:!!f,threadedPostCount:f?f.length:0,currentDiscussionId:h}}function b(){l=!1,f=null,h&&y(h),m.redraw()}function T(){return l&&!!f}const A=flarum.core.compat["forum/components/Post"];var I=t.n(A);const w=flarum.core.compat["forum/components/ReplyComposer"];var D=t.n(w);function P(t){if(!t||"string"!=typeof t)return null;var e=t.match(/@"[^"]*"#p(\d+)/);if(e&&e[1]){var r=parseInt(e[1],10);if(!isNaN(r)&&r>0)return r}return null}function _(t){var e=[];function r(t,n){if(void 0===n&&(n=0),t){e.push(t);var o=t._threadChildren||[];o.sort(function(t,e){return(t.createdAt?t.createdAt().getTime():0)-(e.createdAt?e.createdAt().getTime():0)}),o.forEach(function(t){r(t,n+1)})}}return t.sort(function(t,e){return(t.createdAt?t.createdAt().getTime():0)-(e.createdAt?e.createdAt().getTime():0)}),t.forEach(function(t){r(t)}),e}function S(t){var e=function(t){var e=[],r=new Map,n=new Map,o=function(t){return t&&"function"==typeof t.id?String(t.id()):String(t)};return t.forEach(function(t){if(t){var e=o(t);r.set(e,t),n.set(e,[])}}),t.forEach(function(t){var o;if(t){var a=null!=(o=t.attribute("parent_id"))?o:t._parentPostId,i=null!=a?String(a):null;i&&r.has(i)?n.get(i).push(t):e.push(t)}}),t.forEach(function(t){t&&(t._threadChildren=n.get(o(t))||[])}),e}(t);return _(e)}var C=new Map,E=10;function x(t,e){var r=t.id();if(C.has(r))return C.get(r);var n=t.attribute("parent_id");if(!n)return C.set(r,0),0;if(!e.find(function(t){return t&&t.id()==n}))return C.set(r,0),0;var o=B(t,e,new Set);return C.set(r,o),o}function B(t,e,r){var n=t.id();if(r.has(n))return console.warn("[Threadify] Cycle detected for post "+n),0;if(C.has(n))return C.get(n);var o=t.attribute("parent_id");if(!o)return 0;var a=e.find(function(t){return t&&t.id()==o});if(!a)return 0;r.add(n);var i=B(a,e,r)+1;return r.delete(n),Math.min(i,E)}function L(){C.clear()}function M(){return{version:"1.1",name:"Threadify",author:"syntaxoutlaw",isActive:!0,components:{postStream:"loaded",post:"loaded",replyComposer:"loaded"},features:["Post threading via mentions","Automatic parent/child post loading","Visual thread depth indication","Thread tree caching for performance"]}}app.initializers.add("syntaxoutlaw-threadify",function(){try{(0,o.extend)(d().prototype,"show",function(t){return function(e){if(t.call(this,e),this.stream&&this.stream.discussion){var r=this.stream.discussion,n=r.id();g(h,n)||(h=n,l=!1,f=null),u(r)&&y(n)}}}),(0,o.extend)(i().prototype,"oninit",function(){var t=this.stream;if(t&&t.discussion){var e=t.discussion.id();g(h,e)||(h=e,l=!1,f=null),u(t.discussion)&&(t.viewingEnd=function(){return!0},l||y(e))}}),(0,o.extend)(i().prototype,"onupdate",function(){if(u(this.stream.discussion)){var t=this.stream,e=t.discussion?(t.discussion.postIds()||[]).length:0;e!==p&&(p=e,l=!1,f=null,y(t.discussion.id()))}}),(0,o.extend)(I().prototype,"classes",function(t){var e=this.attrs.post;if(!e)return console.warn("[Threadify] No post in ThreadedPost.classes"),t;var r="function"==typeof e.discussion?e.discussion():null;return r&&u(r)?(function(t){var e=function(t){if(!t)return 0;var e=c(t);return e?Math.min(e.depth,10):t.attribute("parent_id")?1:0}(t),r=[];e>0?(r.push("threaded-post"),r.push("thread-depth-"+e),e>=3&&r.push("thread-deep"),e>=5&&r.push("thread-very-deep")):r.push("thread-root");var n=c(t);return n&&(n.isRoot&&r.push("thread-root-confirmed"),n.childCount>0&&(r.push("has-children"),r.push("child-count-"+Math.min(n.childCount,10))),n.descendantCount>0&&r.push("has-descendants")),r}(e).forEach(function(e){t.push(e)}),t):t}),(0,o.extend)(D().prototype,"data",function(t){var e=P(t.content);return e&&(t.parent_id=e,console.log("[Threadify] Reply threading to post",e)),t}),console.log("[Threadify] Threaded extension loaded"),window.threadifyDebug={getState:v,reload:b,isActive:T,help:function(){console.log("\n[Threadify] Debug Commands:\n- threadifyDebug.getState() - Get current threading state\n- threadifyDebug.reload() - Force reload threads for current discussion\n- threadifyDebug.isActive() - Check if threading is currently active\n- threadifyDebug.diagnose() - Log why order might be wrong on this page\n- threadifyDebug.help() - Show this help\n        ")},diagnose:function(){var t=app.current.get("discussion"),e=v(),r=t?app.store.getById("discussions",String(t.id()))||app.store.getById("discussions",Number(t.id())):null,n=t?t.postIds&&t.postIds():null;console.log("[Threadify] Diagnose:",{state:e,hasCurrentDiscussion:!!t,discussionId:t?t.id():null,discussionInStore:!!r,sameObject:t===r,postIdsLength:n?n.length:0,postIdsFirstFive:n?n.slice(0,5):null,relationshipOrder:t&&t.data&&t.data.relationships&&t.data.relationships.posts?t.data.relationships.posts.data.slice(0,5).map(function(t){return t.id}):null})}}}catch(t){console.error("[Threadify] Failed to initialize:",t)}})})(),module.exports=e})();
//# sourceMappingURL=forum.js.map