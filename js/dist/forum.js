(()=>{var e={n:r=>{var t=r&&r.__esModule?()=>r.default:()=>r;return e.d(t,{a:t}),t},d:(r,t)=>{for(var n in t)e.o(t,n)&&!e.o(r,n)&&Object.defineProperty(r,n,{enumerable:!0,get:t[n]})},o:(e,r)=>Object.prototype.hasOwnProperty.call(e,r)};(()=>{"use strict";const r=flarum.core.compat["forum/app"];var t=e.n(r);const n=flarum.core.compat["common/extend"],i=flarum.core.compat["forum/components/DiscussionPage"];var o=e.n(i);const a=flarum.core.compat["forum/components/DiscussionListItem"];var s=e.n(a);const u=flarum.core.compat["forum/components/Post"];var l=e.n(u),d=new Map;function c(e){if(!e)return null;var r=e.discussion&&e.discussion(),t=r&&r.id&&r.id();if(!t)return null;var n=function(e,r){var t=d.get(Number(e));if(t)return t.map.get(Number(r))}(t,e.id());return n?{depth:n.depth,threadPath:null,isRoot:!n.parentId,childCount:0,descendantCount:0,rootPostId:null}:null}var f=new Map;function h(e,r){void 0===r&&(r={});var t=m(e);if(!t)return Promise.resolve();var n=Date.now(),i=f.get(t)||{map:new Map,inflight:null,ts:0};if(f.set(t,i),!r.force&&n-i.ts<1e4)return i.inflight||Promise.resolve();if(i.inflight&&!r.force)return i.inflight;var o=n;return i.inflight=app.request({method:"GET",url:app.forum.attribute("apiUrl")+"/discussions/"+t+"/threads-order?bust="+o}).then(function(e){var r=new Map;(e&&e.order?e.order:[]).forEach(function(e){var t=e.postId,n=e.order,i=e.depth,o=e.parentPostId;t=Number(t),r.set(t,{order:Number(n),depth:Number.isFinite(i)?Number(i):0,parentId:o?Number(o):null})}),i.map=r,i.ts=Date.now();try{window.dispatchEvent(new CustomEvent("threadify:order-ready",{detail:{discussionId:Number(t)}}))}catch(e){}}).catch(function(e){console.warn("[Threadify] order prefetch failed",e)}).finally(function(){i.inflight=null}),i.inflight}function p(e){var r=m(e);if(r){var t=f.get(r);return t?t.map:void 0}}function m(e){if(null==e)return null;var r=Number(e);return Number.isFinite(r)&&r>0?String(r):null}function v(e){var r=Number(e);return Number.isFinite(r)?Math.max(0,Math.min(10,r)):0}function y(e){var r,t,n,i,o=function(e){if(!e||"function"!=typeof e.id)return 0;try{var r=e.discussion&&"function"==typeof e.discussion&&e.discussion()&&e.discussion().id&&e.discussion().id()||null;if(null!=r){var t=(n=r,i=e.id(),(a=(o=p(n))&&o.get(Number(i)))?a.depth:void 0);if(Number.isInteger(t))return v(t)}}catch(e){}var n,i,o,a;try{var s=c(e);if(s&&Number.isInteger(s.depth))return v(s.depth)}catch(e){}return function(e){for(var r=0,t=0,n=new Set,i=e;i&&t<100;){var o=i.attribute?i.attribute("parent_id"):null;if(!o)break;if(n.has(o)){console.warn("[Threadify] cycle detected while walking parents of",e&&e.id&&e.id()),r=0;break}n.add(o),r+=1;var a=app.store.getById("posts",String(o));if(!a)break;if(i=a,t++,r>=10)break}return v(r)}(e)}(e),a=[];o>0?(a.push("threaded-post"),a.push("thread-depth-"+o),o>=3&&a.push("thread-deep"),o>=5&&a.push("thread-very-deep")):a.push("thread-root");try{var s=e.discussion&&"function"==typeof e.discussion&&e.discussion()&&e.discussion().id&&e.discussion().id()||null,u=null!=s?(r=s,t=e.id(),(i=(n=p(r))&&n.get(Number(t)))?i.parentId:void 0):void 0,l=c(e);(null==u?!e.attribute||!e.attribute("parent_id"):null==u)&&a.push("thread-root-confirmed"),l&&Number.isInteger(l.childCount)&&l.childCount>0&&a.push("has-children","child-count-"+Math.min(l.childCount,10)),l&&Number.isInteger(l.descendantCount)&&l.descendantCount>0&&a.push("has-descendants")}catch(e){}return a}const b=flarum.core.compat["forum/components/ReplyComposer"];var g=e.n(b);const w=flarum.core.compat["forum/components/PostStream"];var N=e.n(w);function O(e,r){(null==r||r>e.length)&&(r=e.length);for(var t=0,n=Array(r);t<r;t++)n[t]=e[t];return n}function _(e){try{var r,t;return null!=(r=null==e||null==(t=e.stream)||null==(t=t.discussion)||null==t.id?void 0:t.id())?r:null}catch(e){return null}}function S(e){var r,t;return null!=e&&null!=(r=e.element)&&null!=(r=r.classList)&&r.contains("PostStream")?e.element:(null==e||null==(t=e.element)||null==t.querySelector?void 0:t.querySelector(".PostStream"))||document.querySelector(".PostStream")||null}function I(e){return e&&1===e.nodeType&&e.matches(".PostStream-item[data-id]")}function P(e,r,t){return function(e){var r=m(e);if(!r)return Promise.resolve(new Map);var t=Date.now(),n=f.get(r)||{map:new Map,inflight:null,ts:0};return f.set(r,n),t-n.ts<1e4&&n.map&&n.map.size>=0?Promise.resolve(n.map):(n.inflight||h(r)).then(function(){return p(r)||new Map})}(r).then(function(r){var n=function(e){var r=function(e){return Array.from((null==e?void 0:e.children)||[])}(e);if(!r.length)return{posts:[],left:-1,right:-1,anchor:null};var t=r.findIndex(I);if(t<0)return{posts:[],left:-1,right:-1,anchor:r[0]||null};var n=r.length-1-[].concat(r).reverse().findIndex(I);return n<t&&(n=t),{posts:r.slice(t,n+1).filter(I),left:t,right:n,anchor:r[n+1]||null}}(e).posts;if(n.length){var i=function(e,r,t){for(var n=new Set(r.map(function(e){return Number(e.dataset.id)})),i=r.map(function(e){var r=Number(e.dataset.id),i=t.get(r);return{id:r,el:e,rec:i||null,movable:!(!i||null!=i.parentId&&!n.has(i.parentId)),baseOrder:i?Number(i.order):NaN}}),o=i.length,a=new Array(o).fill(null),s=new Array(o).fill(null),u=null,l=0;l<o;l++)Number.isFinite(i[l].baseOrder)&&(u=i[l].baseOrder),a[l]=u;u=null;for(var d=o-1;d>=0;d--)Number.isFinite(i[d].baseOrder)&&(u=i[d].baseOrder),s[d]=u;for(var c=0;c<o;c++)if(!Number.isFinite(i[c].baseOrder)){var f=a[c],h=s[c];Number.isFinite(f)&&Number.isFinite(h)?i[c].baseOrder=(f+h)/2:Number.isFinite(f)?i[c].baseOrder=f+.5:Number.isFinite(h)?i[c].baseOrder=h-.5:i[c].baseOrder=1e9+c}for(var p,m=new Map,v=function(e,r){var t="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(t)return(t=t.call(e)).next.bind(t);if(Array.isArray(e)||(t=function(e,r){if(e){if("string"==typeof e)return O(e,r);var t={}.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?O(e,r):void 0}}(e))||r&&e&&"number"==typeof e.length){t&&(e=t);var n=0;return function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(i);!(p=v()).done;){var y=p.value,b=y.baseOrder,g=m.get(b)||0;g&&(y.baseOrder=b+1e-6*g),m.set(b,g+1)}return i}(0,n,r||new Map),o=function(e){return e.slice().sort(function(e,r){return e.baseOrder!==r.baseOrder?e.baseOrder-r.baseOrder:e.id-r.id})}(i);!function(e,r){for(var t=r.length-1;t>=0;t--){var n=r[t];if(n.movable){var i=t+1<r.length?r[t+1].el:null,o=i&&i.parentNode===e?i:null;if(n.el&&n.el.parentNode===e)try{e.insertBefore(n.el,o)}catch(e){console.warn("[Threadify] insertBefore failed; will retry",e)}}}}(e,o),function(e,r,t){if(r&&!t.done){var n=null==e||null==e.querySelector?void 0:e.querySelector('.PostStream-item[data-id="'+r+'"]');if(n)try{n.scrollIntoView({block:"center",inline:"nearest"}),t.done=!0}catch(e){}}}(e,function(){try{var e=new URLSearchParams(location.search).get("near");if(e&&/^\d+$/.test(e))return Number(e);var r=(location.hash||"").match(/#p(\d+)/);if(r)return Number(r[1])}catch(e){}return null}(),t)}}).catch(function(e){console.warn("[Threadify] order map unavailable",e)})}!function(){var e="threadify:logs",r=["log","info","warn","debug","error"];window.__threadifyConsoleOriginal||(window.__threadifyConsoleOriginal={},r.forEach(function(e){window.__threadifyConsoleOriginal[e]=console[e]?console[e].bind(console):function(){}}));var t="1"===("undefined"!=typeof localStorage?localStorage.getItem(e):null);function n(r){t=!!r,"undefined"!=typeof localStorage&&localStorage.setItem(e,t?"1":"0")}window.threadifyLogs={enable:function(){return n(!0),"Threadify logs: ON"},disable:function(){return n(!1),"Threadify logs: OFF"},toggle:function(){return n(!t),"Threadify logs: "+(t?"ON":"OFF")},status:function(){return t}},r.forEach(function(e){var r=window.__threadifyConsoleOriginal[e];console[e]=function(){for(var e=arguments.length,n=new Array(e),i=0;i<e;i++)n[i]=arguments[i];var o=n&&n[0];if("string"!=typeof o||0!==o.indexOf("[Threadify]")||t)return r.apply(void 0,n)}})}(),t().initializers.add("syntaxoutlaw-threadify",function(){(0,n.extend)(g().prototype,"data",function(e){var r=function(e){if(!e||"string"!=typeof e)return null;var r=e.match(/@"[^"]*"#p(\d+)/);if(r&&r[1]){var t=parseInt(r[1],10);if(!isNaN(t)&&t>0)return t}return null}(e.content);return r&&(e.parent_id=r,console.log("[Threadify] Reply threading to post",r)),e}),(0,n.extend)(l().prototype,"classes",function(e){var r=this.attrs.post;if(!r)return console.warn("[Threadify] No post in ThreadedPost.classes"),e;var t=y(r);return console.log("[Threadify] Adding classes to post "+r.id()+": "+t.join(", ")),t.forEach(function(r){e.push(r)}),e}),(0,n.extend)(N().prototype,"oncreate",function(){var e=this,r=_(this),t=S(this);if(r&&t){this.__threadifyNearCentered={done:!1},P(t,r,this.__threadifyNearCentered);var n=!1,i=new MutationObserver(function(i){i.some(function(e){return"childList"===e.type})&&(n||(n=!0,requestAnimationFrame(function(){n=!1,P(t,r,e.__threadifyNearCentered)})))});i.observe(t,{childList:!0}),this.__threadifyDomObserver=i}}),(0,n.extend)(N().prototype,"onupdate",function(){var e=_(this),r=S(this);e&&r&&P(r,e,this.__threadifyNearCentered||{done:!0})}),(0,n.extend)(N().prototype,"onremove",function(){if(this.__threadifyDomObserver){try{this.__threadifyDomObserver.disconnect()}catch(e){}this.__threadifyDomObserver=null}}),(0,n.extend)(o().prototype,"oninit",function(){var e=this.discussion&&"function"==typeof this.discussion.id&&this.discussion.id()||this.discussion&&this.discussion.id||null;e&&h(e)}),(0,n.extend)(s().prototype,"oncreate",function(){var e=this.attrs.discussion;if(e){var r=e.id(),t=function(){return h(r)};this.element&&(this.element.addEventListener("mouseenter",t,{once:!0}),this.element.addEventListener("touchstart",t,{once:!0,passive:!0}))}})})})(),module.exports={}})();
//# sourceMappingURL=forum.js.map