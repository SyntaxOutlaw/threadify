(()=>{var t={n:n=>{var r=n&&n.__esModule?()=>n.default:()=>n;return t.d(r,{a:r}),r},d:(n,r)=>{for(var e in r)t.o(r,e)&&!t.o(n,e)&&Object.defineProperty(n,e,{enumerable:!0,get:r[e]})},o:(t,n)=>Object.prototype.hasOwnProperty.call(t,n)};(()=>{"use strict";const n=flarum.core.compat["forum/app"];var r=t.n(n);const e=flarum.core.compat["common/extend"],o=flarum.core.compat["forum/components/DiscussionPage"];var i=t.n(o);const u=flarum.core.compat["forum/components/DiscussionListItem"];var a=t.n(u);const s=flarum.core.compat["forum/components/Post"];var c=t.n(s);function d(t){return t&&void 0!==t._threadDepth?{depth:t._threadDepth,threadPath:t._threadPath,isRoot:t._isRoot,childCount:t._childCount,descendantCount:t._descendantCount,rootPostId:t._rootPostId}:null}const f=flarum.core.compat["forum/components/ReplyComposer"];var l=t.n(f);const p=flarum.core.compat["forum/components/PostStream"];var h=t.n(p);const v=flarum.core.compat["forum/states/PostStreamState"];var y=t.n(v);function g(t){var n=[];function r(t,e){if(void 0===e&&(e=0),t){n.push(t);var o=t._threadChildren||[];o.sort(function(t,n){return(t.createdAt?t.createdAt().getTime():0)-(n.createdAt?n.createdAt().getTime():0)}),o.forEach(function(t){r(t,e+1)})}}return t.sort(function(t,n){return(t.createdAt?t.createdAt().getTime():0)-(n.createdAt?n.createdAt().getTime():0)}),t.forEach(function(t){r(t)}),n}function w(t){var n=function(t){var n=[],r=new Map,e=new Map;return t.forEach(function(t){if(t){var n=t.id();r.set(n,t),e.set(n,[])}}),t.forEach(function(t){if(t){t.id();var o=t.attribute("parent_id");o&&r.has(String(o))?e.get(String(o)).push(t):n.push(t)}}),t.forEach(function(t){t&&(t._threadChildren=e.get(t.id())||[])}),n}(t);return g(n)}var P=new Map;function b(){P.clear()}function _(t){return null==t?"":String(t)}function E(t,n){var r=new Map;return t.filter(Boolean).forEach(function(t){return r.set(_(t.id()),t)}),n.filter(Boolean).forEach(function(t){return r.set(_(t.id()),t)}),Array.from(r.values())}function M(t){var n=(t||[]).map(_).filter(Boolean);return 0===n.length?Promise.resolve([]):r().store.find("posts",{filter:{id:n.join(",")}})}function A(t,n){var r=(n||[]).filter(Boolean),e=new Set(r.map(function(t){return _(t.id())})),o=[];r.forEach(function(t){var n=_(null==t||null==t.attribute?void 0:t.attribute("parent_id"));n&&!e.has(n)&&o.push(n)});var i=Array.from(new Set(o));return 0===i.length?Promise.resolve(r):M(i).then(function(n){var e=E(r,n);return A(t,e)}).catch(function(t){return console.warn("[Threadify] Failed to load parent posts:",t),r})}var T=new Map;function S(t){var n=String(t),r=T.get(n);if(r&&!0===r.ready)return Promise.resolve();if(r&&r.ready&&"function"==typeof r.ready.then)return r.ready;var e={map:new Map,ready:null};return T.set(n,e),e.ready=app.request({method:"GET",url:app.forum.attribute("apiUrl")+"/discussions/"+n+"/threads-order"}).then(function(t){var n=new Map;(t.order||[]).forEach(function(t){var r=t.postId,e=t.order,o=t.depth,i=t.parentPostId;n.set(Number(r),{order:Number(e),depth:Number(o),parentId:i?Number(i):null})}),e.map=n,e.ready=!0}).catch(function(t){console.warn("[Threadify] order prefetch failed",t),e.ready=!0}),e.ready}function x(t,n){var r=T.get(String(t));if(r&&r.map){var e=r.map.get(Number(n));return e?e.order:void 0}}var C=!1,I=null,N=null,j="";function B(t){if(!C){C=!0;var n=function(t){I=t||null,C=!1;try{m.redraw()}catch(t){}};try{var r=(t.stream.posts()||[]).filter(function(t){return t&&"function"==typeof t.id});if(0===r.length)return n(null);(function(t,n){return A(t.discussion?t:{discussion:t.stream.discussion},n).catch(function(){return Promise.resolve(n)})})(t,r).then(function(n){return function(t,n){return function(t,n){var r=function(t){var n;return(null==t?void 0:t.discussion)||(null==t||null==(n=t.stream)?void 0:n.discussion)||null}(t),e=(n||[]).filter(Boolean),o=new Set(e.map(function(t){return _(t.id())}));if(!r||"function"!=typeof r.postIds)return Promise.resolve(e);var i=(r.postIds()||[]).map(_).filter(function(t){return t&&!o.has(t)});if(0===i.length)return Promise.resolve(e);var u=Math.min(10,i.length);return M(i.slice(-u)).then(function(t){var n=(t||[]).filter(function(t){var n=_(null==t||null==t.attribute?void 0:t.attribute("parent_id"));return n&&o.has(n)});return 0===n.length?e:E(e,n)}).catch(function(t){return console.warn("[Threadify] Failed to load child posts:",t),e})}(t.discussion?t:{discussion:t.stream.discussion},n).catch(function(){return n})}(t,n)}).then(function(t){var r=w(t),e=new Map,o=0;r.forEach(function(t){t&&"function"==typeof t.id&&e.set(t.id(),o++)}),n(e)}).catch(function(){var t=w(r),e=new Map,o=0;t.forEach(function(t){t&&"function"==typeof t.id&&e.set(t.id(),o++)}),n(e)})}catch(t){console.error("[Threadify] buildOrderMap failed:",t),n(null)}}}r().initializers.add("syntaxoutlaw-threadify",function(){(0,e.extend)(c().prototype,"classes",function(t){var n=this.attrs.post;if(!n)return console.warn("[Threadify] No post in ThreadedPost.classes"),t;var r=function(t){var n=function(t){if(!t)return 0;var n=d(t);return n?Math.min(n.depth,10):t.attribute("parent_id")?1:0}(t),r=[];n>0?(r.push("threaded-post"),r.push("thread-depth-"+n),n>=3&&r.push("thread-deep"),n>=5&&r.push("thread-very-deep")):r.push("thread-root");var e=d(t);return e&&(e.isRoot&&r.push("thread-root-confirmed"),e.childCount>0&&(r.push("has-children"),r.push("child-count-"+Math.min(e.childCount,10))),e.descendantCount>0&&r.push("has-descendants")),r}(n);return console.log("[Threadify] Adding classes to post "+n.id()+": "+r.join(", ")),r.forEach(function(n){t.push(n)}),t}),(0,e.extend)(l().prototype,"data",function(t){var n=function(t){if(!t||"string"!=typeof t)return null;var n=t.match(/@"[^"]*"#p(\d+)/);if(n&&n[1]){var r=parseInt(n[1],10);if(!isNaN(r)&&r>0)return r}return null}(t.content);return n&&(t.parent_id=n,console.log("[Threadify] Reply threading to post",n)),t}),(0,e.extend)(h().prototype,"oninit",function(){var t,n=null==(t=this.stream.discussion)||null==t.id?void 0:t.id();N!==n&&(N=n||null,I=null,C=!1,j="",b()),n&&S(n),B(this)}),(0,e.extend)(h().prototype,"onupdate",function(){var t=(this.stream.posts()||[]).filter(function(t){return t&&"function"==typeof t.id}).map(function(t){return t.id()}).join(",");t!==j&&(j=t,b(),B(this))}),(0,e.extend)(y().prototype,"visiblePosts",function(t){var n,r=this;if(!Array.isArray(t)||t.length<=1)return t;if(Object.keys(this).some(function(t){return/^loading/i.test(t)&&r[t]}))return t;var e=null==(n=this.discussion)||null==n.id?void 0:n.id();if(!e)return t;var o=t.slice();return o.sort(function(t,n){var r,o,i=!(!t||"function"!=typeof t.id),u=!(!n||"function"!=typeof n.id);if(!i||!u)return 0;var a=t.id(),s=n.id(),c=x(e,a),d=x(e,s);if(null!=c||null!=d){if(null==c)return 1;if(null==d)return-1;if(c!==d)return c-d}var f=null==(r=I)||null==r.get?void 0:r.get(a),l=null==(o=I)||null==o.get?void 0:o.get(s);if(null!=f||null!=l){if(null==f)return 1;if(null==l)return-1;if(f!==l)return f-l}return 0}),o}),(0,e.extend)(i().prototype,"oninit",function(){var t=this.discussion&&this.discussion.id&&this.discussion.id();t&&S(t)}),(0,e.extend)(a().prototype,"oncreate",function(){var t=this.attrs.discussion;if(t){var n=t.id(),r=function(){return S(n)};this.element&&this.element.addEventListener("mouseenter",r,{once:!0}),this.element&&this.element.addEventListener("touchstart",r,{once:!0,passive:!0})}})})})(),module.exports={}})();
//# sourceMappingURL=forum.js.map