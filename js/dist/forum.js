(()=>{var t={n:e=>{var r=e&&e.__esModule?()=>e.default:()=>e;return t.d(r,{a:r}),r},d:(e,r)=>{for(var n in r)t.o(r,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:r[n]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};(()=>{"use strict";t.r(e),t.d(e,{calculateThreadDepth:()=>w,clearThreadDepthCache:()=>I,createThreadedPosts:()=>C,extractParentIdFromContent:()=>b,getThreadedPostsCache:()=>R,getThreadifyStatus:()=>O,isThreadingActive:()=>E});const r=flarum.core.compat["common/extend"],n=flarum.core.compat["forum/components/PostStream"];var o=t.n(n);function a(t){return t&&void 0!==t._threadDepth?{depth:t._threadDepth,threadPath:t._threadPath,isRoot:t._isRoot,childCount:t._childCount,descendantCount:t._descendantCount,rootPostId:t._rootPostId}:null}var i=function(){for(var t=arguments.length,e=new Array(t),r=0;r<t;r++)e[r]=arguments[r]},d=!1,s=null,u=null,c=0;function h(t){var e=t.stream.discussion.id();i("Loading threads for discussion "+e),function(t){return console.log("[Threadify] Loading threads for discussion "+t),app.request({method:"GET",url:app.forum.attribute("apiUrl")+"/discussions/"+t+"/threads"}).then(function(t){console.log("[Threadify] Loaded "+t.data.length+" thread entries"),t.included&&(console.log("[Threadify] Processing "+t.included.length+" included items"),t.included.forEach(function(t){console.log("[Threadify] Including "+t.type+":"+t.id),app.store.pushObject(t)}));var e=t.data.map(function(t){var e=t.attributes.postId,r=app.store.getById("posts",e);return r?(console.log("[Threadify] Post "+e+" found, user:",r.user?r.user():"NO USER"),r._threadDepth=t.attributes.depth,r._threadPath=t.attributes.threadPath,r._isRoot=t.attributes.isRoot,r._childCount=t.attributes.childCount,r._descendantCount=t.attributes.descendantCount,r._rootPostId=t.attributes.rootPostId,r._parentPostId=t.attributes.parentPostId,console.log("[Threadify] Post "+e+" depth: "+r._threadDepth+", path: "+r._threadPath)):console.warn("[Threadify] Post "+e+" not found in store"),r}).filter(function(t){return null!==t});return console.log("[Threadify] Processed "+e.length+" threaded posts"),e}).catch(function(t){return console.error("[Threadify] Failed to load discussion threads:",t),[]})}(e).then(function(t){u===e?(s=t,d=!0,c=t?t.filter(function(t){return t}).length:0,i("Successfully loaded "+s.length+" threaded posts"),m.redraw()):i("Discussion changed while loading, ignoring results")}).catch(function(t){console.error("[Threadify] Failed to load threaded posts:",t),d=!0,s=null})}function l(){return{threadsLoaded:d,hasThreadedPosts:!!s,threadedPostCount:s?s.length:0,currentDiscussionId:u}}function f(){i("Force reloading threads"),d=!1,s=null,m.redraw()}function p(){return d&&!!s}const g=flarum.core.compat["forum/components/Post"];var y=t.n(g);var v=function(){for(var t=arguments.length,e=new Array(t),r=0;r<t;r++)e[r]=arguments[r]};const P=flarum.core.compat["forum/components/ReplyComposer"];var T=t.n(P);function b(t){if(!t||"string"!=typeof t)return null;var e=t.match(/@"[^"]*"#p(\d+)/);if(e&&e[1]){var r=parseInt(e[1],10);if(!isNaN(r)&&r>0)return r}return null}function _(t){var e=[];function r(t,n){if(void 0===n&&(n=0),t){e.push(t);var o=t._threadChildren||[];o.sort(function(t,e){return(t.createdAt?t.createdAt().getTime():0)-(e.createdAt?e.createdAt().getTime():0)}),o.forEach(function(t){r(t,n+1)})}}return t.sort(function(t,e){return(t.createdAt?t.createdAt().getTime():0)-(e.createdAt?e.createdAt().getTime():0)}),t.forEach(function(t){r(t)}),e}function C(t){var e=function(t){var e=[],r=new Map,n=new Map;return t.forEach(function(t){if(t){var e=t.id();r.set(e,t),n.set(e,[])}}),t.forEach(function(t){if(t){t.id();var o=t.attribute("parent_id");o&&r.has(String(o))?n.get(String(o)).push(t):e.push(t)}}),t.forEach(function(t){t&&(t._threadChildren=n.get(t.id())||[])}),e}(t);return _(e)}var S=new Map,A=10;function w(t,e){var r=t.id();if(S.has(r))return S.get(r);var n=t.attribute("parent_id");if(!n)return S.set(r,0),0;if(!e.find(function(t){return t&&t.id()==n}))return S.set(r,0),0;var o=D(t,e,new Set);return S.set(r,o),o}function D(t,e,r){var n=t.id();if(r.has(n))return console.warn("[Threadify] Cycle detected for post "+n),0;if(S.has(n))return S.get(n);var o=t.attribute("parent_id");if(!o)return 0;var a=e.find(function(t){return t&&t.id()==o});if(!a)return 0;r.add(n);var i=D(a,e,r)+1;return r.delete(n),Math.min(i,A)}function I(){S.clear()}var x=null,M=null;function R(){return x}function E(){return!(!x||!M)}function O(){return{version:"1.0.6",name:"Threadify",author:"syntaxoutlaw",isActive:!0,components:{postStream:"loaded",post:"loaded",replyComposer:"loaded"},features:["Post threading via mentions","Automatic parent/child post loading","Visual thread depth indication","Thread tree caching for performance"]}}app.initializers.add("syntaxoutlaw-threadify",function(){try{(0,r.extend)(o().prototype,"oninit",function(){i("Initializing simplified threaded PostStream");var t=this.stream.discussion.id();u!==t&&(i("Discussion changed, resetting thread state"),d=!1,s=null,u=t),this.stream.discussion,d||(i("Loading threaded posts from API"),h(this))}),(0,r.extend)(o().prototype,"oncreate",function(){var t=this.stream.discussion.id();u!==t&&(i("Discussion changed in oncreate, resetting"),d=!1,s=null,u=t,this.stream.discussion,h(this))}),(0,r.extend)(o().prototype,"onupdate",function(){this.stream.discussion;var t=this.stream.posts(),e=t?t.filter(function(t){return t}).length:0;e!==c&&(i("Post count changed: "+c+" -> "+e+", reloading threads"),c=e,d=!1,s=null,h(this))}),(0,r.extend)(o().prototype,"onremove",function(){i("PostStream being removed, cleaning up")}),(0,r.extend)(o().prototype,"posts",function(t){if(d&&s&&u===this.stream.discussion.id())return i("Returning cached threaded posts ("+s.length+" posts)"),s;var e=t();return i("Returning original posts ("+(e?e.length:0)+" posts)"),e}),(0,r.extend)(y().prototype,"classes",function(t){var e=this.attrs.post;if(!e)return v("No post in ThreadedPost.classes"),t;var r=function(t){var e=function(t){if(!t)return 0;var e=a(t);return e?Math.min(e.depth,10):t.attribute("parent_id")?1:0}(t),r=[];e>0?(r.push("threaded-post"),r.push("thread-depth-"+e),e>=3&&r.push("thread-deep"),e>=5&&r.push("thread-very-deep")):r.push("thread-root");var n=a(t);return n&&(n.isRoot&&r.push("thread-root-confirmed"),n.childCount>0&&(r.push("has-children"),r.push("child-count-"+Math.min(n.childCount,10))),n.descendantCount>0&&r.push("has-descendants")),r}(e);return v("Adding classes to post "+e.id()+": "+r.join(", ")),r.forEach(function(e){t.push(e)}),t}),(0,r.extend)(T().prototype,"data",function(t){var e=b(t.content);return e&&(t.parent_id=e,console.log("[Threadify] Reply threading to post",e)),t}),console.log("[Threadify] Simplified extension loaded"),window.threadifyDebug={getState:l,reload:f,isActive:p,help:function(){console.log("\n[Threadify] Simplified Debug Commands:\n- threadifyDebug.getState() - Get current threading state\n- threadifyDebug.reload() - Force reload threads for current discussion\n- threadifyDebug.isActive() - Check if threading is currently active\n- threadifyDebug.help() - Show this help\n\nNew System: Uses pre-computed threads from backend API\n- Single API call instead of complex frontend logic\n- Pre-computed thread paths and depths\n- Much more reliable and performant\n        ")}}}catch(t){console.error("[Threadify] Failed to initialize:",t)}})})(),module.exports=e})();
//# sourceMappingURL=forum.js.map