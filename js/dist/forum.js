(()=>{var t={26:t=>{"use strict";t.exports=flarum.core.compat["common/extend"]},51:(t,n,e)=>{"use strict";e.r(n),e.d(n,{forceRebuildCache:()=>F,getThreadedPostsCache:()=>k,getThreadingDebugInfo:()=>G,getThreadingStats:()=>N,initThreadedPostStream:()=>I,isThreadingActive:()=>K,logThreadingDebug:()=>L,setMinimalChildLoading:()=>z});const r=flarum.core.compat["forum/app"];var o=e.n(r),i=e(26);const a=flarum.core.compat["forum/components/PostStream"];var u=e.n(a);const s=flarum.core.compat["forum/states/PostStreamState"];var l=e.n(s);const c=flarum.core.compat["common/components/LoadingIndicator"];var d=e.n(c);function f(t){var n=[];function e(t,r){if(void 0===r&&(r=0),t){n.push(t);var o=t._threadChildren||[];o.sort(function(t,n){return(t.createdAt?t.createdAt().getTime():0)-(n.createdAt?n.createdAt().getTime():0)}),o.forEach(function(t){e(t,r+1)})}}return t.sort(function(t,n){return(t.createdAt?t.createdAt().getTime():0)-(n.createdAt?n.createdAt().getTime():0)}),t.forEach(function(t){e(t)}),n}function h(t){var n=function(t){var n=[],e=new Map,r=new Map;return t.forEach(function(t){if(t){var n=t.id();e.set(n,t),r.set(n,[])}}),t.forEach(function(t){if(t){t.id();var o=t.attribute("parent_id");o&&e.has(String(o))?r.get(String(o)).push(t):n.push(t)}}),t.forEach(function(t){t&&(t._threadChildren=r.get(t.id())||[])}),n}(t);return f(n)}var p=new Map;function v(){p.clear()}function g(t){return null==t?"":String(t)}function y(t,n){var e=new Map;return t.filter(Boolean).forEach(function(t){return e.set(g(t.id()),t)}),n.filter(Boolean).forEach(function(t){return e.set(g(t.id()),t)}),Array.from(e.values())}function b(t){var n=(t||[]).map(g).filter(Boolean);return 0===n.length?Promise.resolve([]):o().store.find("posts",{filter:{id:n.join(",")}})}function S(t,n){var e=(n||[]).filter(Boolean),r=new Set(e.map(function(t){return g(t.id())})),o=[];e.forEach(function(t){var n=g(null==t||null==t.attribute?void 0:t.attribute("parent_id"));n&&!r.has(n)&&o.push(n)});var i=Array.from(new Set(o));return 0===i.length?Promise.resolve(e):b(i).then(function(n){var r=y(e,n);return S(t,r)}).catch(function(t){return console.warn("[Threadify] Failed to load parent posts:",t),e})}function T(t,n){(null==n||n>t.length)&&(n=t.length);for(var e=0,r=Array(n);e<n;e++)r[e]=t[e];return r}var P=!1,w=null,A=0,_=null,C=null,M=null,x=!0,B=!1,E=!1;function I(){(0,i.extend)(u().prototype,"oninit",function(){var t=this,n=this.stream.discussion.id();C!==n&&U(n),_||(_=this.stream.posts);var e=(_.call(this.stream)||[]).filter(Boolean);B=D(e),E=!1,this.stream.posts=function(){if(B&&!E)return[];if(w)return w;var n=_.call(t.stream);return!P&&n&&n.filter(Boolean).length>0&&j(t,{firstKick:!0}),n},(A=e.length)>0&&j(this,{firstKick:!0})}),(0,i.extend)(u().prototype,"view",function(t){return B&&!E?m("div",{className:"Threadify-FirstFrameGate"},m(d(),null)):t}),(0,i.extend)(u().prototype,"oncreate",function(){var t=this.stream.discussion.id();if(C!==t){U(t);var n=_&&_.call(this.stream)||[];A=n.filter(Boolean).length,B=D(n.filter(Boolean)),E=!1,A>0&&j(this,{firstKick:!0})}v()}),(0,i.extend)(u().prototype,"onupdate",function(){if(_){var t=(_.call(this.stream)||[]).filter(Boolean).length;t!==A&&(A=t,w=null,M=null,v(),j(this))}}),(0,i.extend)(l().prototype,"visiblePosts",function(t){!M||!Array.isArray(t)||t.length<=1||t.sort(function(t,n){var e=t&&t.id?M.get(t.id()):void 0,r=n&&n.id?M.get(n.id()):void 0;return null==e&&null==r?0:null==e?1:null==r?-1:e-r})})}function j(t,n){if((void 0===n?{}:n).firstKick,!P){P=!0;try{if(!_)return void i(null);var e=_.call(t.stream)||[],r=e.filter(Boolean);if(0===r.length)return void i(null);var o=function(t,n){return S(t.discussion?t:{discussion:t.stream.discussion},n).catch(function(){return O(n)})}(t,r);o.then(function(n){return x?function(t,n){return function(t,n){var e=function(t){var n;return(null==t?void 0:t.discussion)||(null==t||null==(n=t.stream)?void 0:n.discussion)||null}(t),r=(n||[]).filter(Boolean),o=new Set(r.map(function(t){return g(t.id())}));if(!e||"function"!=typeof e.postIds)return Promise.resolve(r);var i=(e.postIds()||[]).map(g).filter(function(t){return t&&!o.has(t)});if(0===i.length)return Promise.resolve(r);var a=Math.min(10,i.length);return b(i.slice(-a)).then(function(t){var n=(t||[]).filter(function(t){var n=g(null==t||null==t.attribute?void 0:t.attribute("parent_id"));return n&&o.has(n)});return 0===n.length?r:y(r,n)}).catch(function(t){return console.warn("[Threadify] Failed to load child posts:",t),r})}(t.discussion?t:{discussion:t.stream.discussion},n).catch(function(){return n})}(t,n):n}).then(function(t){var n=h(t),r=R(e,n);M=new Map;var o=0;r.forEach(function(t){t&&t.id&&M.set(t.id(),o++)}),i(r)}).catch(function(t){console.warn("[Threadify] parent/child load failed, fallback threading:",t);var n=h(r),o=R(e,n);M=new Map;var a=0;o.forEach(function(t){t&&t.id&&M.set(t.id(),a++)}),i(o)})}catch(t){console.error("[Threadify] Cache update failed:",t),i(null)}}function i(t){w=t,P=!1,E=!0,setTimeout(function(){return m.redraw()},0)}}function R(t,n){if(!Array.isArray(n)||0===n.length)return t;for(var e=[].concat(n),r=Math.max(0,t.length-n.length),o=0;o<r;o++)e.push(null);return e}function D(t){for(var n,e=new Set(t.map(function(t){return String(t.id())})),r=function(t,n){var e="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(e)return(e=e.call(t)).next.bind(e);if(Array.isArray(t)||(e=function(t,n){if(t){if("string"==typeof t)return T(t,n);var e={}.toString.call(t).slice(8,-1);return"Object"===e&&t.constructor&&(e=t.constructor.name),"Map"===e||"Set"===e?Array.from(t):"Arguments"===e||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e)?T(t,n):void 0}}(t))||n&&t&&"number"==typeof t.length){e&&(t=e);var r=0;return function(){return r>=t.length?{done:!0}:{done:!1,value:t[r++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(t);!(n=r()).done;){var o=n.value,i=o&&o.attribute?o.attribute("parent_id"):null;if(i&&!e.has(String(i)))return!0}return!1}function O(t){var n=new Map(t.filter(Boolean).map(function(t){return[String(t.id()),t]})),e=[];return t.forEach(function(t){var r=t&&t.attribute?t.attribute("parent_id"):null;r&&!n.has(String(r))&&e.push(String(r))}),0===e.length?Promise.resolve(t):o().store.find("posts",{filter:{id:e.join(",")}}).then(function(n){return O([].concat(t,n))}).catch(function(){return t})}function k(){return w}function F(t){w=null,M=null,v(),j(t)}function K(){return!(!w||!_)}function N(){return{hasCachedPosts:!!w,cachedPostCount:w?w.filter(Boolean).length:0,isReordering:P,lastPostCount:A,hasOriginalMethod:!!_,discussionId:C,firstFrameGated:B,firstBuildDone:E}}function G(){var t=N();return w&&(t.sample=w.filter(Boolean).slice(0,10).map(function(t){return"#"+t.id()+"(parent:"+(t.attribute("parent_id")||"none")+")"})||[]),t}function L(){console.log("[Threadify] Debug:",G())}function z(t){x=!!t,console.log("[Threadify] Minimal child loading "+(x?"enabled":"disabled"))}function U(t){C=t,P=!1,w=null,A=0,_=null,M=null,B=!1,E=!1,v()}}},n={};function e(r){var o=n[r];if(void 0!==o)return o.exports;var i=n[r]={exports:{}};return t[r](i,i.exports,e),i.exports}e.n=t=>{var n=t&&t.__esModule?()=>t.default:()=>t;return e.d(n,{a:n}),n},e.d=(t,n)=>{for(var r in n)e.o(n,r)&&!e.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:n[r]})},e.o=(t,n)=>Object.prototype.hasOwnProperty.call(t,n),e.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},(()=>{"use strict";var t=e(51),n=e(26);const r=flarum.core.compat["forum/components/Post"];var o=e.n(r);function i(t){return t&&void 0!==t._threadDepth?{depth:t._threadDepth,threadPath:t._threadPath,isRoot:t._isRoot,childCount:t._childCount,descendantCount:t._descendantCount,rootPostId:t._rootPostId}:null}const a=flarum.core.compat["forum/components/ReplyComposer"];var u=e.n(a);app.initializers.add("syntaxoutlaw-threadify",function(){try{(0,t.initThreadedPostStream)(),(0,n.extend)(o().prototype,"classes",function(t){var n=this.attrs.post;if(!n)return console.warn("[Threadify] No post in ThreadedPost.classes"),t;var e=function(t){var n=function(t){if(!t)return 0;var n=i(t);return n?Math.min(n.depth,10):t.attribute("parent_id")?1:0}(t),e=[];n>0?(e.push("threaded-post"),e.push("thread-depth-"+n),n>=3&&e.push("thread-deep"),n>=5&&e.push("thread-very-deep")):e.push("thread-root");var r=i(t);return r&&(r.isRoot&&e.push("thread-root-confirmed"),r.childCount>0&&(e.push("has-children"),e.push("child-count-"+Math.min(r.childCount,10))),r.descendantCount>0&&e.push("has-descendants")),e}(n);return console.log("[Threadify] Adding classes to post "+n.id()+": "+e.join(", ")),e.forEach(function(n){t.push(n)}),t}),(0,n.extend)(u().prototype,"data",function(t){var n=function(t){if(!t||"string"!=typeof t)return null;var n=t.match(/@"[^"]*"#p(\d+)/);if(n&&n[1]){var e=parseInt(n[1],10);if(!isNaN(e)&&e>0)return e}return null}(t.content);return n&&(t.parent_id=n,console.log("[Threadify] Reply threading to post",n)),t}),console.log("[Threadify] stable PostStreamState wrapper loaded"),window.threadifyDebug={forceRebuild:function(t){(0,e(51).forceRebuildCache)(t)}}}catch(t){console.error("[Threadify] init failed:",t)}})})(),module.exports={}})();
//# sourceMappingURL=forum.js.map