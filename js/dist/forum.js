(()=>{var t={n:r=>{var n=r&&r.__esModule?()=>r.default:()=>r;return t.d(n,{a:n}),n},d:(r,n)=>{for(var e in n)t.o(n,e)&&!t.o(r,e)&&Object.defineProperty(r,e,{enumerable:!0,get:n[e]})},o:(t,r)=>Object.prototype.hasOwnProperty.call(t,r)};(()=>{"use strict";const r=flarum.core.compat["forum/app"];var n=t.n(r);const e=flarum.core.compat["common/extend"],i=flarum.core.compat["forum/components/DiscussionPage"];var o=t.n(i);const a=flarum.core.compat["forum/components/DiscussionListItem"];var u=t.n(a);const s=flarum.core.compat["forum/components/Post"];var c=t.n(s);function l(t){return t&&void 0!==t._threadDepth?{depth:t._threadDepth,threadPath:t._threadPath,isRoot:t._isRoot,childCount:t._childCount,descendantCount:t._descendantCount,rootPostId:t._rootPostId}:null}const d=flarum.core.compat["forum/components/ReplyComposer"];var f=t.n(d);const h=flarum.core.compat["forum/components/PostStream"];var p=t.n(h);function v(t){var r=[];function n(t,e){if(void 0===e&&(e=0),t){r.push(t);var i=t._threadChildren||[];i.sort(function(t,r){return(t.createdAt?t.createdAt().getTime():0)-(r.createdAt?r.createdAt().getTime():0)}),i.forEach(function(t){n(t,e+1)})}}return t.sort(function(t,r){return(t.createdAt?t.createdAt().getTime():0)-(r.createdAt?r.createdAt().getTime():0)}),t.forEach(function(t){n(t)}),r}var y=new Map;function g(){y.clear()}function b(t){return null==t?"":String(t)}function w(t,r){var n=new Map;return t.filter(Boolean).forEach(function(t){return n.set(b(t.id()),t)}),r.filter(Boolean).forEach(function(t){return n.set(b(t.id()),t)}),Array.from(n.values())}function S(t){var r=(t||[]).map(b).filter(Boolean);return 0===r.length?Promise.resolve([]):n().store.find("posts",{filter:{id:r.join(",")}})}function A(t,r){var n=(r||[]).filter(Boolean),e=new Set(n.map(function(t){return b(t.id())})),i=[];n.forEach(function(t){var r=b(null==t||null==t.attribute?void 0:t.attribute("parent_id"));r&&!e.has(r)&&i.push(r)});var o=Array.from(new Set(i));return 0===o.length?Promise.resolve(n):S(o).then(function(r){var e=w(n,r);return A(t,e)}).catch(function(t){return console.warn("[Threadify] Failed to load parent posts:",t),n})}function N(t,r){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(n)return(n=n.call(t)).next.bind(n);if(Array.isArray(t)||(n=function(t,r){if(t){if("string"==typeof t)return P(t,r);var n={}.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?P(t,r):void 0}}(t))||r&&t&&"number"==typeof t.length){n&&(t=n);var e=0;return function(){return e>=t.length?{done:!0}:{done:!1,value:t[e++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function P(t,r){(null==r||r>t.length)&&(r=t.length);for(var n=0,e=Array(r);n<r;n++)e[n]=t[n];return e}var I=new Map;function T(t){var r=String(t),e=I.get(r);if(!0===(null==e?void 0:e.ready))return Promise.resolve();if(null!=e&&e.ready&&"function"==typeof e.ready.then)return e.ready;var i={map:new Map,ready:null};return I.set(r,i),i.ready=n().request({method:"GET",url:n().forum.attribute("apiUrl")+"/discussions/"+encodeURIComponent(r)+"/threads-order"}).then(function(t){for(var n,e=new Map,o=N(Array.isArray(null==t?void 0:t.order)?t.order:[]);!(n=o()).done;){var a=n.value;if(a){var u=Number(a.postId),s=Number(a.order),c=Number(a.depth),l=null!=a.parentPostId?Number(a.parentPostId):null;Number.isNaN(u)||Number.isNaN(s)||e.set(u,{order:s,depth:Number.isNaN(c)?0:c,parentId:l})}}i.map=e,i.ready=!0;try{window.dispatchEvent(new CustomEvent("threadify:orderReady",{detail:Number(r)}))}catch(t){}try{setTimeout(function(){return m.redraw()},0)}catch(t){}}).catch(function(t){console.warn("[Threadify] order prefetch failed:",t),i.ready=!0}),i.ready}function _(t,r){var n=I.get(String(t));if(null!=n&&n.map){var e=n.map.get(Number(r));return e?e.order:void 0}}function E(t,r){var n=I.get(String(t));if(null!=n&&n.map){var e=n.map.get(Number(r));return e?e.parentId:void 0}}function M(t,r){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(n)return(n=n.call(t)).next.bind(n);if(Array.isArray(t)||(n=function(t,r){if(t){if("string"==typeof t)return C(t,r);var n={}.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?C(t,r):void 0}}(t))||r&&t&&"number"==typeof t.length){n&&(t=n);var e=0;return function(){return e>=t.length?{done:!0}:{done:!1,value:t[e++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function C(t,r){(null==r||r>t.length)&&(r=t.length);for(var n=0,e=Array(r);n<r;n++)e[n]=t[n];return e}var x=!1,j=null,B=0,R=null,O=null;function D(t){return!!t&&!!(t.loading||t.loadingPrevious||t.loadingNext||t.loadingNear||t._loadingPrevious||t._loadingNext)}function L(t){if(!x){x=!0;var r,e,i=function(t){j=t,x=!1,setTimeout(function(){try{m.redraw()}catch(t){}},0)};try{if(!R)return i(null);var o=R.call(t.stream)||[],a=o.filter(Boolean);if(0===a.length)return i(null);var u=t.stream.discussion&&t.stream.discussion.id&&t.stream.discussion.id(),s=function(){return(r=u,e=a,new Promise(function(t){if(!r||!Array.isArray(e)||0===e.length)return t(e);for(var i,o=new Set(e.map(function(t){return String(t.id&&t.id())})),a=new Set,u=M(e);!(i=u()).done;)for(var s=i.value,c=0,l=s&&s.id&&Number(s.id());l&&c<3;){var d=E(r,l);if(!d)break;o.has(String(d))||a.add(String(d)),l=d,c++}if(0===a.size)return t(e);n().store.find("posts",{filter:{id:Array.from(a).join(",")}}).then(function(r){for(var n,i=new Map(e.map(function(t){return[String(t.id&&t.id()),t]})),o=M(r||[]);!(n=o()).done;){var a=n.value,u=String(a.id&&a.id());i.has(u)||i.set(u,a)}t(Array.from(i.values()))}).catch(function(){return t(e)})})).then(function(t){return function(t,r){return new Promise(function(e){if(!t||!Array.isArray(r)||0===r.length)return e(r);var i=new Set(r.map(function(t){return String(t.id&&t.id())})),o=new Set(r.map(function(t){return t&&t.id&&Number(t.id())})),a=function(t,r,n,e,i){void 0===n&&(n=8),void 0===e&&(e="latest"),void 0===i&&(i=40);var o=I.get(String(t));if(null==o||!o.map||!r)return[];var a=new Set([].concat(r).map(function(t){return Number(t)}));if(0===a.size)return[];for(var u,s=new Map,c=N(o.map.entries());!(u=c()).done;){var l=u.value,d=l[0],f=l[1],h=null==f?void 0:f.parentId;if(h&&a.has(h)){var p=s.get(h);p||(p=[],s.set(h,p)),p.push({postId:Number(d),order:f.order||0})}}for(var m,v=[],y=N(s.entries());!(m=y()).done;){var g=m.value,b=(g[0],g[1]);b.sort(function(t,r){return t.order-r.order});for(var w,S=N("earliest"===e?b.slice(0,n):b.slice(-n));!(w=S()).done;){var A=w.value;v.push(A.postId)}if(v.length>=i)break}return Array.from(new Set(v)).slice(0,i)}(t,o,8,"latest",40),u=a.filter(function(t){return!i.has(String(t))});if(0===u.length)return e(r);n().store.find("posts",{filter:{id:u.join(",")}}).then(function(t){return e([].concat(r,t||[]))}).catch(function(){return e(r)})})}(u,t)}).then(function(r){var n=function(t,r){if(!t||!Array.isArray(r)||0===r.length)return null;if(!r.some(function(r){return null!=_(t,r.id&&r.id())}))return null;var n=r.slice();return n.sort(function(r,n){var e=r&&r.id&&r.id(),i=n&&n.id&&n.id(),o=_(t,e),a=_(t,i);if(null!=o||null!=a){if(null==o&&null==a)return 0;if(null==o)return 1;if(null==a)return-1;if(o!==a)return o-a}return 0}),n}(u,r);if(n&&n.length){var e=U(n,o.length);i(e)}else(function(t,r){return A(t.discussion?t:{discussion:t.stream.discussion},r).catch(function(){return k(r)})})(t,a).then(function(r){return function(t,r){return function(t,r){var n=function(t){var r;return(null==t?void 0:t.discussion)||(null==t||null==(r=t.stream)?void 0:r.discussion)||null}(t),e=(r||[]).filter(Boolean),i=new Set(e.map(function(t){return b(t.id())}));if(!n||"function"!=typeof n.postIds)return Promise.resolve(e);var o=(n.postIds()||[]).map(b).filter(function(t){return t&&!i.has(t)});if(0===o.length)return Promise.resolve(e);var a=Math.min(10,o.length);return S(o.slice(-a)).then(function(t){var r=(t||[]).filter(function(t){var r=b(null==t||null==t.attribute?void 0:t.attribute("parent_id"));return r&&i.has(r)});return 0===r.length?e:w(e,r)}).catch(function(t){return console.warn("[Threadify] Failed to load child posts:",t),e})}(t.discussion?t:{discussion:t.stream.discussion},r).catch(function(){return r})}(t,r)}).then(function(t){var r=U(function(t){var r=function(t){var r=[],n=new Map,e=new Map;return t.forEach(function(t){if(t){var r=t.id();n.set(r,t),e.set(r,[])}}),t.forEach(function(t){if(t){t.id();var i=t.attribute("parent_id");i&&n.has(String(i))?e.get(String(i)).push(t):r.push(t)}}),t.forEach(function(t){t&&(t._threadChildren=e.get(t.id())||[])}),r}(t);return v(r)}(t),o.length);i(r)}).catch(function(t){console.warn("[Threadify] prefetch & fallback threading both failed:",t),i(null)})});var r,e};u&&(r=u,!(e=I.get(String(r)))||!0!==e.ready)?T(u).finally(s):s()}catch(t){console.error("[Threadify] buildCacheWithPrefetch failed:",t),x=!1}}}function U(t,r){for(var n=Array.isArray(t)?t.slice():[],e=Math.max(0,r-n.length),i=0;i<e;i++)n.push(null);return n}function k(t){var r=new Map(t.filter(Boolean).map(function(t){return[String(t.id()),t]})),e=[];return t.forEach(function(t){var n=t&&t.attribute?t.attribute("parent_id"):null;n&&!r.has(String(n))&&e.push(String(n))}),0===e.length?Promise.resolve(t):n().store.find("posts",{filter:{id:e.join(",")}}).then(function(r){return k([].concat(t,r))}).catch(function(){return t})}n().initializers.add("syntaxoutlaw-threadify",function(){(0,e.extend)(c().prototype,"classes",function(t){var r=this.attrs.post;if(!r)return console.warn("[Threadify] No post in ThreadedPost.classes"),t;var n=function(t){var r=function(t){if(!t)return 0;var r=l(t);return r?Math.min(r.depth,10):t.attribute("parent_id")?1:0}(t),n=[];r>0?(n.push("threaded-post"),n.push("thread-depth-"+r),r>=3&&n.push("thread-deep"),r>=5&&n.push("thread-very-deep")):n.push("thread-root");var e=l(t);return e&&(e.isRoot&&n.push("thread-root-confirmed"),e.childCount>0&&(n.push("has-children"),n.push("child-count-"+Math.min(e.childCount,10))),e.descendantCount>0&&n.push("has-descendants")),n}(r);return console.log("[Threadify] Adding classes to post "+r.id()+": "+n.join(", ")),n.forEach(function(r){t.push(r)}),t}),(0,e.extend)(f().prototype,"data",function(t){var r=function(t){if(!t||"string"!=typeof t)return null;var r=t.match(/@"[^"]*"#p(\d+)/);if(r&&r[1]){var n=parseInt(r[1],10);if(!isNaN(n)&&n>0)return n}return null}(t.content);return r&&(t.parent_id=r,console.log("[Threadify] Reply threading to post",r)),t}),function(){var t=this;(0,e.extend)(p().prototype,"oninit",function(){var t=this,r=this.stream.discussion&&this.stream.discussion.id&&this.stream.discussion.id();O!==r&&(O=r,x=!1,j=null,B=0,R=null,g()),R||(R=this.stream.posts),r&&T(r),this.stream.posts=function(){if(j)return j;var r=R.call(t.stream)||[];return!x&&r.filter(Boolean).length>0&&L(t),r};var n=R.call(this.stream)||[];(B=n.filter(Boolean).length)>0&&L(this)}),(0,e.extend)(p().prototype,"onupdate",function(){var t=this;if(R){var r=(R.call(this.stream)||[]).filter(Boolean).length;r!==B&&(B=r,j=null,g(),D(this.stream)?setTimeout(function(){D(t.stream)||L(t)},60):L(this))}}),window.addEventListener("threadify:orderReady",function(r){var n=null==r?void 0:r.detail;n&&n===O&&setTimeout(function(){try{x||j||L(t)}catch(t){}},0)})}(),(0,e.extend)(o().prototype,"oninit",function(){var t=this.discussion&&this.discussion.id&&this.discussion.id();t&&T(t)}),(0,e.extend)(u().prototype,"oncreate",function(){var t=this.attrs.discussion;if(t){var r=t.id(),n=function(){return T(r)};this.element&&this.element.addEventListener("mouseenter",n,{once:!0}),this.element&&this.element.addEventListener("touchstart",n,{once:!0,passive:!0})}})})})(),module.exports={}})();
//# sourceMappingURL=forum.js.map