(()=>{var e={n:t=>{var n=t&&t.__esModule?()=>t.default:()=>t;return e.d(n,{a:n}),n},d:(t,n)=>{for(var r in n)e.o(n,r)&&!e.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:n[r]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};(()=>{"use strict";const t=flarum.core.compat["forum/app"];var n=e.n(t);const r=flarum.core.compat["common/extend"],i=flarum.core.compat["forum/components/DiscussionPage"];var o=e.n(i);const a=flarum.core.compat["forum/components/DiscussionListItem"];var u=e.n(a);const s=flarum.core.compat["forum/components/Post"];var l=e.n(s),d=new Map;function c(e){if(!e)return null;var t=e.discussion&&e.discussion(),n=t&&t.id&&t.id();if(!n)return null;var r=function(e,t){var n=d.get(Number(e));if(n)return n.map.get(Number(t))}(n,e.id());return r?{depth:r.depth,threadPath:null,isRoot:!r.parentId,childCount:0,descendantCount:0,rootPostId:null}:null}var f=new Map;function h(e,t){void 0===t&&(t={});var n=m(e);if(!n)return Promise.resolve();var r=Date.now(),i=f.get(n)||{map:new Map,inflight:null,ts:0};if(f.set(n,i),!t.force&&r-i.ts<1e4)return i.inflight||Promise.resolve();if(i.inflight&&!t.force)return i.inflight;var o=r;return i.inflight=app.request({method:"GET",url:app.forum.attribute("apiUrl")+"/discussions/"+n+"/threads-order?bust="+o}).then(function(e){var t=new Map;(e&&e.order?e.order:[]).forEach(function(e){var n=e.postId,r=e.order,i=e.depth,o=e.parentPostId;n=Number(n),t.set(n,{order:Number(r),depth:Number.isFinite(i)?Number(i):0,parentId:o?Number(o):null})}),i.map=t,i.ts=Date.now();try{window.dispatchEvent(new CustomEvent("threadify:order-ready",{detail:{discussionId:Number(n)}}))}catch(e){}}).catch(function(e){console.warn("[Threadify] order prefetch failed",e)}).finally(function(){i.inflight=null}),i.inflight}function p(e){var t=m(e);if(t){var n=f.get(t);return n?n.map:void 0}}function m(e){if(null==e)return null;var t=Number(e);return Number.isFinite(t)&&t>0?String(t):null}function v(e){var t=Number(e);return Number.isFinite(t)?Math.max(0,Math.min(10,t)):0}function y(e){var t,n,r,i,o=function(e){if(!e||"function"!=typeof e.id)return 0;try{var t=e.discussion&&"function"==typeof e.discussion&&e.discussion()&&e.discussion().id&&e.discussion().id()||null;if(null!=t){var n=(r=t,i=e.id(),(a=(o=p(r))&&o.get(Number(i)))?a.depth:void 0);if(Number.isInteger(n))return v(n)}}catch(e){}var r,i,o,a;try{var u=c(e);if(u&&Number.isInteger(u.depth))return v(u.depth)}catch(e){}return function(e){for(var t=0,n=0,r=new Set,i=e;i&&n<100;){var o=i.attribute?i.attribute("parent_id"):null;if(!o)break;if(r.has(o)){console.warn("[Threadify] cycle detected while walking parents of",e&&e.id&&e.id()),t=0;break}r.add(o),t+=1;var a=app.store.getById("posts",String(o));if(!a)break;if(i=a,n++,t>=10)break}return v(t)}(e)}(e),a=[];o>0?(a.push("threaded-post"),a.push("thread-depth-"+o),o>=3&&a.push("thread-deep"),o>=5&&a.push("thread-very-deep")):a.push("thread-root");try{var u=e.discussion&&"function"==typeof e.discussion&&e.discussion()&&e.discussion().id&&e.discussion().id()||null,s=null!=u?(t=u,n=e.id(),(i=(r=p(t))&&r.get(Number(n)))?i.parentId:void 0):void 0,l=c(e);(null==s?!e.attribute||!e.attribute("parent_id"):null==s)&&a.push("thread-root-confirmed"),l&&Number.isInteger(l.childCount)&&l.childCount>0&&a.push("has-children","child-count-"+Math.min(l.childCount,10)),l&&Number.isInteger(l.descendantCount)&&l.descendantCount>0&&a.push("has-descendants")}catch(e){}return a}const g=flarum.core.compat["forum/components/ReplyComposer"];var b=e.n(g);const w=flarum.core.compat["forum/components/PostStream"];var N=e.n(w);function I(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(n)return(n=n.call(e)).next.bind(n);if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return S(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?S(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0;return function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function S(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}var _=1e7;function O(e){try{var t,n;return null!=(t=null==e||null==(n=e.stream)||null==(n=n.discussion)||null==n.id?void 0:n.id())?t:null}catch(e){return null}}function M(e){var t,n;return null!=e&&null!=(t=e.element)&&null!=(t=t.classList)&&t.contains("PostStream")?e.element:(null==e||null==(n=e.element)||null==n.querySelector?void 0:n.querySelector(".PostStream"))||document.querySelector(".PostStream")||null}function P(e){return e&&1===e.nodeType&&e.matches(".PostStream-item[data-id]")}function x(e){var t=Array.from((null==e?void 0:e.children)||[]);if(!t.length)return{posts:[],anchor:null};var n=t.findIndex(P);if(n<0)return{posts:[],anchor:t[0]||null};var r=t.length-1-[].concat(t).reverse().findIndex(P);return r<n&&(r=n),{posts:t.slice(n,r+1).filter(P),anchor:t[r+1]||null}}function T(e){try{return n().store.getById("posts",String(e))}catch(e){return null}}function C(e){try{var t=e&&"function"==typeof e.number?e.number():null;return Number.isFinite(t)?t:null}catch(e){return null}}function A(e){return!Number.isFinite(C(e))}function F(e,t,n){if(e&&Number.isFinite(e.order))return Number(e.order);var r=C(t);if(null!=r)return r;var i=function(e){try{var t=e&&"function"==typeof e.createdAt?e.createdAt():null;return t instanceof Date?t.getTime():null}catch(e){return null}}(t);return null!=i?_/2+i:_+Number(n)}function D(e,t){return function(e){var t=m(e);if(!t)return Promise.resolve(new Map);var n=Date.now(),r=f.get(t)||{map:new Map,inflight:null,ts:0};return f.set(t,r),n-r.ts<1e4&&r.map&&r.map.size>=0?Promise.resolve(r.map):(r.inflight||h(t)).then(function(){return p(t)||new Map})}(t).then(function(t){var n=x(e).posts;if(n.length){var r=function(e,t,n){for(var r,i=new Set(t.map(function(e){return Number(e.dataset.id)})),o=new Map(t.map(function(e){return[Number(e.dataset.id),T(Number(e.dataset.id))]})),a=new Map,u=I(t);!(r=u()).done;){var s=r.value,l=Number(s.dataset.id),d=n.get(l),c=o.get(l),f=d?d.parentId:null!=c&&c.attribute?c.attribute("parent_id"):null;a.set(l,null==f?null:Number(f))}for(var h,p=new Set,m=I(t);!(h=m()).done;){var v=h.value,y=Number(v.dataset.id),g=o.get(y);(null==a.get(y)||A(g))&&p.add(y)}for(var b=!0;b;){b=!1;for(var w,N=I(t);!(w=N()).done;){var S=w.value,_=Number(S.dataset.id);if(!p.has(_)){var O=a.get(_);null!=O&&i.has(O)&&p.has(O)&&(p.add(_),b=!0)}}}return{eligible:p,models:o}}(0,n,t||new Map),i=r.eligible,o=r.models,a=function(e,t,n,r){for(var i,o=e.filter(function(e){return t.has(Number(e.dataset.id))}),a=o.slice().sort(function(e,t){var i=Number(e.dataset.id),o=Number(t.dataset.id),a=F(n.get(i),r.get(i),i),u=F(n.get(o),r.get(o),o);return a===u?i-o:a-u}),u=[],s=0,l=I(e);!(i=l()).done;){var d=i.value,c=Number(d.dataset.id);u.push(t.has(c)?a[s++]:d)}return u}(n,i,t||new Map,o);if(!function(e,t){if(e.length!==t.length)return!1;for(var n=0;n<e.length;n++)if(e[n]!==t[n])return!1;return!0}(n,a)){var u=x(e),s=u.anchor&&u.anchor.parentNode===e?u.anchor:null;try{for(var l,d=I(a);!(l=d()).done;){var c=l.value;s&&s.parentNode===e?e.insertBefore(c,s):e.appendChild(c)}}catch(e){console.warn("[Threadify] reorder failed (retry next tick)",e)}}}}).catch(function(e){console.warn("[Threadify] order map unavailable",e)})}!function(){var e="threadify:logs",t=["log","info","warn","debug","error"];window.__threadifyConsoleOriginal||(window.__threadifyConsoleOriginal={},t.forEach(function(e){window.__threadifyConsoleOriginal[e]=console[e]?console[e].bind(console):function(){}}));var n="1"===("undefined"!=typeof localStorage?localStorage.getItem(e):null);function r(t){n=!!t,"undefined"!=typeof localStorage&&localStorage.setItem(e,n?"1":"0")}window.threadifyLogs={enable:function(){return r(!0),"Threadify logs: ON"},disable:function(){return r(!1),"Threadify logs: OFF"},toggle:function(){return r(!n),"Threadify logs: "+(n?"ON":"OFF")},status:function(){return n}},t.forEach(function(e){var t=window.__threadifyConsoleOriginal[e];console[e]=function(){for(var e=arguments.length,r=new Array(e),i=0;i<e;i++)r[i]=arguments[i];var o=r&&r[0];if("string"!=typeof o||0!==o.indexOf("[Threadify]")||n)return t.apply(void 0,r)}})}(),n().initializers.add("syntaxoutlaw-threadify",function(){(0,r.extend)(b().prototype,"data",function(e){var t=function(e){if(!e||"string"!=typeof e)return null;var t=e.match(/@"[^"]*"#p(\d+)/);if(t&&t[1]){var n=parseInt(t[1],10);if(!isNaN(n)&&n>0)return n}return null}(e.content);return t&&(e.parent_id=t,console.log("[Threadify] Reply threading to post",t)),e}),(0,r.extend)(l().prototype,"classes",function(e){var t=this.attrs.post;if(!t)return console.warn("[Threadify] No post in ThreadedPost.classes"),e;var n=y(t);return console.log("[Threadify] Adding classes to post "+t.id()+": "+n.join(", ")),n.forEach(function(t){e.push(t)}),e}),(0,r.extend)(N().prototype,"oncreate",function(){var e=O(this),t=M(this);if(e&&t){D(t,e);var n=!1,r=new MutationObserver(function(r){r.some(function(e){return"childList"===e.type})&&(n||(n=!0,requestAnimationFrame(function(){n=!1,D(t,e)})))});r.observe(t,{childList:!0}),this.__threadifyDomObserver=r}}),(0,r.extend)(N().prototype,"onupdate",function(){var e=O(this),t=M(this);e&&t&&D(t,e)}),(0,r.extend)(N().prototype,"onremove",function(){if(this.__threadifyDomObserver){try{this.__threadifyDomObserver.disconnect()}catch(e){}this.__threadifyDomObserver=null}}),(0,r.extend)(o().prototype,"oninit",function(){var e=this.discussion&&"function"==typeof this.discussion.id&&this.discussion.id()||this.discussion&&this.discussion.id||null;e&&h(e)}),(0,r.extend)(u().prototype,"oncreate",function(){var e=this.attrs.discussion;if(e){var t=e.id(),n=function(){return h(t)};this.element&&(this.element.addEventListener("mouseenter",n,{once:!0}),this.element.addEventListener("touchstart",n,{once:!0,passive:!0}))}})})})(),module.exports={}})();
//# sourceMappingURL=forum.js.map