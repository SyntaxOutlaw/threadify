(()=>{var e={n:t=>{var r=t&&t.__esModule?()=>t.default:()=>t;return e.d(r,{a:r}),r},d:(t,r)=>{for(var n in r)e.o(r,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:r[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};(()=>{"use strict";const t=flarum.core.compat["forum/app"];var r=e.n(t);const n=flarum.core.compat["common/extend"],o=flarum.core.compat["forum/components/DiscussionPage"];var i=e.n(o);const a=flarum.core.compat["forum/components/DiscussionListItem"];var u=e.n(a);const s=flarum.core.compat["forum/components/Post"];var d=e.n(s),c=new Map;function l(e){if(!e)return null;var t=e.discussion&&e.discussion(),r=t&&t.id&&t.id();if(!r)return null;var n=function(e,t){var r=c.get(Number(e));if(r)return r.map.get(Number(t))}(r,e.id());return n?{depth:n.depth,threadPath:null,isRoot:!n.parentId,childCount:0,descendantCount:0,rootPostId:null}:null}var f=new Map;function h(e,t){void 0===t&&(t={});var r=m(e);if(!r)return Promise.resolve();var n=Date.now(),o=f.get(r)||{map:new Map,inflight:null,ts:0};if(f.set(r,o),!t.force&&n-o.ts<1e4)return o.inflight||Promise.resolve();if(o.inflight&&!t.force)return o.inflight;var i=n;return o.inflight=app.request({method:"GET",url:app.forum.attribute("apiUrl")+"/discussions/"+r+"/threads-order?bust="+i}).then(function(e){var t=new Map;(e&&e.order?e.order:[]).forEach(function(e){var r=e.postId,n=e.order,o=e.depth,i=e.parentPostId;r=Number(r),t.set(r,{order:Number(n),depth:Number.isFinite(o)?Number(o):0,parentId:i?Number(i):null})}),o.map=t,o.ts=Date.now();try{window.dispatchEvent(new CustomEvent("threadify:order-ready",{detail:{discussionId:Number(r)}}))}catch(e){}}).catch(function(e){console.warn("[Threadify] order prefetch failed",e)}).finally(function(){o.inflight=null}),o.inflight}function p(e){var t=m(e);if(t){var r=f.get(t);return r?r.map:void 0}}function m(e){if(null==e)return null;var t=Number(e);return Number.isFinite(t)&&t>0?String(t):null}function v(e){var t=Number(e);return Number.isFinite(t)?Math.max(0,Math.min(10,t)):0}function y(e){var t,r,n,o,i=function(e){if(!e||"function"!=typeof e.id)return 0;try{var t=e.discussion&&"function"==typeof e.discussion&&e.discussion()&&e.discussion().id&&e.discussion().id()||null;if(null!=t){var r=(n=t,o=e.id(),(a=(i=p(n))&&i.get(Number(o)))?a.depth:void 0);if(Number.isInteger(r))return v(r)}}catch(e){}var n,o,i,a;try{var u=l(e);if(u&&Number.isInteger(u.depth))return v(u.depth)}catch(e){}return function(e){for(var t=0,r=0,n=new Set,o=e;o&&r<100;){var i=o.attribute?o.attribute("parent_id"):null;if(!i)break;if(n.has(i)){console.warn("[Threadify] cycle detected while walking parents of",e&&e.id&&e.id()),t=0;break}n.add(i),t+=1;var a=app.store.getById("posts",String(i));if(!a)break;if(o=a,r++,t>=10)break}return v(t)}(e)}(e),a=[];i>0?(a.push("threaded-post"),a.push("thread-depth-"+i),i>=3&&a.push("thread-deep"),i>=5&&a.push("thread-very-deep")):a.push("thread-root");try{var u=e.discussion&&"function"==typeof e.discussion&&e.discussion()&&e.discussion().id&&e.discussion().id()||null,s=null!=u?(t=u,r=e.id(),(o=(n=p(t))&&n.get(Number(r)))?o.parentId:void 0):void 0,d=l(e);(null==s?!e.attribute||!e.attribute("parent_id"):null==s)&&a.push("thread-root-confirmed"),d&&Number.isInteger(d.childCount)&&d.childCount>0&&a.push("has-children","child-count-"+Math.min(d.childCount,10)),d&&Number.isInteger(d.descendantCount)&&d.descendantCount>0&&a.push("has-descendants")}catch(e){}return a}const g=flarum.core.compat["forum/components/ReplyComposer"];var b=e.n(g);const w=flarum.core.compat["forum/components/PostStream"];var N=e.n(w);function I(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}var _=1e7;function O(e){try{var t,r;return null!=(t=null==e||null==(r=e.stream)||null==(r=r.discussion)||null==r.id?void 0:r.id())?t:null}catch(e){return null}}function S(e){var t;return(null==e||null==(t=e.element)||null==t.querySelector?void 0:t.querySelector(".PostStream"))||null}function x(e){return e&&e.matches&&e.matches(".PostStream-item[data-id]")}var P=new Map;function C(e){var t=String(e),r=P.get(t);if(null!=r&&r.map)return Promise.resolve(r.map);if(null!=r&&r.promise)return r.promise.then(function(e){return e.map});var n={promise:null,map:null};return P.set(t,n),n.promise=app.request({method:"GET",url:app.forum.attribute("apiUrl")+"/discussions/"+e+"/threads-order"}).then(function(e){var t=new Map;return(e.order||[]).forEach(function(e){var r=e.postId,n=e.order,o=e.depth,i=e.parentPostId;t.set(Number(r),{order:Number(n),depth:Number.isFinite(o)?Number(o):0,parentId:i?Number(i):null})}),n.map=t,n}).catch(function(e){return console.warn("[Threadify] threads-order fetch failed",e),n.map=new Map,n}),n.promise.then(function(e){return e.map})}function T(e,t){var r=function(e){return Array.from(e.children||[])}(e);if(r.length){var n=r.findIndex(x),o=r.length-1-[].concat(r).reverse().findIndex(x);if(!(-1===n||-1===o||n>o)){var i=r.slice(n,o+1).filter(x);if(i.length){for(var a=i.slice().sort(function(e,r){var n=Number(e.dataset.id),o=Number(r.dataset.id),i=t.get(n),a=t.get(o),u=i?i.order:_+n,s=a?a.order:_+o;return u===s?n-o:u-s}),u=!0,s=0;s<i.length;s++)if(i[s]!==a[s]){u=!1;break}if(!u)for(var d,c=r[o+1]||null,l=function(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(r)return(r=r.call(e)).next.bind(r);if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return I(e,t);var r={}.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?I(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0;return function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(a);!(d=l()).done;){var f=d.value;e.insertBefore(f,c)}}}}}!function(){var e="threadify:logs",t=["log","info","warn","debug","error"];window.__threadifyConsoleOriginal||(window.__threadifyConsoleOriginal={},t.forEach(function(e){window.__threadifyConsoleOriginal[e]=console[e]?console[e].bind(console):function(){}}));var r="1"===("undefined"!=typeof localStorage?localStorage.getItem(e):null);function n(t){r=!!t,"undefined"!=typeof localStorage&&localStorage.setItem(e,r?"1":"0")}window.threadifyLogs={enable:function(){return n(!0),"Threadify logs: ON"},disable:function(){return n(!1),"Threadify logs: OFF"},toggle:function(){return n(!r),"Threadify logs: "+(r?"ON":"OFF")},status:function(){return r}},t.forEach(function(e){var t=window.__threadifyConsoleOriginal[e];console[e]=function(){for(var e=arguments.length,n=new Array(e),o=0;o<e;o++)n[o]=arguments[o];var i=n&&n[0];if("string"!=typeof i||0!==i.indexOf("[Threadify]")||r)return t.apply(void 0,n)}})}(),r().initializers.add("syntaxoutlaw-threadify",function(){(0,n.extend)(b().prototype,"data",function(e){var t=function(e){if(!e||"string"!=typeof e)return null;var t=e.match(/@"[^"]*"#p(\d+)/);if(t&&t[1]){var r=parseInt(t[1],10);if(!isNaN(r)&&r>0)return r}return null}(e.content);return t&&(e.parent_id=t,console.log("[Threadify] Reply threading to post",t)),e}),(0,n.extend)(d().prototype,"classes",function(e){var t=this.attrs.post;if(!t)return console.warn("[Threadify] No post in ThreadedPost.classes"),e;var r=y(t);return console.log("[Threadify] Adding classes to post "+t.id()+": "+r.join(", ")),r.forEach(function(t){e.push(t)}),e}),(0,n.extend)(N().prototype,"oncreate",function(){var e=O(this),t=S(this);if(e&&t){C(e).then(function(e){T(t,e)});var r=!1,n=new MutationObserver(function(n){n.some(function(e){return"childList"===e.type})&&(r||(r=!0,requestAnimationFrame(function(){r=!1,C(e).then(function(e){return T(t,e)})})))});n.observe(t,{childList:!0}),this.__threadifyDomObserver=n}}),(0,n.extend)(N().prototype,"onupdate",function(){var e=O(this),t=S(this);e&&t&&C(e).then(function(e){return T(t,e)})}),(0,n.extend)(N().prototype,"onremove",function(){if(this.__threadifyDomObserver){try{this.__threadifyDomObserver.disconnect()}catch(e){}this.__threadifyDomObserver=null}}),(0,n.extend)(i().prototype,"oninit",function(){var e=this.discussion&&"function"==typeof this.discussion.id&&this.discussion.id()||this.discussion&&this.discussion.id||null;e&&h(e)}),(0,n.extend)(u().prototype,"oncreate",function(){var e=this.attrs.discussion;if(e){var t=e.id(),r=function(){return h(t)};this.element&&(this.element.addEventListener("mouseenter",r,{once:!0}),this.element.addEventListener("touchstart",r,{once:!0,passive:!0}))}})})})(),module.exports={}})();
//# sourceMappingURL=forum.js.map